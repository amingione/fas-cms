---
import BaseLayout from '../../layouts/BaseLayout.astro';
const title = 'Reset Vendor Password';
const token = Astro.url.searchParams.get('token') ?? '';
const email = Astro.url.searchParams.get('email') ?? '';
const invalid = !token || !email;
---

<BaseLayout title={title}>
  <div
    class="min-h-screen flex items-center justify-center px-4"
    style="background-image: url('/images/backgrounds/bg-asphalt-overlay.webp')"
  >
    <div class="bg-black/80 border border-white rounded-lg max-w-md w-full p-6 text-white">
      <h1 class="text-3xl font-bold font-orbitron text-red-600 mb-4 uppercase text-center">Set new password</h1>
      {invalid ? (
        <p class="text-center text-sm text-red-400">
          This password reset link is invalid. Request a new link from the&nbsp;<a class="text-yellow-300 hover:underline" href="/vendor/forgot-password">forgot password</a> page.
        </p>
      ) : (
        <>
          <p class="text-sm text-gray-300 mb-6 text-center">Create a new password for <strong>{email}</strong>.</p>
          <form id="vendorResetForm" class="space-y-4">
            <input type="hidden" id="vendorResetToken" value={token} />
            <input type="hidden" id="vendorResetEmail" value={email} />
            <div>
              <label class="block text-sm font-semibold mb-2" for="vendorResetPassword">New password</label>
              <input
                id="vendorResetPassword"
                name="password"
                type="password"
                minlength="8"
                required
                placeholder="••••••••"
                class="w-full p-2 bg-gray-800 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-red-600"
              />
            </div>
            <div>
              <label class="block text-sm font-semibold mb-2" for="vendorResetConfirm">Confirm password</label>
              <input
                id="vendorResetConfirm"
                name="confirm"
                type="password"
                minlength="8"
                required
                placeholder="••••••••"
                class="w-full p-2 bg-gray-800 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-red-600"
              />
            </div>
            <button
              type="submit"
              class="w-full bg-red-600 text-white p-2 rounded-lg font-bold uppercase tracking-wide hover:bg-red-700 transition-colors duration-200"
            >
              Update password
            </button>
            <p id="vendorResetStatus" class="text-sm text-center hidden"></p>
          </form>
          <p class="text-center text-sm text-gray-300 mt-6">
            <a href="/vendor/login" class="text-yellow-300 hover:underline">Back to login</a>
          </p>
        </>
      )}
    </div>
  </div>

  {!invalid && (
    <script>
      const form = document.querySelector('#vendorResetForm');
      const statusEl = document.querySelector('#vendorResetStatus');

      form?.addEventListener('submit', async (event) => {
        event.preventDefault();
        if (!statusEl) return;

        statusEl.classList.add('hidden');
        statusEl.classList.remove('text-green-400', 'text-red-500');

        const passwordInput = document.querySelector('#vendorResetPassword') as HTMLInputElement | null;
        const confirmInput = document.querySelector('#vendorResetConfirm') as HTMLInputElement | null;
        const tokenInput = document.querySelector('#vendorResetToken') as HTMLInputElement | null;
        const emailInput = document.querySelector('#vendorResetEmail') as HTMLInputElement | null;
        if (!passwordInput || !confirmInput || !tokenInput || !emailInput) return;

        const password = passwordInput.value;
        const confirm = confirmInput.value;
        if (password !== confirm) {
          statusEl.textContent = 'Passwords do not match. Please try again.';
          statusEl.classList.add('text-red-500');
          statusEl.classList.remove('hidden');
          return;
        }

        try {
          const res = await fetch('/api/vendor/password-reset/confirm', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              token: tokenInput.value,
              email: emailInput.value,
              password
            })
          });
          const data = await res.json().catch(() => ({}));
          if (res.ok) {
            statusEl.textContent = data.message || 'Password updated successfully. You can now log in with your new password.';
            statusEl.classList.add('text-green-400');
          } else {
            statusEl.textContent = data.message || 'Unable to reset password. The link may have expired.';
            statusEl.classList.add('text-red-500');
          }
        } catch (err) {
          console.error('Password reset failed', err);
          statusEl.textContent = 'Network error. Please try again.';
          statusEl.classList.add('text-red-500');
        } finally {
          statusEl.classList.remove('hidden');
        }
      });
    </script>
  )}
</BaseLayout>
