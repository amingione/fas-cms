---
// filepath: /Users/ambermin/Documents/Workspace/DevProjects/GitHub/fas-cms/src/pages/shop/[slug].astro
import BaseLayout from '../../layouts/BaseLayout.astro';

const { slug } = Astro.params;

// Fetch the product details based on the slug
const query = `*[_type == "wooProduct" && slug.current == "${slug}"][0] {
  _id,
  name,
  price,
  horsepower,
  tune_required,
  images[]{ asset->{ url } },
  description
}`;

const response = await fetch(`https://${import.meta.env.SANITY_PROJECT_ID}.api.sanity.io/v1/data/query/production?query=${encodeURIComponent(query)}`, {
  headers: {
    Authorization: `Bearer ${import.meta.env.SANITY_API_TOKEN}`
  }
});

const product = (await response.json()).result;

if (!product) {
  throw new Error(`Product with slug "${slug}" not found.`);
}
---

<div id="toast" class="fixed bottom-6 right-6 z-50 hidden px-4 py-3 rounded-lg bg-white/90 text-black shadow-lg font-semibold transition-all duration-300 opacity-0"></div>

<script>
  function showToast(message) {
    const toast = document.getElementById('toast');
    if (!toast) return;
    toast.textContent = message;
    toast.classList.remove('hidden', 'opacity-0');
    toast.classList.add('opacity-100');
    setTimeout(() => {
      toast.classList.remove('opacity-100');
      toast.classList.add('opacity-0');
      setTimeout(() => {
        toast.classList.add('hidden');
      }, 300);
    }, 2500);
  }

  document.addEventListener('DOMContentLoaded', () => {
    const addToCartBtn = document.getElementById('add-to-cart');
    const productDataScript = document.getElementById('product-data');
    const product = productDataScript?.textContent ? JSON.parse(productDataScript.textContent) : null;

    if (addToCartBtn && product) {
      addToCartBtn.addEventListener('click', () => {
        fetch('/api/cart', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            productId: product._id,
            quantity: 1,
            sessionId: window.localStorage.getItem('fas_session') || 'guest-session'
          })
        }).then(res => {
          if (res.ok) showToast('✅ Added to cart!');
          else showToast('❌ Failed to add to cart.');
        });
      });
    }
  });
</script>

<script type="application/json" id="product-data">
  {JSON.stringify(product)}
</script>

<BaseLayout>
  <section class="py-12 max-w-6xl mx-auto px-4">
    <nav class="text-sm text-gray-400 mb-6">
      <a href="/" class="hover:text-white">Home</a> / 
      <a href="/shop" class="hover:text-white">Shop</a> / 
      <span class="text-white font-medium">{product.name}</span>
    </nav>

    <div class="grid md:grid-cols-2 gap-10 items-start">
      <img src={product.images?.[0]?.asset?.url || '/images/placeholder.png'} alt={product.name} class="rounded-lg w-full object-cover shadow-lg" />

      <div>
        <h1 class="text-4xl font-bold text-white mb-4">{product.name}</h1>
        <p class="text-2xl text-accent font-bold mb-4">${product.price}</p>
        <p class="text-white/80 mb-6">{product.description || 'No description available.'}</p>

        <ul class="text-white/60 mb-6 space-y-1 text-sm">
          <li><strong>Horsepower:</strong> {product.horsepower || 'N/A'}</li>
          <li><strong>Tune Required:</strong> {product.tune_required || 'Unknown'}</li>
        </ul>

        <div class="flex space-x-4 overflow-x-auto mb-6">
          {product.images?.map((img, i) => (
            <img src={img.asset?.url} alt={`Image ${i + 1}`} class="h-24 w-24 rounded object-cover border border-white/10" />
          ))}
        </div>

        <button
          id="add-to-cart"
          class="bg-accent text-black px-6 py-3 rounded font-bold hover:bg-red-600 transition"
        >
          Add to Cart
        </button>
      </div>
    </div>
  </section>

  <section class="mt-20">
    <h2 class="text-2xl font-semibold text-white mb-6">Related Products</h2>
    <div class="grid md:grid-cols-3 gap-6">
      <div class="bg-white/5 rounded-lg p-4 text-white text-center opacity-50">Coming Soon</div>
      <div class="bg-white/5 rounded-lg p-4 text-white text-center opacity-50">Coming Soon</div>
      <div class="bg-white/5 rounded-lg p-4 text-white text-center opacity-50">Coming Soon</div>
    </div>
  </section>
</BaseLayout>
