---
import '../styles/global.css';
import Header from '../components/header/header2.astro';
import Footer from '@/components/footer.astro';
import Footer2 from '@/components/footer/footer2';
import SitewideProductServiceLinks from '@/components/SitewideProductServiceLinks.astro';
import CookieBanner from '@/components/notices/cookieBanner';
import Breadcrumbs from '@/components/storefront/Breadcrumbs.astro';
import InternalLinks from '@/components/navigation/InternalLinks.astro';
import { Toaster } from 'sonner';
import { buildJsonLd, buildMetaEntries, fetchSeoForPath } from '@/lib/seoData';
import { buildDefaultJsonLdGraph } from '@/lib/structuredDataDefaults';
import analyticsTrackingScriptUrl from '../scripts/analytics-tracking.js?url';
import DesktopAddToCartToast from '@/components/cart/DesktopAddToCartToast.tsx';
import MobileAddToCartToast from '@/components/cart/MobileAddToCartToast.tsx';

// SEO props (optional per-page)
const {
  title,
  description,
  canonical,
  noindex: rawNoindex = false,
  ogImage,
  hideBreadcrumbs = false,
  breadcrumbs,
  keywords,
  breadcrumbContext
} = Astro.props as {
  title?: string;
  description?: string;
  canonical?: string;
  noindex?: boolean | string | number;
  ogImage?: string;
  hideBreadcrumbs?: boolean;
  breadcrumbs?: Array<{ href?: string; label: string }>;
  keywords?: string | string[];
  breadcrumbContext?: {
    dieselHref?: string;
    dieselLabel?: string;
    platformHref?: string;
    platformLabel?: string;
    currentLabel?: string;
  };
};

const normalizeNoindex = (value: unknown): boolean => {
  if (typeof value === 'boolean') return value;
  if (typeof value === 'number') return value !== 0;
  if (typeof value === 'string') {
    const normalized = value.trim().toLowerCase();
    if (!normalized) return false;
    if (['true', '1', 'yes', 'on'].includes(normalized)) return true;
    if (['false', '0', 'no', 'off'].includes(normalized)) return false;
    return false;
  }
  return false;
};

const parseBooleanFlag = (value: unknown): boolean => {
  if (typeof value === 'boolean') return value;
  if (typeof value === 'number') return value !== 0;
  if (typeof value === 'string') {
    const normalized = value.trim().toLowerCase();
    if (!normalized) return false;
    if (['true', '1', 'yes', 'on', 'enabled'].includes(normalized)) return true;
    if (['false', '0', 'no', 'off', 'disabled'].includes(normalized)) return false;
  }
  return false;
};

const getUrlBooleanFlag = (url: URL | null, keys: string[]): boolean => {
  if (!url) return false;
  for (const key of keys) {
    const value = url.searchParams.get(key);
    if (value !== null) {
      return parseBooleanFlag(value);
    }
  }
  return false;
};

let currentUrl: URL | null = null;
try {
  currentUrl = new URL(Astro.request.url);
} catch {
  currentUrl = null;
}

const resolveCanonical = (value?: string | null) => {
  if (!value) return undefined;
  try {
    if (/^https?:\/\//i.test(value)) {
      return new URL(value).toString();
    }
    if (currentUrl) {
      return new URL(value, currentUrl).toString();
    }
  } catch {
    return undefined;
  }
  return undefined;
};

const previewEnvEnabled = parseBooleanFlag(
  (import.meta.env.PUBLIC_SANITY_PREVIEW_DRAFTS as string | undefined) ?? 'true'
);
const previewCookieRequested = parseBooleanFlag(Astro.cookies.get('sanity-preview')?.value ?? '');
const previewQueryRequested = getUrlBooleanFlag(currentUrl, ['sanity-preview', 'preview']);
const previewDraftsEnabled = previewEnvEnabled || previewCookieRequested || previewQueryRequested;

const previewToken =
  (import.meta.env.SANITY_API_READ_TOKEN as string | undefined) ||
  (import.meta.env.SANITY_API_TOKEN as string | undefined) ||
  (import.meta.env.SANITY_WRITE_TOKEN as string | undefined) ||
  undefined;

const seoPayload = await fetchSeoForPath(Astro.url?.pathname ?? '/', {
  preview: previewDraftsEnabled,
  token: previewToken
});

const canonicalFromSanity = seoPayload.page?.canonicalUrl;

const cmsNoindex = Boolean(seoPayload.page?.noindex);
const noindex = normalizeNoindex(rawNoindex) || cmsNoindex;

const FALLBACK_KEYWORDS = [
  'F.A.S. Motorsports',
  'performance parts',
  'supercharger upgrades',
  'billet parts',
  'custom fabrication',
  'Fort Myers auto shop',
  'Hellcat performance',
  'Trackhawk upgrades',
  'TRX packages'
];

const SITE_NAME = seoPayload.global.siteName ?? 'F.A.S. Motorsports';
const SITE_AUTHOR = seoPayload.global.siteName ?? 'F.A.S. Motorsports';
const DEFAULT_DESCRIPTION =
  seoPayload.global.defaultDescription ??
  'F.A.S. Motorsports delivers premium performance parts, custom fabrication, installs, and wheel packages in Fort Myers, Florida.';
const DEFAULT_KEYWORDS =
  seoPayload.global.defaultKeywords && seoPayload.global.defaultKeywords.length
    ? seoPayload.global.defaultKeywords
    : FALLBACK_KEYWORDS;
const DEFAULT_OG_IMAGE =
  (typeof seoPayload.global.defaultOgImage === 'string'
    ? seoPayload.global.defaultOgImage
    : seoPayload.global.defaultOgImage?.asset?.url) ??
  'https://fasmotorsports.com/images/social/social-share.webp';

declare global {
  interface Window {
    dataLayer: any[];
    gtag?: (...args: any[]) => void;
  }
}

let canonicalUrl = resolveCanonical(canonical) ?? resolveCanonical(canonicalFromSanity);
try {
  if (!canonicalUrl) {
    const url = new URL(Astro.request.url);
    url.search = '';
    url.hash = '';
    canonicalUrl = url.toString();
  }
} catch {
  canonicalUrl =
    resolveCanonical(canonical) ?? resolveCanonical(canonicalFromSanity) ?? canonical ?? undefined;
}

const siteUrl = (() => {
  if (canonicalUrl) {
    try {
      const parsed = new URL(canonicalUrl);
      parsed.pathname = '/';
      parsed.search = '';
      parsed.hash = '';
      return parsed.toString();
    } catch {
      /* noop */
    }
  }
  if (currentUrl) {
    try {
      const parsed = new URL(currentUrl.toString());
      parsed.pathname = '/';
      parsed.search = '';
      parsed.hash = '';
      return parsed.toString();
    } catch {
      /* noop */
    }
  }
  return 'https://www.fasmotorsports.com/';
})();

const cmsTitle = seoPayload.page?.title;
const cmsDescription = seoPayload.page?.description;
const cmsKeywords = Array.isArray(seoPayload.page?.keywords)
  ? (seoPayload.page?.keywords as string[])
  : [];
const cmsOgImage =
  typeof seoPayload.page?.ogImage === 'string'
    ? (seoPayload.page?.ogImage as string)
    : seoPayload.page?.ogImage?.asset?.url;
const cmsBreadcrumbs = Array.isArray(seoPayload.page?.breadcrumbs)
  ? (seoPayload.page?.breadcrumbs as Array<{ href?: string; label: string }>)
  : [];
const cmsRelatedLinks = Array.isArray(seoPayload.page?.relatedLinks)
  ? (seoPayload.page?.relatedLinks as Array<{ href?: string; label: string }>)
  : [];

const resolvedDescription =
  typeof description === 'string' && description.trim().length > 0
    ? description.trim()
    : typeof cmsDescription === 'string' && cmsDescription.trim().length > 0
      ? cmsDescription.trim()
      : DEFAULT_DESCRIPTION;

const normalizeKeywords = (value: string | string[] | undefined) => {
  if (!value) return [];
  if (Array.isArray(value)) {
    return value.map((entry) => (typeof entry === 'string' ? entry.trim() : '')).filter(Boolean);
  }
  return value
    .split(',')
    .map((entry) => entry.trim())
    .filter(Boolean);
};

const keywordList = normalizeKeywords(keywords);
const resolvedKeywords = keywordList.length
  ? keywordList
  : cmsKeywords.length
    ? cmsKeywords
    : DEFAULT_KEYWORDS;
const resolvedOgImage = ogImage ?? cmsOgImage ?? DEFAULT_OG_IMAGE;
const basePageTitle = title ?? cmsTitle ?? undefined;
const pageTitle = basePageTitle
  ? SITE_NAME && !basePageTitle.includes(SITE_NAME)
    ? `${basePageTitle} | ${SITE_NAME}`
    : basePageTitle
  : SITE_NAME;

const DEFAULT_DIESEL_HREF = '/shop?categorySlug=diesel-parts&page=1';
const DEFAULT_DIESEL_LABEL = 'Diesel Parts';
const DEFAULT_PLATFORM_HREF = '/shop/categories/6-7l-powerstroke';
const DEFAULT_PLATFORM_LABEL = '6.7L Powerstroke';

const sanitizeBreadcrumbLabel = (value: string | undefined, fallback: string) => {
  if (typeof value === 'string') {
    const trimmed = value.replace(/\s+/g, ' ').trim();
    if (trimmed.length > 0) return trimmed;
  }
  return fallback;
};

const sanitizeBreadcrumbHref = (value: string | undefined, fallback: string) => {
  if (typeof value === 'string' && value.trim().length > 0) {
    return value.trim();
  }
  return fallback;
};

const buildContextualBreadcrumbs = () => {
  if (!shouldRenderBreadcrumbs || !breadcrumbContext) return null;
  const dieselHref = sanitizeBreadcrumbHref(breadcrumbContext.dieselHref, DEFAULT_DIESEL_HREF);
  const dieselLabel = sanitizeBreadcrumbLabel(breadcrumbContext.dieselLabel, DEFAULT_DIESEL_LABEL);
  const platformHref = sanitizeBreadcrumbHref(
    breadcrumbContext.platformHref,
    DEFAULT_PLATFORM_HREF
  );
  const platformLabel = sanitizeBreadcrumbLabel(
    breadcrumbContext.platformLabel,
    DEFAULT_PLATFORM_LABEL
  );
  const fallbackLabel = sanitizeBreadcrumbLabel(
    typeof basePageTitle === 'string' ? basePageTitle : (cmsTitle ?? title ?? 'Current Page'),
    'Current Page'
  );
  const currentLabel = sanitizeBreadcrumbLabel(breadcrumbContext.currentLabel, fallbackLabel);

  return [
    { href: '/', label: 'Home' },
    { href: dieselHref, label: dieselLabel },
    { href: platformHref, label: platformLabel },
    { label: currentLabel }
  ];
};
const sanitizeSegment = (segment: string) => {
  const decoded = decodeURIComponent(segment);
  const spaced = decoded
    .replace(/[-_]+/g, ' ')
    .replace(/([a-z0-9])([A-Z])/g, '$1 $2')
    .toLowerCase()
    .replace(/\b\w/g, (char) => char.toUpperCase());
  return spaced.trim() || decoded;
};

const LABEL_OVERRIDES: Record<string, string> = {
  faq2: 'FAQ',
  privacypolicy: 'Privacy Policy',
  returnrefundpolicy: 'Return & Refund Policy',
  custombuild: 'Custom Build',
  customerdashboard: 'Customer Dashboard',
  shop: 'Shop',
  specs: 'Spec Sheets',
  jtx: 'JTX Forged',
  belak: 'Belak Wheels'
};

const pathSegments = Astro.url?.pathname?.replace(/\/+$/, '').split('/').filter(Boolean) ?? [];

const isHomeRoute = pathSegments.length === 0;
const shouldRenderBreadcrumbs = !hideBreadcrumbs && !isHomeRoute;

const buildAutoBreadcrumbs = () => {
  if (!shouldRenderBreadcrumbs) return [];

  const contextual = buildContextualBreadcrumbs();
  if (Array.isArray(contextual) && contextual.length > 0) {
    return contextual;
  }

  const segments = pathSegments.map((segment, index) => {
    const href = '/' + pathSegments.slice(0, index + 1).join('/');
    const key = segment.toLowerCase();
    const label = LABEL_OVERRIDES[key] ?? sanitizeSegment(segment);
    return { href, label };
  });

  if (segments.length && title) {
    segments[segments.length - 1].label = title;
  }

  return [{ href: '/', label: 'Home' }, ...segments];
};

const ensureHomeCrumb = (items: Array<{ href?: string; label: string }>) => {
  if (items.length === 0) return items;
  const first = items[0];
  const labelIsHome = typeof first.label === 'string' && first.label.toLowerCase() === 'home';
  if (first.href === '/' || first.href === '' || labelIsHome) {
    return items;
  }
  return [{ href: '/', label: 'Home' }, ...items];
};

const finalizeBreadcrumbs = (items?: Array<{ href?: string; label: string }>) => {
  if (!items || items.length === 0) return [];
  return items.map((item, index) =>
    index === items.length - 1 ? { label: item.label } : { href: item.href, label: item.label }
  );
};

const breadcrumbSource = breadcrumbs?.length
  ? breadcrumbs
  : cmsBreadcrumbs.length
    ? cmsBreadcrumbs
    : buildAutoBreadcrumbs();

const breadcrumbItems = shouldRenderBreadcrumbs
  ? finalizeBreadcrumbs(ensureHomeCrumb(breadcrumbSource))
  : [];

const defaultJsonLdEntries = buildDefaultJsonLdGraph({
  siteName: SITE_NAME,
  siteUrl,
  canonicalUrl,
  pageTitle: basePageTitle ?? SITE_NAME,
  description: resolvedDescription,
  breadcrumbs: breadcrumbItems,
  imageUrl: resolvedOgImage
});

const computedPayload = {
  global: seoPayload.global,
  page: {
    ...seoPayload.page,
    title: basePageTitle ?? seoPayload.page?.title,
    description: resolvedDescription,
    keywords: resolvedKeywords,
    noindex,
    ogImage: resolvedOgImage,
    breadcrumbs: cmsBreadcrumbs,
    relatedLinks: cmsRelatedLinks
  }
};

const metaEntries = buildMetaEntries(computedPayload, canonicalUrl ?? undefined);
const computedTitle = metaEntries.title || pageTitle;
const metaTags = [{ property: 'og:site_name', content: SITE_NAME }, ...metaEntries.meta];
const cmsJsonLdEntries = buildJsonLd(computedPayload);
const jsonLdEntries = [...defaultJsonLdEntries, ...cmsJsonLdEntries];
---

<!doctype html>
<html lang="en" class="dark">
  <head>
    <!-- Google tag (gtag.js) -->
    <script is:inline type="module">
      (function ensureRuntimeGlobals() {
        var target =
          typeof window !== 'undefined'
            ? window
            : typeof globalThis !== 'undefined'
              ? globalThis
              : undefined;

        if (!target || typeof target !== 'object') {
          return;
        }

        if (typeof target.__DEFINES__ === 'undefined' || target.__DEFINES__ === null) {
          try {
            Object.defineProperty(target, '__DEFINES__', {
              value: {},
              writable: true,
              configurable: true,
              enumerable: false
            });
          } catch {
            target.__DEFINES__ = {};
          }
        }

        if (typeof target.inlineGaSetup !== 'function') {
          var fallback = function inlineGaSetup() {
            return undefined;
          };

          try {
            Object.defineProperty(target, 'inlineGaSetup', {
              value: fallback,
              writable: true,
              configurable: true
            });
          } catch {
            target.inlineGaSetup = fallback;
          }

          if (
            typeof window !== 'undefined' &&
            window !== target &&
            typeof window.inlineGaSetup !== 'function'
          ) {
            try {
              window.inlineGaSetup = fallback;
            } catch {
              window.inlineGaSetup = fallback;
            }
          }

          if (
            typeof globalThis !== 'undefined' &&
            globalThis !== target &&
            typeof globalThis.inlineGaSetup !== 'function'
          ) {
            try {
              globalThis.inlineGaSetup = fallback;
            } catch {
              globalThis.inlineGaSetup = fallback;
            }
          }
        }
      })();
    </script>
    <script is:inline type="module">
      const GTAG_URL = 'https://www.googletagmanager.com/gtag/js?id=AW-17641771829';
      const initAnalytics = () => {
        if (typeof window === 'undefined') return;
        if (window.__fasGtagInitialized) return;
        window.__fasGtagInitialized = true;
        window.dataLayer = window.dataLayer || [];
        function gtag() {
          window.dataLayer.push(arguments);
        }
        window.gtag = gtag;
        gtag('js', new Date());
        gtag('config', 'G-NQ94Z6HWGV', { send_page_view: true });
        gtag('config', 'AW-17641771829');
      };

      const loadAnalyticsScript = () => {
        if (typeof document === 'undefined') return;
        if (document.querySelector('script[data-gtag-loader]')) return;
        const tag = document.createElement('script');
        tag.src = GTAG_URL;
        tag.async = true;
        tag.dataset.gtagLoader = 'true';
        tag.addEventListener('load', () => {
          try {
            document.dispatchEvent(new Event('gtag:loaded'));
          } catch {
            /* noop */
          }
        });
        document.head.appendChild(tag);
      };

      const bootAnalytics = () => {
        initAnalytics();
        loadAnalyticsScript();
      };

      const scheduleAnalytics = () => {
        if (typeof window === 'undefined' || typeof document === 'undefined') return;
        const start = () => {
          if ('requestIdleCallback' in window) {
            window.requestIdleCallback(bootAnalytics, { timeout: 2000 });
          } else {
            window.setTimeout(bootAnalytics, 300);
          }
        };

        if (document.readyState === 'complete' || document.readyState === 'interactive') {
          start();
        } else {
          document.addEventListener('DOMContentLoaded', start, { once: true });
        }
      };

      scheduleAnalytics();
    </script>
    <link rel="icon" type="image/webp" href="/favicon-96x96.webp" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="shortcut icon" href="/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.webp" />
    <meta name="apple-mobile-web-app-title" content="FAS Moto" />
    <link rel="manifest" href="/site.webmanifest" crossorigin="use-credentials" />
    <link rel="icon" type="image/webp" href="/logo/faslogochroma.webp" />
    <link rel="preconnect" href="https://www.googletagmanager.com" crossorigin />
    <link rel="preconnect" href="https://www.google-analytics.com" crossorigin />
    <link rel="preconnect" href="https://stats.g.doubleclick.net" crossorigin />
    <link rel="preconnect" href="https://www.google.com" crossorigin />
    <link rel="dns-prefetch" href="https://www.googletagmanager.com" />
    <link rel="dns-prefetch" href="https://www.google-analytics.com" />
    <link rel="dns-prefetch" href="https://stats.g.doubleclick.net" />
    <link rel="dns-prefetch" href="https://analytics.google.com" />
    <link rel="dns-prefetch" href="https://www.google.com" />
    <link
      rel="preload"
      href="/fonts/AmericanCaptain.woff2"
      as="font"
      type="font/woff2"
      crossorigin
    />
    <link
      rel="preload"
      href="/fonts/Ethnocentric-Regular.woff2"
      as="font"
      type="font/woff2"
      crossorigin
    />
    <link rel="preload" href="/fonts/Borgsquad.woff2" as="font" type="font/woff2" crossorigin />

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta name="theme-color" content="#09090b" />
    <title>{computedTitle}</title>
    <meta name="author" content={SITE_AUTHOR} />
    {
      metaTags
        .filter((meta) => typeof meta.content === 'string' && meta.content.length > 0)
        .map((meta, index) => {
          const attrs = meta.name
            ? { name: meta.name }
            : meta.property
              ? { property: meta.property }
              : {};
          if (!('name' in attrs) && !('property' in attrs)) {
            return null;
          }
          return (
            <meta
              {...attrs}
              content={meta.content}
              data-seo-meta-key={meta.name ?? meta.property ?? `meta-${index}`}
            />
          );
        })
    }
    {canonicalUrl && <link rel="canonical" href={canonicalUrl} />}
    {
      jsonLdEntries.map((entry, index) => (
        <script
          type="application/ld+json"
          set:html={JSON.stringify(entry)}
          data-seo-ld-index={index}
        />
      ))
    }
    <script is:inline type="module">
      (function () {
        if (typeof window === 'undefined') return;

        var MERCHANT_ID = 5664091767;
        var pendingOrder = null;
        var renderedFor = null;

        function normalizeProducts(products) {
          if (!Array.isArray(products)) return undefined;
          var mapped = products
            .map(function (product) {
              if (!product) return null;
              if (typeof product === 'string') {
                return product.trim() ? { gtin: product.trim() } : null;
              }
              var gtin = product.gtin || product.GTIN || product.id || '';
              gtin = typeof gtin === 'number' ? String(gtin) : String(gtin || '').trim();
              return gtin ? { gtin: gtin } : null;
            })
            .filter(Boolean);
          return mapped.length ? mapped : undefined;
        }

        function buildPayload(order) {
          if (!order) return null;
          var orderId = String(order.orderId || order.order_id || '').trim();
          var email = String(order.email || order.customerEmail || '').trim();
          var country = String(order.deliveryCountry || order.delivery_country || '').trim();
          var delivery = String(
            order.estimatedDeliveryDate || order.estimated_delivery_date || ''
          ).trim();
          if (!orderId || !email || !country || !delivery) return null;
          var payload = {
            merchant_id: MERCHANT_ID,
            order_id: orderId,
            email: email,
            delivery_country: country,
            estimated_delivery_date: delivery
          };
          var products = normalizeProducts(order.products);
          if (products) payload.products = products;
          return payload;
        }

        function tryRender() {
          if (!pendingOrder) return;
          var gapi = window.gapi;
          if (!gapi || !gapi.surveyoptin || typeof gapi.surveyoptin.render !== 'function') return;
          var payload = buildPayload(pendingOrder);
          if (!payload) return;
          if (renderedFor && renderedFor === payload.order_id) return;
          try {
            gapi.surveyoptin.render(payload);
            renderedFor = payload.order_id;
          } catch (err) {
            console.warn('Google Reviews opt-in render failed:', err);
          }
        }

        window.renderOptIn = function () {
          tryRender();
        };

        window.triggerGoogleReviewOptIn = function (orderDetails) {
          if (!orderDetails) {
            pendingOrder = null;
            renderedFor = null;
            return;
          }
          pendingOrder = orderDetails;
          tryRender();
        };

        window.addEventListener('google-review:optin', function (event) {
          window.triggerGoogleReviewOptIn(event && event.detail);
        });
      })();
    </script>
    <script async defer src="https://apis.google.com/js/platform.js?onload=renderOptIn"></script>

    <slot name="head" />
  </head>

  <body class="bg-background pt-3 text-white font-mono min-h-screen flex flex-col">
    <script type="module" src={analyticsTrackingScriptUrl}></script>
    <svg
      width="0"
      height="0"
      class="absolute pointer-events-none select-none"
      aria-hidden="true"
      focusable="false"
    >
      <defs>
        <!-- Container-sized liquid glass filter -->
        <filter id="container-glass">
          <feTurbulence
            type="fractalNoise"
            baseFrequency="0.01"
            numOctaves="3"
            seed="2"
            result="noise"></feTurbulence>
          <feGaussianBlur in="noise" stdDeviation="2" result="blur"></feGaussianBlur>
          <feDisplacementMap
            in="SourceGraphic"
            in2="blur"
            scale="20"
            xChannelSelector="R"
            yChannelSelector="G"></feDisplacementMap>
        </filter>
        <!-- Button-sized stronger liquid glass filter -->
        <filter id="btn-glass">
          <feTurbulence
            type="fractalNoise"
            baseFrequency="0.02"
            numOctaves="3"
            seed="3"
            result="noise"></feTurbulence>
          <feGaussianBlur in="noise" stdDeviation="1.5" result="blur"></feGaussianBlur>
          <feDisplacementMap
            in="SourceGraphic"
            in2="blur"
            scale="14"
            xChannelSelector="R"
            yChannelSelector="G"></feDisplacementMap>
        </filter>
      </defs>
    </svg>

    <!-- Header sits outside page stacking contexts to stay on top -->
    <Header />

    <!-- Page content -->
    <div class="relative flex flex-col flex-1">
      <main
        class="px-5 pt-6 flex-1 container max-w-full mx-auto with-header-offset"
      >
        {breadcrumbItems.length > 0 && <Breadcrumbs items={breadcrumbItems} />}
        <slot />
        {cmsRelatedLinks.length > 0 && <InternalLinks links={cmsRelatedLinks} />}
      </main>
      <SitewideProductServiceLinks />
      <Footer />
      <Footer2 client:visible />
      <CookieBanner client:idle />
      <Toaster client:idle />
      <MobileAddToCartToast client:only="react" />
      <DesktopAddToCartToast client:only="react" />
    </div>

    <!-- fas-auth client shim (provides window.fasAuth) -->
    <script src="/fas-auth.js" defer></script>
    <!-- Auth bootstrap removed: serverless login/session handles auth without Auth0 SDK -->
    <script>
      // Capture landing page on first visit
      if (!sessionStorage.getItem('landing_page')) {
        sessionStorage.setItem('landing_page', window.location.href);
      }

      // Capture first touch timestamp
      if (!sessionStorage.getItem('first_touch')) {
        sessionStorage.setItem('first_touch', new Date().toISOString());
      }
    </script>
  </body>
</html>
