---
import BaseLayout from '../../layouts/BaseLayout.astro';
const title = 'Vendor Dashboard';
---

<BaseLayout title={title}>
  <div
    class="min-h-screen flex items-center justify-center"
    style="background-image: url('/images/about page background FAS.png')"
  >
    <div class="bg-black p-6 rounded-lg shadow-lg border border-white max-w-4xl w-full text-white">
      <div class="mb-6 text-center">
        <img
          src="/logo/faslogo150.png"
          alt="FAS Motorsports Logo"
          width="100"
          height="100"
          class="mx-auto"
        />
      </div>
      <h1 class="text-4xl font-bold font-orbitron text-red-600 mb-6 uppercase">
        Vendor Dashboard
      </h1>
      <div class="space-y-6">
        <section>
          <h2 class="text-2xl font-bold text-red-600 mb-4">Orders</h2>
          <ul id="ordersList" class="space-y-4"></ul>
        </section>
        <section>
          <h2 class="text-2xl font-bold text-red-600 mb-4">Quotes</h2>
          <ul id="quotesList" class="space-y-4"></ul>
        </section>
      </div>
    </div>
  </div>

  <script is:inline>
    async function loadVendorDashboard() {
      const ordersList = document.querySelector('#ordersList');
      const quotesList = document.querySelector('#quotesList');
      
      if (!ordersList || !quotesList) {
        console.error('Required elements not found');
        return;
      }
      
      const token = localStorage.getItem('vendorToken');
      if (!token) {
        ordersList.innerHTML = '<li class="p-4 bg-gray-800 rounded-lg">No vendor token found â€“ please log in.</li>';
        quotesList.innerHTML = '';
        return;
      }
      
      try {
        const res = await fetch('/api/vendor/dashboard', {
          headers: {
            'Authorization': `Bearer ${token}`
          },
          credentials: 'include'
        });
        
        if (!res.ok) {
          throw new Error(`Failed to load dashboard (${res.status})`);
        }

        const data = await res.json();
        const orders = data.orders ?? [];
        const quotes = data.quotes ?? [];
        
        if (orders.length > 0) {
          ordersList.innerHTML = orders
            .map((order) => {
              const date = order.orderDate ? new Date(order.orderDate).toLocaleDateString() : 'Unknown date';
              return `<li class="p-4 bg-gray-800 rounded-lg">Order #${order.orderId ?? 'N/A'}: ${order.status ?? 'Unknown'} (Total: $${order.amount ?? '0'}), Date: ${date}</li>`;
            })
            .join('');
        } else {
          ordersList.innerHTML = '<li class="p-4 bg-gray-800 rounded-lg">No orders yet.</li>';
        }
        
        if (quotes.length > 0) {
          quotesList.innerHTML = quotes
            .map((quote) => {
              const date = quote.dateSubmitted ? new Date(quote.dateSubmitted).toLocaleDateString() : 'Unknown date';
              return `<li class="p-4 bg-gray-800 rounded-lg">Quote #${quote.quoteId ?? 'N/A'}: ${quote.status ?? 'Unknown'}, Submitted: ${date}, ${quote.description ?? ''}</li>`;
            })
            .join('');
        } else {
          quotesList.innerHTML = '<li class="p-4 bg-gray-800 rounded-lg">No quotes yet.</li>';
        }
      } catch (error) {
        console.error('Error loading dashboard:', error);
        ordersList.innerHTML = '<li class="p-4 bg-gray-800 rounded-lg">Failed to load dashboard.</li>';
        quotesList.innerHTML = '';
      }
    }
    
    document.addEventListener('DOMContentLoaded', loadVendorDashboard);
  </script>
</BaseLayout>
