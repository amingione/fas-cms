---
// src/pages/account/index.astro
import BaseLayout from "../../layouts/BaseLayout.astro";
import { readSession } from '../../server/auth/session';

// Validate the current session so stale cookies don't render the dashboard state
const { session } = await readSession(Astro.request);
const isLoggedIn = Boolean(session);

const requestUrl = new URL(Astro.request.url);
requestUrl.search = '';
requestUrl.hash = '';
const canonical = requestUrl.toString();

const pageTitle = isLoggedIn ? 'Account Dashboard' : 'Account Access';
const pageDescription = isLoggedIn
  ? 'Access your F.A.S. Motorsports dashboard for orders, quotes, invoices, and appointment details.'
  : 'Sign in or create a F.A.S. Motorsports account to track orders, quotes, and service appointments.';
---

<BaseLayout hideBrandTag={true} title={pageTitle} description={pageDescription} canonical={canonical}>
  <main class="relative text-white p-8 mt-10">
    {isLoggedIn ? (
      <section class="max-w-xl">
        <h1 class="text-2xl font-ethno text-primary mb-2">Account</h1>
        <p class="mb-4">You are signed in.</p>
        <div class="flex gap-3">
          <a href="/dashboard" class="px-4 py-2 rounded bg-primary text-white font-ethno hover:text-white">Go to Dashboard</a>
          <a href="/api/auth/logout" class="px-4 py-2 rounded border border-white/30 font-ethno">Logout</a>
        </div>
      </section>
    ) : (
      <section class="max-w-xl">
        <h1 class="text-2xl font-ethno text-primary mb-2">Account</h1>
        <p class="mb-4">Log in with your email and password to access your dashboard.</p>
        <div class="space-y-3 max-w-sm">
          <div class="text-sm mb-2">
            <button id="mode-login" class="underline">Sign in</button>
            <span class="mx-2 opacity-50">â€¢</span>
            <button id="mode-signup" class="underline">Create an account</button>
          </div>
        </div>
        <form id="fas-login" class="space-y-3 max-w-sm">
          <div>
            <label class="block text-sm mb-1">Email</label>
            <input type="email" name="email" required class="w-full bg-white/5 border border-white/15 rounded px-3 py-2" />
          </div>
          <div>
            <label class="block text-sm mb-1">Password</label>
            <input type="password" name="password" required class="w-full bg-white/5 border border-white/15 rounded px-3 py-2" />
            <div class="mt-2 text-xs">
              <a href="/account/forgot-password" class="text-primary hover:text-primary/80">Forgot password?</a>
            </div>
          </div>
          <button type="submit" class="px-4 py-2 rounded bg-primary text-white font-ethno hover:text-white">Sign in</button>
        </form>
        <form id="fas-signup" class="space-y-3 max-w-sm hidden">
          <div>
            <label class="block text-sm mb-1">Name (optional)</label>
            <input type="text" name="name" class="w-full bg-white/5 border border-white/15 rounded px-3 py-2" />
          </div>
          <div>
            <label class="block text-sm mb-1">Email</label>
            <input type="email" name="email" required class="w-full bg-white/5 border border-white/15 rounded px-3 py-2" />
          </div>
          <div>
            <label class="block text-sm mb-1">Password</label>
            <input type="password" name="password" required minlength="8" class="w-full bg-white/5 border border-white/15 rounded px-3 py-2" />
          </div>
          <button type="submit" class="px-4 py-2 rounded bg-primary text-white font-ethno hover:text-white">Create account</button>
        </form>
        <div id="auth-message" class="mt-4 hidden rounded-md border px-4 py-3 text-sm"></div>
        <script>
          const $ = (s: string) => document.querySelector(s);
          const loginForm = $('#fas-login');
          const signupForm = $('#fas-signup');
          const modeLogin = $('#mode-login');
          const modeSignup = $('#mode-signup');
          const messageBox = document.getElementById('auth-message');
          function show(which: string) {
            if (!loginForm || !signupForm) return;
            if (which === 'signup') {
              signupForm.classList.remove('hidden');
              loginForm.classList.add('hidden');
            } else {
              signupForm.classList.add('hidden');
              loginForm.classList.remove('hidden');
            }
            clearMessage();
          }
          function setMessage(text: string, type: 'error' | 'success' = 'error') {
            if (!messageBox) return;
            messageBox.textContent = text;
            messageBox.classList.remove('hidden');
            messageBox.classList.remove('border-green-400', 'text-green-200', 'border-red-400', 'text-red-200', 'bg-green-500/10', 'bg-red-500/10');
            if (type === 'success') {
              messageBox.classList.add('border-green-400', 'text-green-200', 'bg-green-500/10');
            } else {
              messageBox.classList.add('border-red-400', 'text-red-200', 'bg-red-500/10');
            }
          }
          function clearMessage() {
            if (!messageBox) return;
            messageBox.classList.add('hidden');
            messageBox.textContent = '';
          }
          modeLogin?.addEventListener('click', (e) => { e.preventDefault(); show('login'); });
          modeSignup?.addEventListener('click', (e) => { e.preventDefault(); show('signup'); });
          document.getElementById('fas-login')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target as HTMLFormElement;
            const data = Object.fromEntries(new FormData(form));
            clearMessage();
            const res = await fetch('/api/auth/login', { method: 'POST', headers: { 'content-type': 'application/json' }, body: JSON.stringify(data) });
            if (res.ok) {
              const rt = new URL(window.location.href).searchParams.get('returnTo') || '/dashboard';
              window.location.href = rt;
            } else {
              let message = 'Login failed. Please try again.';
              try {
                const detail = await res.json();
                if (detail?.message) message = detail.message;
              } catch {}
              setMessage(message, 'error');
            }
          });
          document.getElementById('fas-signup')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target as HTMLFormElement;
            const data = Object.fromEntries(new FormData(form));
            clearMessage();
            const res = await fetch('/api/auth/signup', { method: 'POST', headers: { 'content-type': 'application/json' }, body: JSON.stringify(data) });
            if (res.ok) {
              const rt = new URL(window.location.href).searchParams.get('returnTo') || '/dashboard';
              window.location.href = rt;
            } else if (res.status === 409) {
              setMessage('An account with this email already exists. Please sign in instead.', 'error');
              show('login');
            } else {
              let message = 'Sign up failed. Please try again later.';
              try {
                const detail = await res.json();
                if (detail?.message) message = detail.message;
              } catch {}
              setMessage(message, 'error');
            }
          });
        </script>
      </section>
    )}
  </main>
</BaseLayout>
