---
import ProductCard from '@/components/storefront/ProductCardLite.astro';
import { buildPrimaryKeywordAnchor, collapseLabelSpaces } from '@/lib/seoAnchors';
import { sanityClient as client } from '@/lib/sanityClient.ts';
import BaseLayout from '@/layouts/BaseLayout.astro';

interface Props {
  params: { category: string };
}
const { params } = Astro as unknown as Props;

// Get the category document by slug
const categoryQuery = /* groq */ `
*[_type == "category" && slug.current == $slug][0]{
  _id, title, description
}
`;
const category = await client.fetch(categoryQuery, { slug: params.category });

// Fetch published products that reference this category
const productsQuery = /* groq */ `
*[_type == "product" && !(_id in path('drafts.**')) && (status == "active" || !defined(status)) && defined(slug.current) && references($catId)] | order(_createdAt desc){
  _id,
  title,
  "slug": slug.current,
  "image": coalesce(images[0].asset->url, mainImage.asset->url),
  price,
  excerpt,
  primaryKeyword,
  fitmentYears,
  fitment,
  "seoPrimaryKeyword": coalesce(seo.primaryKeyword, seo.keyphrase, seo.keyword, seo.targetKeyword),
  "seoFitmentYears": seo.fitmentYears,
  "seoFitment": coalesce(seo.fitmentText, seo.fitment)
}
`;
interface ProductItem {
  _id: string;
  title: string;
  slug: string;
  image?: string;
  price?: number;
  excerpt?: string;
  primaryKeyword?: string;
  fitmentYears?: unknown;
  fitment?: string;
  seoPrimaryKeyword?: string;
  seoFitmentYears?: unknown;
  seoFitment?: string;
}

const products: ProductItem[] = category
  ? await client.fetch<ProductItem[]>(productsQuery, { catId: category._id })
  : [];

// Adapt to ProductCardLite.astro expected props
type LiteAsset = { url: string };
type LiteImage = { asset: LiteAsset };
type LiteSlug = { current: string };
type LiteProduct = {
  _id: string;
  title?: string;
  slug?: LiteSlug | string;
  price?: number;
  images?: LiteImage[];
  seoAnchorText?: string;
};

const toAnchorText = (product: ProductItem): string | undefined => {
  return buildPrimaryKeywordAnchor(
    {
      primaryKeyword: product.primaryKeyword,
      seoPrimaryKeyword: product.seoPrimaryKeyword,
      fitmentYears: product.fitmentYears,
      seoFitmentYears: product.seoFitmentYears,
      fitment: product.fitment,
      seoFitment: product.seoFitment,
      fallbackLabel: product.title
    },
    product.title
  );
};

const liteProducts: LiteProduct[] = products.map((p) => ({
  _id: p._id,
  title: p.title,
  slug: { current: p.slug } as LiteSlug,
  price: p.price,
  images: p.image ? [{ asset: { url: p.image } }] : [],
  seoAnchorText: toAnchorText(p)
}));

const requestUrl = new URL(Astro.request.url);
requestUrl.search = '';
requestUrl.hash = '';
const canonicalUrl = requestUrl.toString();

const ensureAbsoluteUrl = (value?: string | null) => {
  if (!value) return undefined;
  if (/^https?:/i.test(value)) return value;
  try {
    return new URL(value, `${requestUrl.origin}/`).toString();
  } catch {
    return undefined;
  }
};

const resolveProductSlug = (product: LiteProduct): string => {
  const rawSlug = product?.slug as any;
  if (typeof rawSlug === 'string') return rawSlug;
  if (rawSlug && typeof rawSlug === 'object' && typeof rawSlug.current === 'string') {
    return rawSlug.current;
  }
  return '';
};

const resolvedCategoryTitle = category?.title ?? 'Category';
const resolvedCategoryDescription =
  typeof category?.description === 'string' && category.description.trim()
    ? category.description.trim()
    : category
      ? `Shop ${resolvedCategoryTitle} performance products from F.A.S. Motorsports.`
      : 'Browse performance categories from F.A.S. Motorsports.';

const dieselPartsUrl = `${requestUrl.origin}/shop?categorySlug=diesel-parts&page=1`;
const powerstrokeUrl = `${requestUrl.origin}/shop/categories/6-7l-powerstroke`;
const resolvedCategoryLabel = collapseLabelSpaces(resolvedCategoryTitle);

const breadcrumbContext = category
  ? {
      dieselHref: '/shop?categorySlug=diesel-parts&page=1',
      dieselLabel: 'Diesel Parts',
      platformHref: '/shop/categories/6-7l-powerstroke',
      platformLabel: '6.7L Powerstroke',
      currentLabel: resolvedCategoryLabel
    }
  : undefined;

const pageTitle = category ? `${resolvedCategoryLabel} Products` : 'Category';
const pageDescription = collapseLabelSpaces(resolvedCategoryDescription);

const breadcrumbStructuredData = category
  ? {
      '@context': 'https://schema.org',
      '@type': 'BreadcrumbList',
      itemListElement: [
        { '@type': 'ListItem', position: 1, name: 'Home', item: `${requestUrl.origin}/` },
        { '@type': 'ListItem', position: 2, name: 'Diesel Parts', item: dieselPartsUrl },
        { '@type': 'ListItem', position: 3, name: '6.7L Powerstroke', item: powerstrokeUrl },
        { '@type': 'ListItem', position: 4, name: resolvedCategoryLabel, item: canonicalUrl }
      ]
    }
  : null;

const productItemListElements = category
  ? liteProducts
      .map((product, index) => {
        const slugValue = resolveProductSlug(product);
        if (!slugValue) return null;
        const productUrl = `${requestUrl.origin}/shop/${slugValue}`;
        const images = Array.isArray(product.images)
          ? product.images
              .map((image: LiteImage) => ensureAbsoluteUrl(image?.asset?.url))
              .filter((value): value is string => Boolean(value))
          : [];
        const anchorLabel =
          typeof (product as any)?.seoAnchorText === 'string' &&
          (product as any).seoAnchorText.trim().length > 0
            ? (product as any).seoAnchorText.trim()
            : (product.title ?? resolvedCategoryLabel);
        const priceNumber = Number(product.price);
        const offers =
          !Number.isNaN(priceNumber) && priceNumber > 0
            ? {
                '@type': 'Offer',
                priceCurrency: 'USD',
                price: priceNumber.toFixed(2),
                availability: 'https://schema.org/InStock',
                url: productUrl,
                itemCondition: 'https://schema.org/NewCondition'
              }
            : undefined;
        return {
          '@type': 'ListItem',
          position: index + 1,
          url: productUrl,
          item: {
            '@type': 'Product',
            name: anchorLabel,
            image: images.length ? images : undefined,
            offers
          }
        };
      })
      .filter((entry): entry is Exclude<typeof entry, null> => entry !== null)
  : [];

const categoryCollectionStructuredData =
  category && productItemListElements.length
    ? {
        '@context': 'https://schema.org',
        '@type': 'CollectionPage',
        name: pageTitle,
        url: canonicalUrl,
        description: pageDescription,
        mainEntity: {
          '@type': 'ItemList',
          name: `${resolvedCategoryTitle} products`,
          numberOfItems: productItemListElements.length,
          itemListElement: productItemListElements
        }
      }
    : null;
---

<BaseLayout
  title={pageTitle}
  description={pageDescription}
  canonical={canonicalUrl}
  breadcrumbContext={breadcrumbContext}
>
  {
    breadcrumbStructuredData && (
      <Fragment slot="head">
        <script type="application/ld+json" set:html={JSON.stringify(breadcrumbStructuredData)} />
        {categoryCollectionStructuredData && (
          <script
            type="application/ld+json"
            set:html={JSON.stringify(categoryCollectionStructuredData)}
          />
        )}
      </Fragment>
    )
  }
  <div class="max-w-7xl mx-auto px-4 md:px-6 py-12">
    {
      !category && (
        <section class="py-16 text-center">
          <h1 class="text-3xl font-semibold">Category not found</h1>
        </section>
      )
    }

    {
      category && (
        <>
          <header class="mb-8">
            <h1 class="text-3xl md:text-4xl font-semibold">{category.title}</h1>
            {category.description && <p class="mt-2 text-sm opacity-80">{category.description}</p>}
          </header>

          <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6">
            {liteProducts.map((p) => (
              <ProductCard key={p._id} product={p} productImage={p.images?.[0]} />
            ))}
          </section>
        </>
      )
    }
  </div></BaseLayout
>
