---
import BaseLayout from '../../layouts/BaseLayout.astro';

export const prerender = false;

const SANITY_PROJECT_ID = import.meta.env.PUBLIC_SANITY_PROJECT_ID;
const SANITY_API_TOKEN = import.meta.env.PUBLIC_SANITY_API_TOKEN;
---

<BaseLayout>
  <section class="max-w-7xl mx-auto px-6 py-12 text-white space-y-10">
    <h1 class="text-3xl font-ethno font-bold text-accent">Shop</h1>

    <!-- Category Tabs -->
    <div id="category-tabs" class="flex flex-wrap gap-3 text-sm font-captain">
      <!-- JS will populate tabs here -->
    </div>

    <!-- Sort -->
    <div class="flex items-center gap-4 text-sm font-captain">
      <label for="sort" class="text-primary">Sort:</label>
      <select id="sort" class="bg-black border border-gray-700 px-3 py-1 rounded">
        <option value="price">Price</option>
        <option value="horsepower">Horsepower</option>
      </select>
    </div>

    <!-- Product Grid -->
    <div id="product-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-8 pt-6">
      <!-- JS populates this -->
    </div>

    <!-- Pagination -->
    <div id="pagination" class="flex justify-center mt-12">
      <!-- JS populates this -->
    </div>
  </section>

  <script is:inline>

    const grid = document.getElementById('product-grid');
    const pagination = document.getElementById('pagination');
    const categoryTabs = document.getElementById("category-tabs");
    const sortSelect = document.getElementById('sort');

    const PAGE_SIZE = 9;
    let currentPage = 1;
    let currentCategory = '';
    let currentSort = 'price';

    const fetchProducts = async () => {
      const start = (currentPage - 1) * PAGE_SIZE;
      const end = start + PAGE_SIZE;
      const filters = [];

      if (currentCategory) {
        filters.push(`"${currentCategory}" in categories[]->title`); // Added missing semicolon
      }

      const filterString = filters.length ? `*[_type == "wooProduct" && ${filters.join(' && ')}]` : `*[_type == "wooProduct"]`;
      const sortString = `| order(${currentSort} asc)[${start}...${end}]`;
      const query = `${filterString} ${sortString} {
        _id,
        title,
        slug,
        price,
        images[]{ asset->{ url } }
      }`;
      console.log("SANITY QUERY:", query);

      const result = await fetch(
        `https://${SANITY_PROJECT_ID}.api.sanity.io/v1/data/query/production?query=${encodeURIComponent(query)}`,
        {
          headers: {
            Authorization: "Bearer " + SANITY_API_TOKEN,
          },
        }
      ).then(res => res.json());
      console.log("Products fetched:", result.result);

      return result.result || [];
    };

    const fetchCount = async () => {
      const filters = [];
      if (currentCategory) {
        filters.push(`"${currentCategory}" in categories[]._ref`);
      }
        const query = `count(*[_type == "wooProduct"${filters.length ? ' && ' + filters.join(' && ') : ''}])`;
        const result = await fetch(
          "https://" + SANITY_PROJECT_ID + ".api.sanity.io/v1/data/query/production?query=" + encodeURIComponent(query),
          {
            headers: {
              Authorization: "Bearer " + SANITY_API_TOKEN,
            },
          }
        ).then(res => res.json());
  
        return result.result || 0;
      };

    const fetchCategories = async () => {
      const query = `*[_type == "category"]{ title }`;
      const result = await fetch(
        `https://${SANITY_PROJECT_ID}.api.sanity.io/v1/data/query/production?query=${encodeURIComponent(query)}`,
        {
          headers: {
            Authorization: "Bearer " + SANITY_API_TOKEN,
          },
        }
      ).then(res => res.json());
      return result.result || [];
    };

    const renderCategoryTabs = async () => {
      const categories = await fetchCategories();
      categoryTabs.innerHTML = `<button class="tab active" data-category="">All</button>`;
      categories.forEach(cat => {
        const btn = document.createElement("button");
        btn.className = "tab";
        btn.setAttribute("data-category", cat.title);
        btn.innerText = cat.title;
        categoryTabs.appendChild(btn);
      });
    };

    renderCategoryTabs();
    
    const renderProducts = async () => {
      const products = await fetchProducts();
      grid.innerHTML = products.map(product => {
        const title = product.title ?? 'Untitled';
        const slug = product.slug?.current ?? '#';
        const image = product.images?.[0]?.asset?.url ?? '/images/placeholder-product.png';
        const price = typeof product.price === 'number'
          ? `$${parseFloat(product.price).toFixed(2)}`
          : 'â€”';
    
        return `
          <div class="bg-white/5 border border-white/10 rounded-lg overflow-hidden shadow-lg backdrop-blur-md hover:scale-[1.02] transition-all">
            <a href="/shop/${slug}">
              <img src="${image}" alt="${title}" class="w-full h-60 object-cover" />
              <div class="p-4 space-y-2">
                <h3 class="font-semibold text-lg">${title}</h3>
                <p class="text-primary font-bold">${price}</p>
              </div>
            </a>
          </div>
        `;
      }).join('');
    };
    
    renderProducts();
  </script>
</BaseLayout>