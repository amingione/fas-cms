--- 
import BaseLayout from '@layouts/BaseLayout.astro';
import ProductCard from '@components/ProductCard.astro';
import { fetchProductsFromSanity, fetchCategories } from '@lib/sanity-utils';
import type { Product, Category } from '@lib/sanity-utils';

export const prerender = false;

const PAGE_SIZE = 12;
const url = new URL(Astro.request.url);
const currentPage = parseInt(url.searchParams.get("page") || "1");
const currentCategory = url.searchParams.get("categorySlug") || url.searchParams.get("category") || "";
const start = (currentPage - 1) * PAGE_SIZE;
const end = start + PAGE_SIZE;

// Selected filter tags can come from ?filter=a&filter=b or ?filters=a,b
const rawFilters = [
  ...url.searchParams.getAll("filter"),
  ...(url.searchParams.get("filters")?.split(",") || [])
]
  .map((s) => s.trim().toLowerCase())
  .filter(Boolean);
const selectedFilters: string[] = Array.from(new Set(rawFilters));

let allProducts: Product[] = [];
let categories: Category[] = [];

try {
  allProducts = await fetchProductsFromSanity({
    categorySlug: currentCategory || undefined,
  });
  categories = await fetchCategories();
} catch (err) {
  console.error("üî• Sanity Fetch Failed:", err);
}

// Build the available filters (category-aware)
const uniqueFilters: string[] = Array.from(
  new Set(
    allProducts.flatMap((p) => Array.isArray((p as any).filters) ? (p as any).filters.map((f: any) => String(f).toLowerCase()) : [])
  )
).sort();

// Apply selected filters (match-any). If none selected, keep all.
const filteredProducts: Product[] = selectedFilters.length
  ? allProducts.filter((p) => Array.isArray((p as any).filters) && (p as any).filters.some((f: any) => selectedFilters.includes(String(f).toLowerCase())))
  : allProducts;

const totalCount = filteredProducts.length;
const totalPages = Math.ceil(totalCount / PAGE_SIZE);
const products = filteredProducts.slice(start, end);

const paginationLinks = [];
const maxVisiblePages = 5;
const pageGroup = Math.floor((currentPage - 1) / maxVisiblePages);
const startPage = pageGroup * maxVisiblePages + 1;
const endPage = Math.min(startPage + maxVisiblePages - 1, totalPages);

if (startPage > 1) {
  paginationLinks.push({ label: "‚Üê", page: startPage - 1 });
}
for (let page = startPage; page <= endPage; page++) {
  paginationLinks.push({ label: page.toString(), page });
}
if (endPage < totalPages) {
  paginationLinks.push({ label: "‚Üí", page: endPage + 1 });
}
---

<BaseLayout>
  <section class="max-w-7xl mx-auto text-white">
    <div class="relative w-full h-[60vh] sm:h-[70vh] lg:h-[80vh] xl:h-[90vh] overflow-hidden">
      <img src="/images/shop background.png" alt="Shop Banner" class="w-full h-full object-cover shadow-lg" />
      <div class="absolute inset-0 flex flex-col items-center justify-center text-center pb-[8vh] sm:pb-[10vh] md:pb-[12vh] lg:pb-[14vh] xl:pb-[16vh]">
        <h1 class="text-4xl sm:text-5xl lg:text-6xl xl:text-7xl font-borg text-primary leading-none">SHOP</h1>
        <p class="mt-2 text-base sm:text-xl lg:text-2xl font-ethno text-white tracking-wide">
          Precision. Power. Performance.
        </p>
      </div>
    </div>
  </section>

  <section class="max-w-7xl mx-10 px-4">
    <!-- Top Filters (small screens only; hidden on md and up, hidden on xs by default since sm breakpoint is 640px) -->
    <div class="sm:block md:hidden mb-4">
      <div class="flex gap-4 items-start">
        <details class="bg-black/40 border border-white/10 rounded w-1/2">
          <summary class="px-3 py-2 cursor-pointer">Categories</summary>
          <div class="px-3 py-2 space-y-2 max-h-64 overflow-auto">
            <label class="block">
              <input type="radio" name="category" value="" class="mr-2" checked={!currentCategory} />
              All Categories
            </label>
            {categories.map((cat) => (
              <label class="block">
                <input type="radio" name="category" value={cat.slug.current} class="mr-2" checked={currentCategory === cat.slug.current} />
                {cat.title}
              </label>
            ))}
          </div>
        </details>

        <details class="bg-black/40 border border-white/10 rounded w-1/2">
          <summary class="px-3 py-2 cursor-pointer">Filters</summary>
          <div class="px-3 py-2 space-y-2 max-h-64 overflow-auto" id="filters-sm">
            {uniqueFilters.length > 0 ? (
              uniqueFilters.map((tag) => (
                <label class="flex items-center gap-2">
                  <input type="checkbox" value={tag} class="filter-checkbox" checked={selectedFilters.includes(tag)} />
                  <span class="capitalize">{tag}</span>
                </label>
              ))
            ) : (
              <p class="text-sm opacity-70">No filters available.</p>
            )}
          </div>
        </details>
      </div>
      <button id="apply-filters-sm" class="mt-3 px-3 py-1 bg-primary text-black rounded text-sm">Apply</button>
    </div>

    <div class="flex flex-col md:flex-row gap-6 pt-8">
      <aside class="w-full md:w-1/4 md:block hidden border-r border-white/20 pr-4">
        <div id="category-sidebar" class="flex flex-col gap-2">
          <details open class="bg-black/40 border border-white/10 rounded">
            <summary class="px-3 py-2 cursor-pointer">Categories</summary>
            <div class="px-3 py-2 space-y-2">
              <label class="block">
                <input type="radio" name="category-md" value="" class="mr-2" checked={!currentCategory} />
                All Categories
              </label>
              {categories.length > 0 ? (
                categories.map((category) => (
                  <label class="block">
                    <input type="radio" name="category-md" value={category.slug.current} class="mr-2" checked={currentCategory === category.slug.current} />
                    {category.title}
                  </label>
                ))
              ) : (
                <p>No categories available.</p>
              )}
            </div>
          </details>

          <details class="mt-3 bg-black/40 border border-white/10 rounded">
            <summary class="px-3 py-2 cursor-pointer">Filters</summary>
            <div class="px-3 py-2 space-y-2" id="filters-md">
              {uniqueFilters.length > 0 ? (
                uniqueFilters.map((tag) => (
                  <label class="flex items-center gap-2">
                    <input type="checkbox" value={tag} class="filter-checkbox" checked={selectedFilters.includes(tag)} />
                    <span class="capitalize">{tag}</span>
                  </label>
                ))
              ) : (
                <p class="text-sm opacity-70">No filters available.</p>
              )}
            </div>
          </details>

          <button id="apply-filters-md" class="mt-3 px-3 py-1 bg-primary text-black rounded text-sm w-full">Apply</button>
        </div>
      </aside>

      <div class="w-full md:w-3/4">
        <div id="product-grid" class="relative isolation-isolate z-0 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-2 lg:grid-cols-3 gap-10 pt-4">
          {products.length > 0 ? (
            products.map(product => (
              <ProductCard product={product} productImage={product.images?.[0]} />
            ))
          ) : (
            <p>No products found.</p>
          )}
        </div>
      </div>
    </div>

    <div id="pagination" class="flex justify-center mt-12 gap-2">
      {paginationLinks.map(({ label, page }) => {
        const isActive = page === currentPage;
        return (
          <a
            href={`/shop?${(() => {
              const params = new URLSearchParams(url.searchParams);
              params.set('page', page.toString());
              return params.toString();
            })()}`}
            class={`px-3 py-1 rounded-md transition duration-200 text-sm font-bold ${
              isActive ? 'bg-primary text-black shadow-md' : 'bg-black/50 text-white hover:bg-red-600 hover:text-white'
            }`}
          >
            {label}
          </a>
        );
      })}
    </div>
  </section>

  
  <script is:inline>
    (function () {
      function readSelected(name) {
        const el = document.querySelector(`input[name="${name}"]:checked`);
        return (el && 'value' in el) ? /** @type {HTMLInputElement} */ (el).value : '';
      }
      function readChecked(containerId) {
        const box = document.getElementById(containerId);
        if (!box) return [];
        return Array.from(box.querySelectorAll('input.filter-checkbox:checked'))
          .map((i) => /** @type {HTMLInputElement} */ (i).value.toLowerCase())
          .filter(Boolean);
      }
      function apply(from) {
        const params = new URLSearchParams(window.location.search);
        // category
        const cat = from === 'md' ? readSelected('category-md') : readSelected('category');
        if (cat) params.set('categorySlug', cat); else params.delete('categorySlug');
        // filters
        const filters = readChecked(from === 'md' ? 'filters-md' : 'filters-sm');
        if (filters.length) {
          params.set('filters', filters.join(','));
        } else {
          params.delete('filters');
        }
        // reset to page 1
        params.set('page', '1');
        window.location.href = `/shop?${params.toString()}`;
      }
      document.getElementById('apply-filters-sm')?.addEventListener('click', () => apply('sm'));
      document.getElementById('apply-filters-md')?.addEventListener('click', () => apply('md'));
    })();
  </script>

  <style>
    #pagination a:hover {
      color: black !important;
    }

    /* Explicitly set text color to white on hover for category links */
    #category-sidebar a:hover {
      color: #ffffff !important;
    }

    @media (max-width: 768px) {
      #category-sidebar {
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        gap: 1rem;
      }
    }
  </style>
  <script is:inline>
    (function () {
      function showToast(message) {
        try {
          const toast = document.createElement("div");
          toast.textContent = String(message || "Added to cart");
          toast.style.position = "fixed";
          toast.style.bottom = "20px";
          toast.style.right = "20px";
          toast.style.background = "rgba(255,255,255,0.9)"; // match slug page
          toast.style.color = "#16a34a"; // green text to match slug page
          toast.style.padding = "10px 16px";
          toast.style.borderRadius = "6px";
          toast.style.boxShadow = "0 2px 6px rgba(0,0,0,0.3)";
          toast.style.zIndex = "9999";
          document.body.appendChild(toast);
          setTimeout(() => {
            toast.style.transition = "opacity 0.5s";
            toast.style.opacity = "0";
            setTimeout(() => toast.remove(), 500);
          }, 2000);
        } catch {}
      }

      // Expose for other components (e.g., ProductCard) to call if needed
      try { window.showToast = showToast; } catch {}

      // If the product cards dispatch a cart event, echo a toast here too
      window.addEventListener('cartUpdated', (ev) => {
        try {
          const cart = (ev && ev.detail) || [];
          const last = Array.isArray(cart) ? cart[cart.length - 1] : null;
          const name = last && last.name ? last.name : 'Item';
          showToast(`${name} added to cart`);
        } catch {}
      });
    })();
  </script>
</BaseLayout>