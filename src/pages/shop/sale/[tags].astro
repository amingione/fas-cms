---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import ProductGrid from '@/components/storefront/ProductGrid.astro';
import { sanity, normalizeSlugValue, type Product } from '@/lib/sanity-utils';

const tagsParam = Astro.params.tags || '';
const parsedTags = tagsParam
  .split(',')
  .map((tag) => tag.trim().toLowerCase())
  .filter(Boolean);

const includeAll = parsedTags.includes('all');
const tags = includeAll ? [] : parsedTags;
const modeParam = (Astro.url.searchParams.get('mode') || 'or').toLowerCase();
const mode: 'and' | 'or' = modeParam === 'and' ? 'and' : 'or';

let products: Product[] = [];

if (sanity) {
  const filter =
    includeAll || tags.length === 0
      ? 'defined(tags) && count(tags) > 0'
      : mode === 'and'
        ? tags.map((t) => `"${t}" in tags`).join(' && ')
        : `count((tags[])[@ in ${JSON.stringify(tags)}]) > 0`;

  const query = `
    *[_type == "product" && status == "active" && ${filter}]
      | order(featured desc, title asc) {
        _id,
        title,
        displayTitle,
        slug,
        price,
        onSale,
        salePrice,
        compareAtPrice,
        discountPercent,
        discountPercentage,
        saleLabel,
        pricing{
          price,
          salePrice,
          compareAtPrice,
          discountPercentage,
          discountPercent,
          saleStartDate,
          saleEndDate,
          saleLabel,
          saleActive,
          onSale
        },
        tags,
        images[]{ asset->{ _id, url }, alt },
        shortDescription,
        promotionTagline,
        featured
      }
  `;

  const rawProducts = await sanity.fetch<Product[]>(query);
  products = Array.isArray(rawProducts)
    ? rawProducts.map((product) => {
        const slugValue = normalizeSlugValue((product as any)?.slug);
        const normalizedSlug =
          product?.slug && typeof product.slug === 'object'
            ? { ...(product as any).slug, current: slugValue }
            : { current: slugValue };
        return { ...product, slug: normalizedSlug };
      })
    : [];
}

const titleTags = includeAll ? 'All Sale Tags' : tags.join(', ') || 'Sale';
const pageTitle = `Sale: ${titleTags}`;
const pageDescription =
  tags.length === 1
    ? `Shop active products tagged "${tags[0]}" with current sale pricing.`
    : `Shop active products with ${includeAll ? 'any sale tag' : 'these sale tags'}: ${titleTags}.`;
const breadcrumbs = [
  { href: '/', label: 'Home' },
  { href: '/shop', label: 'Shop' },
  { label: pageTitle }
];
---

<BaseLayout title={pageTitle} description={pageDescription} breadcrumbs={breadcrumbs}>
  <section class="px-4 py-10 max-w-6xl mx-auto">
    <div class="mb-6 flex flex-col gap-3 sm:flex-row sm:items-end sm:justify-between">
      <div>
        <p class="text-xs font-semibold uppercase tracking-[0.28em] text-red-200">Sale</p>
        <h1 class="text-3xl font-bold text-white sm:text-4xl">{pageTitle}</h1>
        <p class="text-sm text-zinc-300">{pageDescription}</p>
      </div>
      {products.length === 0 && (
        <div class="text-sm text-red-200">No products found for these sale tags.</div>
      )}
    </div>

    <ProductGrid products={products} view="grid" showQuickView={false} />
  </section>
</BaseLayout>
