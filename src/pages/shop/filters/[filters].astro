---
import ProductCard from "@/components/storefront/ProductCardLite.astro";
import { buildPrimaryKeywordAnchor, collapseLabelSpaces } from '@/lib/seoAnchors';
import { sanityClient as client } from "@/lib/sanityClient.ts";
import BaseLayout from "@/layouts/BaseLayout.astro";

interface Props { params: { filter: string } }
const { params } = Astro as unknown as Props;

// Get the filter document by slug
const filterQuery = /* groq */ `
*[_type == "filter" && slug.current == $slug][0]{
  _id, title, description
}
`;
const filter = await client.fetch(filterQuery, { slug: params.filter });

// Fetch products that reference this filter
const productsQuery = /* groq */ `
*[_type == "product" && !(_id in path('drafts.**')) && (status == "active" || !defined(status)) && coalesce(productType, "") != "service" && defined(slug.current) && references($filterId)] | order(_createdAt desc){
  _id,
  title,
  displayTitle,
  "slug": slug.current,
  "image": coalesce(images[0].asset->url, mainImage.asset->url),
  price,
  onSale,
  salePrice,
  compareAtPrice,
  discountPercent,
  discountPercentage,
  saleStartDate,
  saleEndDate,
  saleLabel,
  saleActive,
  excerpt,
  primaryKeyword,
  fitmentYears,
  fitment,
  "seoPrimaryKeyword": coalesce(seo.primaryKeyword, seo.keyphrase, seo.keyword, seo.targetKeyword),
  "seoFitmentYears": seo.fitmentYears,
  "seoFitment": coalesce(seo.fitmentText, seo.fitment)
}
`;
interface ProductItem {
  _id: string;
  title: string;
  displayTitle?: string;
  slug: string;
  image?: string;
  price?: number;
  onSale?: boolean;
  salePrice?: number;
  compareAtPrice?: number;
  discountPercent?: number;
  discountPercentage?: number;
  saleStartDate?: string;
  saleEndDate?: string;
  saleLabel?: string;
  saleActive?: boolean;
  excerpt?: string;
  primaryKeyword?: string;
  fitmentYears?: unknown;
  fitment?: string;
  seoPrimaryKeyword?: string;
  seoFitmentYears?: unknown;
  seoFitment?: string;
}

const products: ProductItem[] = filter
  ? await client.fetch<ProductItem[]>(productsQuery, { filterId: filter._id })
  : [];

// Adapt to ProductCardLite.astro expected props
type LiteAsset = { url: string };
type LiteImage = { asset: LiteAsset };
type LiteSlug = { current: string };
type LiteProduct = {
  _id: string;
  title?: string;
  displayTitle?: string;
  slug?: LiteSlug | string;
  price?: number;
  onSale?: boolean;
  salePrice?: number;
  compareAtPrice?: number;
  discountPercent?: number;
  discountPercentage?: number;
  saleStartDate?: string;
  saleEndDate?: string;
  saleLabel?: string;
  saleActive?: boolean;
  images?: LiteImage[];
  seoAnchorText?: string;
};

const toAnchorText = (product: ProductItem): string | undefined => {
  const fallbackLabel = product.displayTitle ?? product.title;
  return buildPrimaryKeywordAnchor(
    {
      primaryKeyword: product.primaryKeyword,
      seoPrimaryKeyword: product.seoPrimaryKeyword,
      fitmentYears: product.fitmentYears,
      seoFitmentYears: product.seoFitmentYears,
      fitment: product.fitment,
      seoFitment: product.seoFitment,
      fallbackLabel: fallbackLabel
    },
    fallbackLabel
  );
};

const liteProducts: LiteProduct[] = products.map((p) => ({
  _id: p._id,
  title: p.title,
  displayTitle: p.displayTitle,
  slug: { current: p.slug } as LiteSlug,
  price: p.price,
  onSale: p.onSale,
  salePrice: p.salePrice,
  compareAtPrice: p.compareAtPrice,
  discountPercent: p.discountPercent ?? p.discountPercentage,
  discountPercentage: p.discountPercentage ?? p.discountPercent,
  saleStartDate: p.saleStartDate,
  saleEndDate: p.saleEndDate,
  saleLabel: p.saleLabel,
  saleActive: p.saleActive,
  images: p.image ? [{ asset: { url: p.image } }] : [],
  seoAnchorText: toAnchorText(p)
}));

const requestUrl = new URL(Astro.request.url);
requestUrl.search = '';
requestUrl.hash = '';
const canonicalUrl = requestUrl.toString();

const ensureAbsoluteUrl = (value?: string | null) => {
  if (!value) return undefined;
  if (/^https?:/i.test(value)) return value;
  try {
    return new URL(value, `${requestUrl.origin}/`).toString();
  } catch {
    return undefined;
  }
};

const resolveProductSlug = (product: LiteProduct): string => {
  const rawSlug = product?.slug as any;
  if (typeof rawSlug === 'string') return rawSlug;
  if (rawSlug && typeof rawSlug === 'object' && typeof rawSlug.current === 'string') {
    return rawSlug.current;
  }
  return '';
};

const resolvedFilterTitle = filter?.title ?? 'Filter';
const resolvedFilterDescription =
  typeof filter?.description === 'string' && filter.description.trim()
    ? filter.description.trim()
    : filter
      ? `Products tagged with ${resolvedFilterTitle} curated by F.A.S. Motorsports.`
      : 'Browse performance products curated by F.A.S. Motorsports.';
const resolvedFilterLabel = collapseLabelSpaces(resolvedFilterTitle);
const pageTitle = filter ? `${resolvedFilterLabel} Products` : 'Filter';
const pageDescription = collapseLabelSpaces(resolvedFilterDescription);

const dieselPartsUrl = `${requestUrl.origin}/shop?categorySlug=diesel-parts&page=1`;
const powerstrokeUrl = `${requestUrl.origin}/shop/categories/6-7l-powerstroke`;
const breadcrumbContext = filter
  ? {
      dieselHref: '/shop?categorySlug=diesel-parts&page=1',
      dieselLabel: 'Diesel Parts',
      platformHref: '/shop/categories/6-7l-powerstroke',
      platformLabel: '6.7L Powerstroke',
      currentLabel: resolvedFilterLabel
    }
  : undefined;

const breadcrumbStructuredData = filter
  ? {
      '@context': 'https://schema.org',
      '@type': 'BreadcrumbList',
      itemListElement: [
        { '@type': 'ListItem', position: 1, name: 'Home', item: `${requestUrl.origin}/` },
        { '@type': 'ListItem', position: 2, name: 'Diesel Parts', item: dieselPartsUrl },
        { '@type': 'ListItem', position: 3, name: '6.7L Powerstroke', item: powerstrokeUrl },
        { '@type': 'ListItem', position: 4, name: resolvedFilterLabel, item: canonicalUrl }
      ]
    }
  : null;

const productItemListElements = filter
  ? liteProducts
      .map((product, index) => {
        const slugValue = resolveProductSlug(product);
        if (!slugValue) return null;
        const productUrl = `${requestUrl.origin}/shop/${slugValue}`;
        const images = Array.isArray(product.images)
          ? product.images
              .map((image: LiteImage) => ensureAbsoluteUrl(image?.asset?.url))
              .filter((value): value is string => Boolean(value))
          : [];
        const anchorLabel =
          typeof (product as any)?.seoAnchorText === 'string' && (product as any).seoAnchorText.trim().length > 0
            ? (product as any).seoAnchorText.trim()
            : product.title ?? resolvedFilterLabel;
        const priceNumber = Number(product.price);
        const offers = !Number.isNaN(priceNumber) && priceNumber > 0
          ? {
              '@type': 'Offer',
              priceCurrency: 'USD',
              price: priceNumber.toFixed(2),
              availability: 'https://schema.org/InStock',
              url: productUrl,
              itemCondition: 'https://schema.org/NewCondition'
            }
          : undefined;
        return {
          '@type': 'ListItem',
          position: index + 1,
          url: productUrl,
          item: {
            '@type': 'Product',
            name: anchorLabel,
            image: images.length ? images : undefined,
            offers
          }
        };
      })
      .filter((entry): entry is NonNullable<typeof entry> => Boolean(entry))
  : [];

const filterCollectionStructuredData = filter && productItemListElements.length
  ? {
      '@context': 'https://schema.org',
      '@type': 'CollectionPage',
      name: pageTitle,
      url: canonicalUrl,
      description: pageDescription,
      mainEntity: {
        '@type': 'ItemList',
        name: `${resolvedFilterTitle} products`,
        numberOfItems: productItemListElements.length,
        itemListElement: productItemListElements
      }
    }
  : null;
---
<BaseLayout
  title={pageTitle}
  description={pageDescription}
  canonical={canonicalUrl}
  breadcrumbContext={breadcrumbContext}
>
  {breadcrumbStructuredData && (
    <Fragment slot="head">
      <script is:inline type="application/ld+json" set:html={JSON.stringify(breadcrumbStructuredData)} />
      {filterCollectionStructuredData && (
        <script is:inline type="application/ld+json" set:html={JSON.stringify(filterCollectionStructuredData)} />
      )}
    </Fragment>
  )}
  <div class="max-w-7xl mx-auto px-4 md:px-6 py-12">
{!filter && (
  <section class="py-16 text-center">
    <h1 class="text-3xl font-semibold">Filter not found</h1>
  </section>
)}

{filter && (
  <>
    <header class="mb-8">
      <h1 class="text-3xl md:text-4xl font-semibold">{filter.title}</h1>
      {filter.description && <p class="mt-2 text-sm opacity-80">{filter.description}</p>}
    </header>

    <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6">
      {liteProducts.map((p) => (
        <ProductCard key={p._id} product={p} productImage={p.images?.[0]} />
      ))}
    </section>
  </>
)}
