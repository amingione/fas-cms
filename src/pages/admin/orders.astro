---
import DashboardShell from '../../components/admin/DashboardShell.tsx'
const initial: any[] = [];
---
<DashboardShell client:only="react">
  <h1 class="text-2xl md:text-3xl font-bold mb-6">Orders</h1>
  <div id="orders-root" data-initial={JSON.stringify(initial)}></div>

  <script>
    import React, { useState } from 'react'
    import ReactDOM from 'react-dom/client'
    import OrderDetailDrawer from '@components/admin/OrderDetailDrawer.tsx'

    function OrdersApp(){
      const ordersRoot = document.getElementById('orders-root');
      const initialData = JSON.parse((ordersRoot?.dataset.initial) || '[]');
      const [rows, setRows] = useState(initialData)
      const [open, setOpen] = useState(false)
      const [id, setId] = useState(null)

      async function refresh(){
        const j = await fetch('/.netlify/functions/orders-list', {
          credentials: 'include'
        }).then(r=>r.json())
        const list = Array.isArray(j) ? j : (Array.isArray(j?.data) ? j.data : [])
        setRows(list)
      }

      return (
        React.createElement(React.Fragment, null,
          React.createElement('div', { className:'overflow-x-auto border border-white/20 rounded-lg' },
            React.createElement('table', { className:'min-w-full text-sm' },
              React.createElement('thead', { className:'bg-white/5' }, 
                React.createElement('tr', null, ['Order','# Items','Customer','Status','Total',''].map(h=>React.createElement('th',{className:'text-left px-3 py-2',key:h},h)))
              ),
              React.createElement('tbody', null,
                rows.map((r:any)=>React.createElement('tr',{ key:r._id, className:'border-t border-white/20 hover:bg-white/5 transition' },
                  React.createElement('td',{className:'px-3 py-2'}, r.orderNumber||r._id.slice(-6)),
                  React.createElement('td',{className:'px-3 py-2'}, (r.items||[]).length),
                  React.createElement('td',{className:'px-3 py-2'}, r.customerName||'—'),
                  React.createElement('td',{className:'px-3 py-2'}, r.status||'—'),
                  React.createElement('td',{className:'px-3 py-2'}, `$${Number(r.total||0).toFixed(2)}`),
                  React.createElement('td',{className:'px-3 py-2 text-right'},
                    React.createElement('button',{className:'px-3 py-1 rounded border border-white/30 hover:bg-white/80', onClick:()=>{ setId(r._id); setOpen(true) }}, 'View')
                  )
                ))
              )
            )
          ),
          React.createElement(OrderDetailDrawer, { 
            open: open, 
            onClose: () => setOpen(false), 
            orderId: id ?? '', 
            refresh: refresh 
          })
        )
      )
    }

    const container = document.getElementById('orders-root');
    if (container) {
      ReactDOM.createRoot(container).render(React.createElement(OrdersApp));
    }
  </script>
</DashboardShell>
