---
import DashboardShell from '../../components/admin/DashboardShell.tsx'
import ProductTable from '../../components/admin/ProductTable.tsx'
import ProductEditDrawer from '../../components/admin/ProductEditDrawer.tsx'

const initial = await fetch('/.netlify/functions/products-list').then(r=>r.json()).catch(()=>[])
---
<DashboardShell>
  <h1 class="text-2xl md:text-3xl font-bold mb-4">Products</h1>

  <div class="mb-4 flex items-center justify-between">
    <p class="text-white/70 text-sm">Manage products without opening Sanity.</p>
    <button id="newProductBtn" class="px-4 py-2 rounded bg-white text-black hover:bg-white/90 transition">New Product</button>
  </div>

  <div id="products-root"></div>

  <script is:inline>
    window.__INITIAL_PRODUCTS__ = { data: JSON.parse(`${JSON.stringify(initial)}`) }
  </script>

  <script>
    // Extend the Window interface to include __INITIAL_PRODUCTS__
    declare global {
      interface Window {
        __INITIAL_PRODUCTS__: { data: any }
      }
    }

    import React from 'react'
    import ReactDOM from 'react-dom/client'
    import ProductTable from '../../components/admin/ProductTable.tsx'
    import ProductEditDrawer from '../../components/admin/ProductEditDrawer.tsx'

    let rows = window.__INITIAL_PRODUCTS__.data
    const productsRoot = document.getElementById('products-root')
    if (!productsRoot) throw new Error('products-root element not found')
    const root = ReactDOM.createRoot(productsRoot)
    let drawerRef: any = null

    async function refresh(){
      const res = await fetch('/.netlify/functions/products-list')
      rows = await res.json()
      render()
    }

    function render(){
      root.render(
        React.createElement(React.Fragment, null,
          React.createElement(ProductTable, { rows, refresh }),
          React.createElement(ProductEditDrawer, {
            open:false, onClose:()=>{}, refresh
          })
        )
      )
    }
    render()

    document.getElementById('newProductBtn')?.addEventListener('click', async ()=>{
      const mod = await import('../../components/admin/ProductEditDrawer.tsx')
      const DrawerComp = mod.default
      const mount = document.createElement('div'); document.body.appendChild(mount)
      const r = ReactDOM.createRoot(mount)
      r.render(React.createElement(DrawerComp, { open:true, onClose:()=>r.unmount(), refresh }))
    })
  </script>
</DashboardShell>