---
import DashboardShell from '@components/admin/DashboardShell.tsx'
import Card from '@components/admin/Card.tsx'
import accountAuthUrl from "../../scripts/account-auth.ts?url";
const stats = await fetch('/.netlify/functions/orders-list').then(r=>r.json()).catch(()=>({data:[]}))
const countOrders = stats?.data?.length || 0
---
<DashboardShell>
  <script type="module" src={accountAuthUrl}></script>
  <script>
    (async () => {
      const guard = async () => {
        const fx = window.fasAuth;
        if (!fx) return; // script not ready yet
        if (!(await fx.isAuthenticated())) {
          return fx.loginTo('/admin');
        }
        // Allow either "employee" or "owner" to access /admin
        const ok = await fx.hasRole?.('employee') || await fx.hasRole?.('owner');
        if (location.origin.startsWith('http://localhost:4321')) {
          try {
            const user = await window.fasAuth?.getUser();
            console.debug('[admin] roles claim:',
              user?.['https://login.fasmotorsport.com/fas/roles'] ||
              user?.['https://fasmotorsports.com/roles'] ||
              user?.['https://schemas.quickstarts.auth0.com/roles'] || []
            );
          } catch {}
        }
        if (ok === false) {
          document.body.innerHTML = '<main class="p-8 text-center text-red-400">Forbidden: employee account required.</main>';
        }
      };
      // Retry a couple times in case fasAuth attaches slightly later
      for (let i = 0; i < 3; i++) {
        await guard();
        if (window.fasAuth) break;
        await new Promise(r => setTimeout(r, 150));
      }
    })();
  </script>
  <h1 class="text-2xl md:text-3xl font-bold mb-6">Overview</h1>
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
    <Card title="Orders" value={countOrders} hint="Last 50 shown"/>
    <Card title="Revenue (approx)" value={`$${stats?.data?.reduce((s: number, o: { total?: number }) => s + (o.total || 0), 0).toFixed(2)}`} />
    <Card title="Products" value="—" hint="Visible on Products tab"/>
    <Card title="Customers" value="—" hint="Coming soon"/>
  </div>
</DashboardShell>