---
import DashboardShell from '../../components/admin/DashboardShell.tsx';
// Fetch via internal API to avoid CALCOM key dependency here
type Appointment = {
  eventType?: { title?: string };
  customer?: { name?: string; email?: string };
  customerEmail?: string;
  email?: string;
  startTime: string;
  status?: string;
};
const requestOrigin = new URL(Astro.request.url).origin;
const siteOrigin = Astro.site ? new URL(Astro.site).origin : requestOrigin;
const base = import.meta.env.PUBLIC_BASE_URL || siteOrigin;
let appointments: Appointment[] = [];
try {
  const res = await fetch(`${base}/api/appointments`);
  if (res.ok) appointments = await res.json();
} catch {}
---
<DashboardShell client:only="react">
  <html lang="en">
    <head>
      <title>Admin Appointments | FAS Motorsports</title>
    </head>
    <body class="bg-black text-white p-10 font-cyber">
    <h1 class="text-3xl mb-6">All Booked Appointments</h1>

    {
      appointments?.length > 0 ? (
        <div class="overflow-x-auto border border-white/10 rounded-lg">
          <table class="min-w-full text-sm">
            <thead class="bg-white/5">
              <tr><th class="text-left px-3 py-2">When</th><th class="text-left px-3 py-2">Service</th><th class="text-left px-3 py-2">Customer</th><th class="text-left px-3 py-2">Status</th></tr>
            </thead>
            <tbody>
              {appointments.map((appt: Appointment) => (
                <tr class="border-t border-white/10 hover:bg-white/5 transition">
                  <td class="px-3 py-2">{new Date(appt.startTime).toLocaleString()}</td>
                  <td class="px-3 py-2">{appt.eventType?.title || 'Appointment'}</td>
                  <td class="px-3 py-2">{appt.customer?.name || appt.customer?.email || appt.customerEmail || appt.email || 'â€”'}</td>
                  <td class="px-3 py-2">{appt.status || 'scheduled'}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      ) : (
        <p>No appointments found.</p>
      )
    }
  </body>
</html>
</DashboardShell>
