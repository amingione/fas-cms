---
import BaseLayout from '@/layouts/BaseLayout.astro';
import ProductGrid from '@/components/storefront/ProductGrid.astro';
import { sanity, normalizeSlugValue, type Product } from '@/lib/sanity-utils.ts';
import { getSavingsAmount } from '@/lib/saleHelpers';
import { Banner } from '@/components/banner/imgBanner.tsx';

const saleTag = 'cyber-monday';

let saleProducts: Product[] = [];
if (sanity) {
  const query = `
    *[_type == "product" && status == "active" && "${saleTag}" in tags]
      | order(featured desc, title asc) {
        _id,
        title,
        displayTitle,
        slug,
        price,
        onSale,
        salePrice,
        compareAtPrice,
        discountPercent,
        discountPercentage,
        saleLabel,
        pricing{
          price,
          salePrice,
          compareAtPrice,
          discountPercentage,
          discountPercent,
          saleStartDate,
          saleEndDate,
          saleLabel,
          saleActive,
          onSale
        },
        tags,
        images[]{ asset->{ _id, url }, alt },
        shortDescription,
        promotionTagline,
        featured
      }
  `;

  const rawSaleProducts = await sanity.fetch<Product[]>(query);
  saleProducts = (Array.isArray(rawSaleProducts) ? rawSaleProducts : []).map((product) => {
    const slugValue = normalizeSlugValue((product as any)?.slug);

    const normalizedSlug =
      typeof product?.slug === 'object' && product?.slug !== null
        ? { ...(product as any).slug, current: slugValue }
        : { current: slugValue };

    return {
      ...product,
      slug: normalizedSlug
    };
  });
}

const hasSales = saleProducts.length > 0;
const maxDiscount = hasSales
  ? saleProducts.reduce(
      (max, product) =>
        Math.max(
          max,
          Number(
            (product as any)?.discountPercent ??
              (product as any)?.discountPercentage ??
              (product as any)?.pricing?.discountPercentage ??
              0
          ) || 0
        ),
      0
    )
  : 0;
const maxSavings = hasSales
  ? saleProducts.reduce(
      (max, product) => Math.max(max, getSavingsAmount(product) || (product as any)?.savings || 0),
      0
    )
  : 0;

const pageTitle = 'Cyber Monday Sale';
const pageDescription = hasSales
  ? `Save up to ${maxDiscount}% on ${saleProducts.length} performance parts and install packages at F.A.S. Motorsports. Limited-time Cyber Monday pricing with the biggest discounts first.`
  : 'Shop Cyber Monday performance parts, install packages, and custom builds from F.A.S. Motorsports.';
const pageKeywords = [
  'Cyber Monday performance parts',
  'F.A.S. Motorsports sale',
  'performance packages',
  'install specials',
  'Hellcat upgrades',
  'Trackhawk upgrades'
];
const ogImage = '/images/sales/cyberMondayBanner.png';
const breadcrumbs = [{ href: '/', label: 'Home' }, { label: 'Cyber Monday Sale' }];
---

<BaseLayout
  title={pageTitle}
  description={pageDescription}
  keywords={pageKeywords}
  canonical="/cyberMonday"
  ogImage={ogImage}
  breadcrumbs={breadcrumbs}
>
  <section>
    <Banner
      imageUrl="/images/sales/cyberMondayBanner.png"
      title="Cyber Monday Sale"
      subtitle="10% off our Best Selling Performance Parts & Packages"
    />
  </section>

  {
    hasSales && (
      <section class="relative border-y border-white/5 bg-gradient-to-b from-black via-zinc-950 to-black">
        <div class="absolute inset-x-0 top-0 h-px bg-gradient-to-r from-transparent via-red-500/40 to-transparent" />
        <div class="mx-auto max-w-6xl px-4 py-14 sm:py-16">
          <div class="flex flex-col gap-4 sm:flex-row sm:items-end sm:justify-between">
            <div class="space-y-2">
              <p class="text-xs font-semibold uppercase tracking-[0.28em] text-red-200">
                Cyber Monday Deals
              </p>
              <h2 class="text-3xl font-bold text-white sm:text-4xl">SALE</h2>
              <p class="hidden max-w-2xl text-sm text-zinc-300">
                {maxDiscount > 0
                  ? `Save up to ${maxDiscount}% on ${saleProducts.length} products, sorted by the biggest discounts first.`
                  : `Limited-time pricing on ${saleProducts.length} products, sorted by the biggest discounts first.`}{' '}
                {maxSavings > 0 ? ` Top savings: $${maxSavings.toFixed(2)} off.` : ''}
              </p>
            </div>
          </div>

          <div class="mt-8">
            <ProductGrid products={saleProducts} view="grid" showQuickView={false} />
          </div>
        </div>
      </section>
    )
  }
</BaseLayout>
