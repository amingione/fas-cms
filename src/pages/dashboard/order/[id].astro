---
import BaseLayout from '@/layouts/BaseLayout.astro';
import { sanityClient } from '@/lib/sanityClient.ts';
import { optimizeSanityImageUrl } from '@/lib/sanity-utils.ts';
import { readSession } from '@/server/auth/session.ts';
import { formatPrice } from '@/components/storefront/Price.tsx';

interface ShippingLogEntry {
  status?: string;
  message?: string;
  trackingNumber?: string;
  createdAt?: string;
  trackingUrl?: string;
}

interface OrderItem {
  _key?: string;
  id?: string;
  name?: string;
  price?: number;
  quantity?: number;
  description?: string;
  upgrades?: string[] | string;
  optionSummary?: string;
  optionDetails?: string[];
  imageUrl?: string;
  productUrl?: string;
  href?: string;
  status?: string;
  deliveryStatus?: string;
}

const { params, request } = Astro;
const orderId = params.id;

let order: any = null;
let error: string | null = null;

function normalizeMoney(value: unknown, currency: string): string {
  if (typeof value === 'number' && Number.isFinite(value)) {
    return formatPrice(value, currency);
  }
  const numeric = Number(value);
  if (!Number.isNaN(numeric) && Number.isFinite(numeric)) {
    return formatPrice(numeric, currency);
  }
  return '—';
}

function formatDate(date: Date) {
  try {
    return date.toLocaleDateString(undefined, {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });
  } catch {
    return '';
  }
}

function normalizeValueList(input: unknown): string[] {
  if (!input) return [];
  if (Array.isArray(input)) return input.map((entry) => String(entry)).filter(Boolean);
  if (typeof input === 'string') {
    return input
      .split(/[,•]/)
      .map((part) => part.trim())
      .filter(Boolean);
  }
  return [];
}

const FALLBACK_IMAGE = '/logo/faslogo150.webp';
const imageCache = new Map<string, string>();

const resolveImageUrl = (item: OrderItem): string => {
  const cacheKey = item?._key || item?.name || '';
  if (cacheKey && imageCache.has(cacheKey)) {
    return imageCache.get(cacheKey)!;
  }
  const raw = item?.imageUrl;
  const resolved = raw ? (optimizeSanityImageUrl(raw) ?? raw) : FALLBACK_IMAGE;
  if (cacheKey) imageCache.set(cacheKey, resolved);
  return resolved;
};

try {
  if (!orderId) {
    throw new Error('Missing order id');
  }

  const { session } = await readSession(request);
  const sessionEmail = (session?.user?.email as string | undefined)?.toLowerCase().trim() || '';

  if (!sessionEmail) {
    throw new Error('You must be signed in to view orders.');
  }

  const query = `*[_type == "order" && _id == $id][0]{
    _id,
    orderNumber,
    status,
    paymentStatus,
    _createdAt,
    createdAt,
    fulfilledAt,
    amountSubtotal,
    amountTax,
    amountShipping,
    totalAmount,
    total,
    currency,
    trackingNumber,
    shippingCarrier,
    shippingLabelUrl,
    selectedService{
      carrier,
      service,
      serviceCode
    },
    shippingAddress,
    cardBrand,
    cardLast4,
    receiptUrl,
    customerEmail,
    customerRef->{
      email,
      firstName,
      lastName,
      phone
    },
    customer->{
      email,
      firstName,
      lastName,
      phone
    },
    shippingLog[]{
      status,
      message,
      trackingNumber,
      trackingUrl,
      createdAt
    },
    cart[]{
      _key,
      name,
      price,
      quantity,
      description,
      upgrades,
      optionSummary,
      optionDetails,
      productUrl,
      href,
      status,
      deliveryStatus,
      metadata,
      "imageUrl": coalesce(
        image.asset->url,
        image,
        metadata.product_image,
        product->image.asset->url,
        product->images[0].asset->url
      ),
      "productUrl": select(
        defined(product->slug.current) => "/shop/" + product->slug.current,
        productUrl,
        href
      )
    },
    invoiceRef->{
      invoiceNumber,
      invoicePdfUrl,
      paymentLinkUrl,
      total
    }
  }`;

  order = await sanityClient.fetch(query, { id: orderId });

  if (!order) {
    throw new Error('Order not found.');
  }

  const emails: string[] = [];
  if (typeof order.customerEmail === 'string') emails.push(order.customerEmail.toLowerCase());
  if (order.customer?.email) emails.push(String(order.customer.email).toLowerCase());
  if (order.customerRef?.email) emails.push(String(order.customerRef.email).toLowerCase());

  if (!emails.includes(sessionEmail)) {
    throw new Error('You do not have access to this order.');
  }
} catch (err: any) {
  console.error('Order detail error:', err?.message || err);
  error = err?.message || 'Unable to load order details.';
}

const currency = (order?.currency || 'USD').toUpperCase();
const displaySubtotal = normalizeMoney(order?.amountSubtotal, currency);
const displayShipping = normalizeMoney(order?.amountShipping, currency);
const displayTax = normalizeMoney(order?.amountTax, currency);
const displayTotal = normalizeMoney(order?.total ?? order?.totalAmount, currency);

const shippingAddress = order?.shippingAddress ?? {};
const addressLines = [
  shippingAddress?.name,
  shippingAddress?.company,
  shippingAddress?.street || shippingAddress?.addressLine1,
  shippingAddress?.addressLine2,
  [
    shippingAddress?.city,
    shippingAddress?.state || shippingAddress?.region,
    shippingAddress?.postalCode
  ]
    .filter(Boolean)
    .join(', '),
  shippingAddress?.country
].filter((line: any) => typeof line === 'string' && line.trim() !== '');

const shippingLog: ShippingLogEntry[] = Array.isArray(order?.shippingLog) ? order.shippingLog : [];

function determineStep(): number {
  const status = String(order?.status || '').toLowerCase();
  let step = 0;
  if (status.includes('processing') || status.includes('confirmed') || status.includes('paid')) {
    step = Math.max(step, 1);
  }
  const hasShipUpdate = shippingLog.some((entry) =>
    String(entry?.status || entry?.message || '')
      .toLowerCase()
      .includes('ship')
  );
  if (hasShipUpdate || status.includes('ship')) {
    step = Math.max(step, 2);
  }
  if (status.includes('deliver') || status.includes('complete')) {
    step = Math.max(step, 3);
  }
  return step;
}

const progressStep = determineStep();
const progressPercent = `calc((${progressStep} * 2 + 1) / 8 * 100%)`;

const paymentSummary = order?.cardBrand
  ? `${String(order.cardBrand).toUpperCase()} •••• ${order.cardLast4 || ''}`
  : 'Card on file';
const paymentExpiry = order?.cardExp ? String(order.cardExp) : '';
const invoiceUrl =
  order?.invoiceRef?.invoicePdfUrl || order?.invoiceRef?.paymentLinkUrl || order?.receiptUrl || '';

const pageTitle = order ? `Order ${order.orderNumber || order._id}` : 'Order Details';
const canonical = `${new URL(Astro.request.url).origin}/dashboard/order/${orderId}`;
const breadcrumbItems = [
  { href: '/dashboard', label: 'Dashboard' },
  { href: '/dashboard#orders', label: 'Orders' },
  { label: pageTitle }
];
---

<BaseLayout
  title={pageTitle}
  canonical={canonical}
  hideBrandTag={true}
  breadcrumbs={breadcrumbItems}
>
  <main class="bg-dark text-white">
    <div class="mx-auto max-w-6xl px-6 py-14 sm:py-18 lg:px-10">
      {
        error ? (
          <div class="rounded-2xl border border-red-500/40 bg-red-500/10 p-6 text-sm text-red-200">
            {error}
          </div>
        ) : (
          <>
            <header class="flex flex-col gap-4 border-b border-white/10 pb-8 sm:flex-row sm:items-center sm:justify-between">
              <div>
                <h1 class="text-3xl font-semibold tracking-tight text-white">
                  Order {order.orderNumber || order._id}
                </h1>
                <p class="mt-2 text-sm text-white/60">
                  Placed{' '}
                  <time datetime={order.createdAt || order._createdAt}>
                    {formatDate(new Date(order.createdAt || order._createdAt))}
                  </time>
                </p>
              </div>
              <div class="flex flex-wrap items-center gap-3">
                <a
                  href="/dashboard#orders"
                  class="inline-flex items-center justify-center rounded-full border border-white/20 px-4 py-2 text-xs font-semibold uppercase tracking-wide text-white hover:border-primary hover:text-primary"
                >
                  Back to orders
                </a>
                {invoiceUrl && (
                  <a
                    href={invoiceUrl}
                    target="_blank"
                    rel="noopener"
                    class="inline-flex items-center justify-center rounded-full border border-white/20 px-4 py-2 text-xs font-semibold uppercase tracking-wide text-white hover:border-primary hover:text-primary"
                  >
                    View Invoice
                    <span aria-hidden="true" class="ml-2">
                      →
                    </span>
                  </a>
                )}
              </div>
            </header>

            <section class="mt-12 space-y-16">
              <div>
                <h2 class="sr-only">Purchased items</h2>
                <div class="space-y-12">
                  {(order?.cart as OrderItem[] | undefined)?.map((item) => {
                    const image = resolveImageUrl(item);
                    const itemPrice = normalizeMoney(item?.price, currency);
                    const itemStatus =
                      item?.status ||
                      item?.deliveryStatus ||
                      (shippingLog.length ? shippingLog[shippingLog.length - 1]?.status : '');
                    const upgrades = normalizeValueList(item?.upgrades).join(' • ');
                    const options = item?.optionSummary || (item?.optionDetails || []).join(' • ');
                    return (
                      <article class="grid grid-cols-1 gap-8 rounded-2xl border border-white/10 bg-white/5 p-6 sm:grid-cols-12 sm:gap-6 lg:gap-8">
                        <div class="sm:col-span-4 lg:col-span-5">
                          <img
                            src={image || FALLBACK_IMAGE}
                            alt={item?.name || 'Order item'}
                            class="aspect-square w-full rounded-lg bg-dark/30 object-cover"
                            loading="lazy"
                          />
                        </div>
                        <div class="flex flex-col gap-6 sm:col-span-8 lg:col-span-7">
                          <header class="space-y-2">
                            <h3 class="text-xl font-semibold text-white">
                              {item?.productUrl ? (
                                <a href={item.productUrl} class="hover:text-primary">
                                  {item?.name || 'Item'}
                                </a>
                              ) : (
                                item?.name || 'Item'
                              )}
                            </h3>
                            <p class="text-base font-semibold text-white/80">
                              {itemPrice !== '—' ? itemPrice : ''}
                            </p>
                            {item?.description && (
                              <p class="text-sm text-white/60">{item.description}</p>
                            )}
                            {(options || upgrades) && (
                              <p class="text-xs uppercase tracking-wide text-white/50">
                                {[options, upgrades ? `${upgrades}` : '']
                                  .filter(Boolean)
                                  .join(' • ')}
                              </p>
                            )}
                          </header>
                          <div class="space-y-2 rounded-xl border border-white/10 bg-dark/40 p-4 text-sm text-white/70">
                            <div class="flex flex-wrap items-center gap-3">
                              <span class="font-semibold text-white">Quantity:</span>
                              <span>{item?.quantity ?? 1}</span>
                            </div>
                            {itemStatus && (
                              <div class="flex flex-wrap items-center gap-3">
                                <span class="font-semibold text-white">Status:</span>
                                <span>{itemStatus}</span>
                              </div>
                            )}
                          </div>
                          <div>
                            <p class="text-xs font-semibold uppercase tracking-wide text-white/60">
                              Fulfillment progress
                            </p>
                            <div class="mt-3 overflow-hidden rounded-full bg-white/10">
                              <div
                                class="h-2 rounded-full bg-primary transition-all"
                                style={`width: ${progressPercent};`}
                              />
                            </div>
                            <div class="mt-4 grid grid-cols-4 text-xs font-semibold uppercase tracking-wide text-white/60">
                              <span class={`text-left ${progressStep >= 0 ? 'text-primary' : ''}`}>
                                Order placed
                              </span>
                              <span
                                class={`${progressStep >= 1 ? 'text-primary' : ''} text-center`}
                              >
                                Processing
                              </span>
                              <span
                                class={`${progressStep >= 2 ? 'text-primary' : ''} text-center`}
                              >
                                Shipped
                              </span>
                              <span class={`${progressStep >= 3 ? 'text-primary' : ''} text-right`}>
                                Delivered
                              </span>
                            </div>
                          </div>
                        </div>
                      </article>
                    );
                  })}
                </div>
              </div>

              <div class="grid grid-cols-1 gap-8 lg:grid-cols-12 lg:gap-10">
                <section class="rounded-2xl border border-white/10 bg-white/5 p-6 text-sm text-white/70 lg:col-span-5">
                  <h2 class="text-base font-semibold text-white">Shipping Address</h2>
                  <address class="mt-4 not-italic space-y-1">
                    {addressLines.map((line) => (
                      <span class="block">{line}</span>
                    ))}
                  </address>
                  <div class="mt-6 space-y-2">
                    <h3 class="text-sm font-semibold text-white">Shipping Updates</h3>
                    <p class="text-white/60">
                      {shippingAddress?.email || order?.customerEmail || '—'}
                    </p>
                    <p class="text-white/60">
                      {shippingAddress?.phone ||
                        order?.customer?.phone ||
                        order?.customerRef?.phone ||
                        '—'}
                    </p>
                    <a
                      href="mailto:sales@fasmotorsports.com"
                      class="inline-flex items-center text-xs font-semibold uppercase tracking-wide text-primary hover:text-primary/80"
                    >
                      Contact support
                    </a>
                  </div>
                </section>

                <section class="rounded-2xl border border-white/10 bg-white/5 p-6 text-sm text-white/70 lg:col-span-7">
                  <h2 class="text-base font-semibold text-white">Billing Summary</h2>
                  <dl class="mt-4 space-y-3">
                    <div class="flex items-center justify-between">
                      <dt class="text-white/50">Subtotal</dt>
                      <dd class="font-semibold text-white">{displaySubtotal}</dd>
                    </div>
                    <div class="flex items-center justify-between">
                      <dt class="text-white/50">Shipping</dt>
                      <dd class="font-semibold text-white">{displayShipping}</dd>
                    </div>
                    <div class="flex items-center justify-between">
                      <dt class="text-white/50">Tax</dt>
                      <dd class="font-semibold text-white">{displayTax}</dd>
                    </div>
                    <div class="flex items-center justify-between border-t border-white/10 pt-3">
                      <dt class="text-base font-semibold text-white">Order total</dt>
                      <dd class="text-base font-semibold text-primary">{displayTotal}</dd>
                    </div>
                  </dl>
                  <div class="mt-6 space-y-2">
                    <h3 class="text-sm font-semibold text-white">Payment information</h3>
                    <p class="text-white/70">
                      {paymentSummary}
                      {paymentExpiry ? ` • Expires ${paymentExpiry}` : ''}
                    </p>
                    {order?.receiptUrl && (
                      <a
                        href={order.receiptUrl}
                        target="_blank"
                        rel="noopener"
                        class="inline-flex items-center text-xs font-semibold uppercase tracking-wide text-primary hover:text-primary/80"
                      >
                        View Stripe receipt
                      </a>
                    )}
                  </div>
                </section>
              </div>

              {shippingLog.length > 0 && (
                <section class="rounded-2xl border border-white/10 bg-white/5 p-6">
                  <h2 class="text-base font-semibold text-white">Shipping updates</h2>
                  <ul class="mt-4 space-y-3 text-sm text-white/70">
                    {shippingLog.map((entry) => (
                      <li class="rounded-lg border border-white/10 bg-dark/40 p-4">
                        <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                          <div>
                            <span class="font-semibold text-white">{entry.status || 'Update'}</span>
                            {entry.message && <p class="text-white/60">{entry.message}</p>}
                            {entry.trackingNumber && (
                              <p class="text-xs text-white/50">Tracking: {entry.trackingNumber}</p>
                            )}
                          </div>
                          {entry.createdAt && (
                            <time class="text-xs text-white/60" datetime={entry.createdAt}>
                              {formatDate(new Date(entry.createdAt))}
                            </time>
                          )}
                        </div>
                        {entry.trackingUrl && (
                          <a
                            href={entry.trackingUrl}
                            target="_blank"
                            rel="noopener"
                            class="mt-3 inline-flex text-xs font-semibold uppercase tracking-wide text-primary hover:text-primary/80"
                          >
                            Track package
                          </a>
                        )}
                      </li>
                    ))}
                  </ul>
                </section>
              )}
            </section>
          </>
        )
      }
    </div>
  </main>
</BaseLayout>
