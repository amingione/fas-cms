---
import BaseLayout from "../layouts/BaseLayout.astro";

// Simple auth guard: if no session or token cookie, redirect to /account
const cookie = Astro.request.headers.get('cookie') || '';
const readCookie = (name: string) => {
  const m = new RegExp(`(?:^|;\\s*)${name}=([^;]+)`).exec(cookie);
  return m?.[1] || null;
};
const hasSession = Boolean(readCookie('session'));
const hasToken = Boolean(readCookie('token'));
if (!hasSession && !hasToken) {
  return Astro.redirect('/account');
}
---

<BaseLayout>
 
  <style>
    @media (max-width: 639px) {
      [data-desktop-dash] { display: none !important; }
      [data-mobile-dash] { display: block !important; }
    }
    @media (min-width: 640px) {
      [data-mobile-dash] { display: none !important; }
    }

    /* --- Clickability guard: ensure dashboard UI is above any global overlays and accepts clicks --- */
    [data-mobile-dash],
    [data-desktop-dash] {
      position: relative;
      z-index: 50; /* higher than typical site headers/overlays */
    }
    /* Make sure interactive elements always receive pointer events even if an ancestor disables them */
    [data-dash-content],
    .js-view,
    #mobile-account-select,
    .logout-link,
    a,
    button,
    select {
      pointer-events: auto !important;
    }
  </style>
  <!-- MOBILE DASHBOARD (auto on <640px) -->
  <main data-mobile-dash class="block sm:hidden min-h-screen pt-20 pb-24 px-4 text-white">
    <header class="mb-6">
      <h1 class="text-lg font-ethno">My Account</h1>
      <p class="opacity-80 text-sm">Welcome, <span id="customer-name-mobile" class="text-primary"></span></p>
    </header>

    <!-- Simple dropdown menu -->
    <div class="mb-4">
      <label for="mobile-account-select" class="sr-only">Choose a section</label>
      <select id="mobile-account-select" class="w-full bg-white/5 border border-white/15 rounded-lg px-3 py-2 text-sm">
        <option value="dashboard" selected>Dashboard</option>
        <option value="orders">Orders</option>
        <option value="quotes">Quotes</option>
        <option value="invoices">Invoices</option>
        <option value="appointments">Appointments</option>
        <option value="details">Account details</option>
      </select>
    </div>

    <!-- Intro copy -->
    <section class="mb-6 space-y-1">
      <h1 class="text-3xl mr-20 pr-10 font-borg text-primary text-left mb-2">F.a.S.</h1>
      <h1 class="text-2xl font-ethno text-white pr-10 mr-20 text-left mb-6">Motorsports</h1>
      <h3 class="font-cyber-italic text-sm tracking-wide opacity-90">ACCOUNT DASHBOARD</h3>
      <p class="text-xs opacity-80">Welcome to your account dashboard. Use the menu to view your profile, orders, and more.</p>
    </section>

    <!-- Content area -->
    <section id="dash-content-mobile" data-dash-content class="mt-6 text-sm"></section>
  </main>

  <!-- DESKTOP DASHBOARD (auto on >=640px) -->
  <main data-desktop-dash class="hidden sm:flex min-h-screen pt-10 overflow-hidden text-white font-captain">
    <!-- Sidebar -->
    <aside class="bg-black/70 border-white/10 p-0 border-r mt-12 pt-10 mb-3 mx-3 w-64 space-y-6">
     <p class="uppercase">Welcome, <span id="customer-name" class="text-primary"></span></p>
      <nav class="mt-6 pt-5 space-y-3 text-base font-ethno">
        <a href="#" data-view="profile" class="js-view block hover:text-red-500">My Profile</a>
        <a href="#" data-view="orders" class="js-view block hover:text-red-500">Orders <span id="orders-count" class="ml-2 px-2 py-0.5 text-xs bg-red-600/80 rounded">0</span></a>
        <a href="#" data-view="quotes" class="js-view block hover:text-red-500">Quotes <span id="quotes-count" class="ml-2 px-2 py-0.5 text-xs bg-red-600/80 rounded">0</span></a>
        <a href="#" data-view="invoices" class="js-view block hover:text-red-500">Invoices <span id="invoices-count" class="ml-2 px-2 py-0.5 text-xs bg-red-600/80 rounded">0</span></a>
        <a href="#" data-view="appointments" class="js-view block hover:text-red-500">Appointments <span id="appts-count" class="ml-2 px-2 py-0.5 text-xs bg-red-600/80 rounded">0</span></a>
        <a href="/api/auth/logout" class="logout-link block pt-10 text-red-600 hover:underline mt-4">Logout</a>
      </nav>
    </aside>

    <!-- Main panel -->
    <section class="relative flex-auto content-start mt-10 p-20">
      <h1 class="text-3xl mr-20 pr-10 font-borg text-primary text-left mb-2">F.a.S.</h1>
      <h1 class="text-2xl font-ethno text-white pr-10 mr-20 text-left mb-6">Motorsports</h1>
      <h2 class="text-base pr-12 mr-10 font-cyber-italic text-left mb-6">ACCOUNT DASHBOARD</h2>
      <div id="dash-content-desktop" data-dash-content class="text-left text-base"></div>
    </section>
  </main>

  <script type="module" src="/scripts/dashboard-page.ts"></script>
  <!-- inlined script moved to src/scripts/dashboard-page.ts -->

    <!-- All dashboard logic is now handled in src/scripts/dashboard-page.ts -->
  
</BaseLayout>
