---
import BaseLayout from '@/layouts/BaseLayout.astro';
import PortableTextRenderer from '@/components/PortableTextRenderer.jsx';
import { sanityFetch } from '@/lib/sanityFetch';

type ConsentResource = {
  title?: string;
  content?: unknown;
  description?: string;
  category?: string;
  accessLevel?: string;
  formUrl?: string;
  externalUrl?: string;
  fileUrl?: string;
};

const resourceQuery = `*[_type == "downloadResource" && slug.current == "employee-sms-consent"][0]{
  title,
  content,
  description,
  category,
  accessLevel,
  formUrl,
  externalUrl,
  "fileUrl": file.asset->url
}`;

let resource: ConsentResource | null = null;

try {
  resource = await sanityFetch<ConsentResource>({ query: resourceQuery });
} catch (error) {
  console.error('Failed to load employee SMS consent resource', error);
}

const pageTitle = resource?.title ?? 'Employee SMS Consent';
const descriptionText = typeof resource?.description === 'string' ? resource.description : '';
const pageDescription =
  descriptionText ||
  'Opt in to receive SMS alerts for new orders, quote submissions, appointments, and customer or vendor messages.';
const formUrl =
  resource?.fileUrl ??
  resource?.formUrl ??
  resource?.externalUrl ??
  'https://cdn.sanity.io/files/r4og35qd/production/3d49761ea25f0b5ffe5e6ecd7f82505f6f15c19d.pdf';
const contentBlocks = Array.isArray(resource?.content) ? resource?.content : null;
const contentString = typeof resource?.content === 'string' ? resource.content : '';
---

<BaseLayout title={pageTitle} description={pageDescription}>
  <section class="mx-auto max-w-4xl px-6 py-12 text-white">
    <p class="text-sm font-mono uppercase tracking-wide text-white/60">Internal alert routing</p>
    <h1 class="mt-2 text-3xl font-ethno text-primary">{pageTitle}</h1>
    <p class="mt-4 text-base font-mono leading-relaxed text-white/80">
      Confirm that we can text you with time-sensitive Sanity notifications. Messages are limited to
      operational updates and only go to enrolled team members.
    </p>

    <p class="mt-3 text-sm font-mono leading-relaxed text-white/70">
      By submitting this consent, you agree to receive SMS messages from F.A.S. Motorsports for
      internal operational notifications. Message frequency varies. Messages are transactional and
      not used for marketing or promotional purposes.
    </p>

    <p class="mt-2 text-sm font-mono leading-relaxed text-white/70">
      You may opt out at any time by replying STOP. For assistance, reply HELP or contact
      <a href="mailto:support@fasmotorsports.com" class="underline text-white">
        support@fasmotorsports.com
      </a>.
    </p>

    <p class="mt-2 text-sm font-mono leading-relaxed text-white/60">
      View our Privacy Policy at
      <a
        href="https://www.fasmotorsports.com/privacypolicy"
        class="underline text-white"
        target="_blank"
        rel="noopener noreferrer"
      >
        https://www.fasmotorsports.com/privacypolicy
      </a>.
    </p>

    <div class="mt-8 rounded border border-white/10 bg-dark/40 p-6 shadow-inner shadow-white/10">
      <h2 class="text-lg font-ethno text-accent">What you will receive</h2>
      <ul class="mt-3 list-disc space-y-2 pl-5 font-mono text-white/80">
        <li>New orders placed</li>
        <li>New quote submissions</li>
        <li>New appointments scheduled</li>
        <li>New customer or vendor messages received</li>
      </ul>
      {
        resource?.accessLevel && (
          <p class="mt-4 text-xs font-mono uppercase tracking-wide text-white/50">
            Access level: {resource.accessLevel}
          </p>
        )
      }
    </div>
  </section>

  {
    contentBlocks ? (
      <section class="mx-auto max-w-4xl px-6 pb-10 space-y-6">
        {descriptionText && (
          <div class="rounded border border-white/10 bg-dark/40 p-6 text-base font-mono leading-relaxed text-white/80">
            {descriptionText}
          </div>
        )}
        <div class="prose prose-invert max-w-none prose-headings:text-white prose-strong:text-white">
          <PortableTextRenderer value={contentBlocks} />
        </div>
      </section>
    ) : (
      (descriptionText || contentString) && (
        <section class="mx-auto max-w-4xl px-6 pb-10 space-y-4">
          {descriptionText && (
            <div class="rounded border border-white/10 bg-dark/40 p-6 text-base font-mono leading-relaxed text-white/80">
              {descriptionText}
            </div>
          )}
          {contentString && (
            <div class="rounded border border-white/10 bg-dark/40 p-6 text-base font-mono leading-relaxed text-white/80">
              {contentString}
            </div>
          )}
        </section>
      )
    )
  }

  <section class="mx-auto max-w-4xl px-6 pb-12">
    <form
      id="sms-consent-form"
      class="mt-8 space-y-4 rounded border border-white/10 bg-dark/40 p-6 font-mono text-white"
    >
      <h2 class="text-lg font-ethno text-accent">Submit SMS Consent</h2>

      <div>
        <label class="block text-sm text-white/70">Full Name</label>
        <input
          required
          name="full_name"
          class="mt-1 w-full rounded bg-black/40 border border-white/20 p-2"
        />
      </div>

      <div>
        <label class="block text-sm text-white/70">Mobile Phone Number</label>
        <input
          required
          name="mobile_number"
          type="tel"
          placeholder="+1XXXXXXXXXX"
          class="mt-1 w-full rounded bg-black/40 border border-white/20 p-2"
        />
      </div>

      <div>
        <label class="block text-sm text-white/70">Work Email</label>
        <input
          required
          name="email"
          type="email"
          class="mt-1 w-full rounded bg-black/40 border border-white/20 p-2"
        />
      </div>

      <div class="rounded border border-white/15 bg-black/30 p-4 text-sm text-white/80">
        <strong>SMS Consent Acknowledgment</strong>
        <p class="mt-2">
          I consent to receive SMS messages from F.A.S. Motorsports for internal operational
          notifications, including new orders, vendor or customer messages, appointment requests,
          and system alerts. Message frequency varies. Messages are not marketing or promotional. I
          may opt out at any time by replying STOP. For help, reply HELP or contact
          support@fasmotorsports.com.
        </p>
      </div>

      <label class="flex items-start gap-2 text-sm">
        <input required type="checkbox" name="sms_consent_acknowledged" />
        <span>I agree and consent to receive internal SMS notifications.</span>
      </label>

      <button type="submit" class="mt-4 rounded bg-primary px-6 py-2 text-black font-semibold">
        Submit Consent
      </button>

      <p id="sms-consent-status" class="hidden text-sm font-mono text-white/70"></p>
    </form>

    <script>
      const formEl = document.getElementById('sms-consent-form');
      const statusEl = document.getElementById('sms-consent-status');

      if (!(formEl instanceof HTMLFormElement) || !(statusEl instanceof HTMLElement)) {
        console.warn('SMS consent form elements not found');
      } else {
        formEl.addEventListener('submit', async (e) => {
          e.preventDefault();
          statusEl.classList.add('hidden');

          const formData = new FormData(formEl);
          const payload: Record<string, any> = {};

          for (const [key, value] of formData as any) {
            payload[key] = value;
          }

          try {
            const res = await fetch('/.netlify/functions/employee-sms-consent', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });

            if (res.ok) {
              statusEl.textContent = 'Consent submitted successfully.';
              statusEl.classList.remove('hidden');
              formEl.reset();
            } else {
              statusEl.textContent = 'Failed to submit consent. Please try again.';
              statusEl.classList.remove('hidden');
            }
          } catch (err) {
            statusEl.textContent = 'Submission error. Please try again.';
            statusEl.classList.remove('hidden');
          }
        });
      }
    </script>
  </section>

  <section class="mx-auto max-w-5xl px-6 pb-16">
    {
      formUrl ? (
        <div class="rounded border border-white/10 bg-dark/40 p-6 font-mono text-white shadow-inner shadow-white/10">
          <h2 class="text-lg font-ethno text-accent">Printable Consent Form</h2>
          <p class="mt-3 text-sm text-white/80">
            If you prefer to complete a paper copy, you may download or open the printable PDF
            consent form below.
          </p>

          <a
            href={formUrl}
            target="_blank"
            rel="noopener noreferrer"
            class="mt-4 inline-flex items-center gap-2 rounded bg-primary px-5 py-2 text-sm font-semibold text-black hover:bg-primary/90"
          >
            Download Employee SMS Consent PDF
          </a>
        </div>
      ) : (
        <div class="rounded border border-dashed border-white/20 bg-dark/20 p-6 text-base font-mono leading-relaxed text-white/75">
          <p class="font-semibold text-accent">Consent form not configured.</p>
          <p class="mt-2">
            Add a form URL to the
            <code class="bg-white/10 px-1 text-white">employee-sms-consent</code>
            resource in Sanity to enable the printable consent form.
          </p>
        </div>
      )
    }
  </section>
</BaseLayout>
