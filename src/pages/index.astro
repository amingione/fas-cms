---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getGitPageDoc, sbFieldPath, sbObjectId } from '@lib/stackbit';
import * as sanity from '../lib/sanity-utils';
import { Services } from '@components/Services.tsx';
import { TruckPackagesHero } from '@components/TruckPackagesHero.tsx';
import { LuxuryFeatures } from '@components/LuxuryFeatures.tsx';
import { CustomFabrication } from '@components/CustomFabrication.tsx';
import HomeHero from '@/components/hero/homeHero';
import HeadingBanner1 from '@components/banner/HeadingBanner1.tsx';
import Highlights from '@/components/Highlights.astro';
import HeadingBanner from '@components/banner/HeadingBanner.tsx';
import ProductFeatureBanner from '@components/banner/ProductFeatureBanner.tsx';



const url = new URL(Astro.request.url);
const pageDoc: any = await getGitPageDoc('index');
const v2Param = url.searchParams.get('v2');
// Default to the new V2 homepage; allow opt-out via ?v2=0
const showV2 = v2Param === '0' ? false : true;

let featuredProducts: any[] = [];
try {
  // Try to resolve a configured Sanity client from your utils module
  const _client: any = (sanity as any).sanityClient
    ?? (sanity as any).client
    ?? ((sanity as any).getClient ? (sanity as any).getClient() : null);

  if (_client && typeof _client.fetch === 'function') {
    // 1) Prefer PUBLISHED docs where featured is a boolean true
    let booleanTry: any[] = [];
    try {
      booleanTry = await _client.fetch(
        `*[_type == "product" && !(_id in path("drafts.**")) && coalesce(featured, false) == true && defined(slug.current)][0..7]{
          _id,
          name,
          title,
          "slug": slug.current,
          price,
          "imageUrl": coalesce(
            image.asset->url,
            mainImage.asset->url,
            images[0].asset->url,
            thumbnail.asset->url,
            thumb.asset->url
          )
        }`
      );
    } catch {}
    console.log('[Featured] boolean=true count:', Array.isArray(booleanTry) ? booleanTry.length : 0);
    try {
      const cfg = (sanity as any).config || (sanity as any).clientConfig || (sanity as any).defaultClientConfig || {};
      console.log('[Sanity] projectId:', cfg.projectId, 'dataset:', cfg.dataset);
    } catch {}

    featuredProducts = Array.isArray(booleanTry) ? booleanTry : [];

    // 2) Fallback: some datasets store featured as a string "true"
    if (!featuredProducts.length) {
      let stringTry: any[] = [];
      try {
        stringTry = await _client.fetch(
          `*[_type == "product" && !(_id in path("drafts.**")) && featured == "true" && defined(slug.current)][0..7]{
            _id,
            name,
            title,
            "slug": slug.current,
            price,
            "imageUrl": coalesce(
              image.asset->url,
              mainImage.asset->url,
              images[0].asset->url,
              thumbnail.asset->url,
              thumb.asset->url
            )
          }`
        );
      } catch {}
      console.log('[Featured] string "true" count:', Array.isArray(stringTry) ? stringTry.length : 0);
      try {
        const cfg = (sanity as any).config || (sanity as any).clientConfig || (sanity as any).defaultClientConfig || {};
        console.log('[Sanity] projectId:', cfg.projectId, 'dataset:', cfg.dataset);
      } catch {}
      featuredProducts = Array.isArray(stringTry) ? stringTry : [];
    }
  }
} catch (err) {
  console.error('Featured products fetch failed', err);
}
---


<BaseLayout
  title="Performance Parts, Wheels & Packages"
  description="F.A.S. Motorsports — premium performance upgrades, billet parts, custom fabrication, and wheel packages for Hellcat, Trackhawk, TRX and more."
  canonical={`${new URL(Astro.request.url).origin}/`}
  ogImage="/logo/faslogochroma.png"
>

    <div aria-hidden="true" class="hidden" {...sbFieldPath('title')}>
      {pageDoc?.title ?? 'Home'}
    </div>

    <main class="relative flex flex-col">

    <div {...sbObjectId('content/pages/index.json')}>

      
      <section id="homeHero" class="pt-[-12px]">
        <HomeHero client:only="react" />
      </section>

      <asection id="HeadingBanner1" class="mt-10">
        <HeadingBanner1 client:only="react" />
      </asection>

        <HeadingBanner
          client:only="react"
          eyebrow="F.A.S. PREDATOR PULLEY"
          headline="NO TUNE REQUIRED."
          subline="PATENT PENDING INNOVATION – PRECISION-ENGINEERED FOR FLAWLESS PERFORMANCE."
          cta={{ label: 'SHOP NOW', href: '/shop' }}
          backgroundUrl="/images/backgrounds/bg-asphalt.png"
          images={[
            {
              src: '/images/billetParts/predator-pulley-fas.png',
              alt: 'Predator pulley front view'
            },
            {
              src: '/images/billetParts/fas-pred-pully.png',
              alt: 'Predator pulley angled view'
            }
          ]}
          showDivider
        />
      </section>

      <div class=" section-divider section-divider-carbon w-full" />

      <section id="TruckPackagesHero">
        <TruckPackagesHero client:only="react" />
      </section>

      <section id="Highlights">
        <Highlights items={featuredProducts} />
      </section>

      <section class="mt-20">
        <ProductFeatureBanner
          client:only="react"
          backgroundUrl="/images/backgrounds/bg-path-overlay.webp"
          features={[
            {
              side: 'left',
              image: {
                src: '/images/billetParts/predator-pulley-fas.png',
                alt: 'Predator pulley product photo'
              },
              lines: ['NO TUNE', 'PREDATOR', 'PULLEY'],
              pricePrefix: 'ONLY FROM',
              price: '$899.99',
              cta: { label: 'SHOP NOW', href: '/shop/predator-pulley' },
            },
            {
              side: 'right',
              image: {
                src: '/images/snouts/FAS-Billet-Snout.png',
                alt: 'Hellcat snout porting product photo'
              },
              lines: ['HELLCAT', 'SNOUT', 'PORTING'],
              pricePrefix: 'ONLY FROM',
              price: '$699.00',
              cta: { label: 'SHOP NOW', href: '/shop/hellcat-snout-porting' },
            },
          ]}
        />
      </section>

      <section id="CustomFabrication">
        <CustomFabrication client:only="react" />
      </section>

      <section id="services" class="mt-20">
        <Services client:only="react" />
      </section>

      <section id="LuxuryFeatures" class="mt-20">
        <LuxuryFeatures client:only="react" />
      </section>
    </main>
  </div>
</BaseLayout>
