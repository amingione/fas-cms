---
import BaseLayout from '../layouts/BaseLayout.astro';
import { loadPageDoc, inlineFieldAttrs, inlineObjectId } from '@lib/content';
import * as sanity from '../lib/sanity-utils';
import { LuxuryFeatures } from '@components/LuxuryFeatures.tsx';
import AnimatedHomeHero from '@components/animated/AnimatedHomeHero';
import AnimatedHeadingBanner1 from '@components/animated/AnimatedHeadingBanner1';
import Highlights from '@/components/Highlights.astro';
import AnimatedHeadingBanner from '@components/animated/AnimatedHeadingBanner';
import AnimatedProductFeatureBanner from '@components/animated/AnimatedProductFeatureBanner';
import AnimatedTaskCard from '@components/animated/AnimatedTaskCard';
import AnimatedTruckPackagesHero from '@components/animated/AnimatedTruckPackagesHero';
import SectionRenderer from '@/components/SectionRenderer.astro';


const url = new URL(Astro.request.url);
const siteOrigin = url.origin;
const canonicalHome = `${siteOrigin}/`;
const pageDoc: any = await loadPageDoc('index');
const v2Param = url.searchParams.get('v2');
// Default to the new V2 homepage; allow opt-out via ?v2=0
const showV2 = v2Param === '0' ? false : true;

const resolveSanityConfig = () => {
  try {
    return (
      (sanity as any).config ||
      (sanity as any).clientConfig ||
      (sanity as any).defaultClientConfig ||
      {}
    );
  } catch {
    return {};
  }
};

let featuredProducts: any[] = [];
try {
  const _client: any =
    (sanity as any).sanityClient ??
    (sanity as any).client ??
    ((sanity as any).getClient ? (sanity as any).getClient() : null);

  const fetchFeaturedProducts = async () => {
    if (!_client || typeof _client.fetch !== 'function') {
      return [];
    }

    const configSnapshot = resolveSanityConfig();

    const baseProjection = `{
      _id,
      name,
      title,
      "slug": slug.current,
      price,
      "imageUrl": coalesce(
        image.asset->url,
        mainImage.asset->url,
        images[0].asset->url,
        thumbnail.asset->url,
        thumb.asset->url
      )
    }`;

    let booleanTry: any[] = [];
    try {
      booleanTry = await _client.fetch(
        `*[_type == "product" && !(_id in path("drafts.**")) && coalesce(featured, false) == true && defined(slug.current)][0..7]${baseProjection}`
      );
    } catch {}
    console.log('[Featured] boolean=true count:', Array.isArray(booleanTry) ? booleanTry.length : 0);
    console.log(
      '[Sanity] config snapshot:',
      configSnapshot.projectId,
      configSnapshot.dataset
    );

    if (Array.isArray(booleanTry) && booleanTry.length) {
      return booleanTry;
    }

    let stringTry: any[] = [];
    try {
      stringTry = await _client.fetch(
        `*[_type == "product" && !(_id in path("drafts.**")) && featured == "true" && defined(slug.current)][0..7]${baseProjection}`
      );
    } catch {}
    console.log('[Featured] string "true" count:', Array.isArray(stringTry) ? stringTry.length : 0);
    console.log(
      '[Sanity] config snapshot:',
      configSnapshot.projectId,
      configSnapshot.dataset
    );

    return Array.isArray(stringTry) ? stringTry : [];
  };

  const configSnapshot = resolveSanityConfig();
  featuredProducts = await sanity.cachedSanityFetch(
    [
      'homepage-featured-products',
      configSnapshot.projectId ?? null,
      configSnapshot.dataset ?? null,
      configSnapshot.perspective ?? null
    ],
    fetchFeaturedProducts,
    { ttlSeconds: 180 }
  );
} catch (err) {
  console.error('Featured products fetch failed', err);
}

const featuredProductsNormalized = Array.isArray(featuredProducts)
  ? featuredProducts.map((product) => {
      if (!product || typeof product !== 'object') return product;
      const rawImageUrl = (product as any).imageUrl;
      const normalizedImageUrl =
        typeof rawImageUrl === 'string'
          ? sanity.normalizeSanityImageUrl(rawImageUrl) ?? rawImageUrl
          : rawImageUrl;
      return { ...product, imageUrl: normalizedImageUrl };
    })
  : [];

const organizationSchema = {
  '@type': 'Organization',
  '@id': '#fas-organization',
  name: 'F.A.S. Motorsports',
  legalName: 'F.A.S. Motorsports',
  url: canonicalHome,
  logo: `${siteOrigin}/logo/faslogochroma.webp`,
  sameAs: [
    'https://www.facebook.com/fasmotorsports',
    'https://www.instagram.com/fasmotorsports'
  ]
};

const localBusinessSchema = {
  '@type': 'AutoRepair',
  '@id': '#fas-location',
  name: 'F.A.S. Motorsports',
  url: canonicalHome,
  telephone: '(239) 200-9012',
  email: 'sales@fasmotorsports.com',
  image: 'https://fasmotorsports.com/images/social/social-share.webp',
  address: {
    '@type': 'PostalAddress',
    streetAddress: '6161 Riverside Dr',
    addressLocality: 'Fort Myers',
    addressRegion: 'FL',
    postalCode: '33982',
    addressCountry: 'US'
  },
  openingHoursSpecification: [
    {
      '@type': 'OpeningHoursSpecification',
      dayOfWeek: [
        'Monday',
        'Tuesday',
        'Wednesday',
        'Thursday',
        'Friday'
      ],
      opens: '09:00',
      closes: '17:00'
    }
  ],
  sameAs: [
    'https://www.facebook.com/fasmotorsports',
    'https://www.instagram.com/fasmotorsports'
  ],
  parentOrganization: { '@id': '#fas-organization' }
};

const webSiteSchema = {
  '@type': 'WebSite',
  '@id': '#fas-website',
  name: 'F.A.S. Motorsports',
  url: canonicalHome,
  potentialAction: {
    '@type': 'SearchAction',
    target: `${canonicalHome}search?q={search_term_string}`,
    'query-input': 'required name=search_term_string'
  }
};

const webPageSchema = {
  '@type': 'WebPage',
  '@id': '#fas-homepage',
  name: 'F.A.S. Motorsports Performance Parts & Packages',
  url: canonicalHome,
  isPartOf: { '@id': '#fas-website' },
  about: { '@id': '#fas-organization' }
};

const productSchemas = featuredProductsNormalized
  .map((product, index) => {
    if (!product || typeof product !== 'object') return null;
    const name =
      (product as any).name || (product as any).title || 'F.A.S. Motorsports Product';
    const slug = typeof (product as any).slug === 'string' ? (product as any).slug : undefined;
    const priceRaw = (product as any).price;
    const priceValue =
      typeof priceRaw === 'number'
        ? priceRaw.toFixed(2)
        : typeof priceRaw === 'string'
        ? priceRaw.replace(/[^0-9.]/g, '')
        : undefined;
    const productUrl = slug ? `${canonicalHome}shop/${slug}` : canonicalHome;
    const image = typeof (product as any).imageUrl === 'string' ? (product as any).imageUrl : undefined;

    const offers = priceValue
      ? {
          '@type': 'Offer',
          priceCurrency: 'USD',
          price: priceValue,
          availability: 'https://schema.org/InStock',
          url: productUrl
        }
      : undefined;

    return {
      '@type': 'Product',
      '@id': `#fas-product-${index + 1}`,
      name,
      image: image ? [image] : undefined,
      description: (product as any).description || `${name} available through F.A.S. Motorsports with in-house support and validation.`,
      brand: { '@type': 'Organization', name: 'F.A.S. Motorsports' },
      url: productUrl,
      offers
    };
  })
  .filter(Boolean);

const structuredDataGraph = {
  '@context': 'https://schema.org',
  '@graph': [
    organizationSchema,
    localBusinessSchema,
    webSiteSchema,
    webPageSchema,
    ...productSchemas
  ]
};
---


<BaseLayout
  title="Performance Parts, Wheels & Packages"
  description="F.A.S. Motorsports â€” premium performance upgrades, billet parts, custom fabrication, and wheel packages for Hellcat, Trackhawk, TRX and more."
  canonical={canonicalHome}
  ogImage="https://fasmotorsports.com/images/social/social-share.webp"
  keywords={[
    'F.A.S. Motorsports',
    'Fort Myers performance shop',
    'Hellcat performance parts',
    'Trackhawk upgrades',
    'TRX packages',
    'custom fabrication',
    'billet supercharger parts',
    'performance wheel packages'
  ]}
>
  <Fragment slot="head">
    <script type="application/ld+json" set:html={JSON.stringify(structuredDataGraph)} />
  </Fragment>

    <div aria-hidden="true" class="hidden" {...inlineFieldAttrs('title')}>
      {pageDoc?.title ?? 'Home'}
    </div>

    <main class="relative flex flex-col">

    <div {...inlineObjectId('content/pages/index.json')}>
        <SectionRenderer sections={pageDoc.sections} baseFieldPath="sections" />


      <section id="homeHero">
        <AnimatedHomeHero client:only="react" />
      </section>

      <section id="HeadingBanner1">
        <AnimatedHeadingBanner1 client:visible />
      </section>

      <section class="hidden" id="HeadingBanner">
        <AnimatedHeadingBanner client:visible />
      </section>

      <section id="TruckPackagesHero">
        <AnimatedTruckPackagesHero client:visible />
      </section>

      <section id="Highlights">
        <Highlights items={featuredProductsNormalized} />
      </section>

      <section class="mt-20" id="TaskCard">
        <AnimatedTaskCard client:visible />
      </section>

      <section class="mt-20 mb-10">
        <AnimatedProductFeatureBanner
          client:visible
          backgroundUrl="/images/backgrounds/bg-path-overlay.webp"
          features={[
            {
              side: 'left',
              image: {
                src: '/images/billetParts/predator-pulley-fas.webp',
                alt: 'Predator pulley product photo',
                width: 1719,
                height: 1719,
                loading: 'lazy',
                decoding: 'async',
                sizes: '(min-width: 1024px) 320px, 80vw'
              },
              lines: ['NO TUNE', 'PREDATOR', 'PULLEY'],
              pricePrefix: 'FROM',
              price: '$899.99',
              cta: { label: 'SHOP NOW', href: '/shop/predator-pulley' }
            },
            {
              side: 'right',
              image: {
                src: '/images/snouts/FAS-Billet-Snout.webp',
                alt: 'Hellcat snout porting product photo',
                width: 1000,
                height: 1000,
                loading: 'lazy',
                decoding: 'async',
                sizes: '(min-width: 1024px) 320px, 80vw',
                srcSet:
                  '/images/snouts/FAS-Billet-Snout-480.webp 480w, ' +
                  '/images/snouts/FAS-Billet-Snout-700.webp 700w, ' +
                  '/images/snouts/FAS-Billet-Snout.webp 1000w'
              },
              lines: ['HELLCAT', 'SNOUT', 'PORTING'],
              pricePrefix: 'FROM',
              price: '$699.00',
              cta: { label: 'SHOP NOW', href: '/shop/hellcat-snout-porting' }
            },
          ]}
        />
      </section>



      <section id="LuxuryFeatures" class="mt-20">
        <LuxuryFeatures client:visible />
      </section>
    </main>
  </div>
</BaseLayout>
