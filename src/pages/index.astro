---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getGitPageDoc, sbFieldPath, sbObjectId } from '@lib/stackbit';
import * as sanity from '../lib/sanity-utils';
import { LuxuryFeatures } from '@components/LuxuryFeatures.tsx';
import AnimatedHomeHero from '@components/animated/AnimatedHomeHero';
import AnimatedHeadingBanner1 from '@components/animated/AnimatedHeadingBanner1';
import Highlights from '@/components/Highlights.astro';
import AnimatedHeadingBanner from '@components/animated/AnimatedHeadingBanner';
import AnimatedProductFeatureBanner from '@components/animated/AnimatedProductFeatureBanner';
import AnimatedTaskCard from '@components/animated/AnimatedTaskCard';
import AnimatedThreeDGallery from '@components/animated/AnimatedThreeDGallery';
import AnimatedTruckPackagesHero from '@components/animated/AnimatedTruckPackagesHero';
import SectionRenderer from '@/components/SectionRenderer.astro';


const url = new URL(Astro.request.url);
const pageDoc: any = await getGitPageDoc('index');
const v2Param = url.searchParams.get('v2');
// Default to the new V2 homepage; allow opt-out via ?v2=0
const showV2 = v2Param === '0' ? false : true;

let featuredProducts: any[] = [];
try {
  // Try to resolve a configured Sanity client from your utils module
  const _client: any = (sanity as any).sanityClient
    ?? (sanity as any).client
    ?? ((sanity as any).getClient ? (sanity as any).getClient() : null);

  if (_client && typeof _client.fetch === 'function') {
    // 1) Prefer PUBLISHED docs where featured is a boolean true
    let booleanTry: any[] = [];
    try {
      booleanTry = await _client.fetch(
        `*[_type == "product" && !(_id in path("drafts.**")) && coalesce(featured, false) == true && defined(slug.current)][0..7]{
          _id,
          name,
          title,
          "slug": slug.current,
          price,
          "imageUrl": coalesce(
            image.asset->url,
            mainImage.asset->url,
            images[0].asset->url,
            thumbnail.asset->url,
            thumb.asset->url
          )
        }`
      );
    } catch {}
    console.log('[Featured] boolean=true count:', Array.isArray(booleanTry) ? booleanTry.length : 0);
    try {
      const cfg = (sanity as any).config || (sanity as any).clientConfig || (sanity as any).defaultClientConfig || {};
      console.log('[Sanity] projectId:', cfg.projectId, 'dataset:', cfg.dataset);
    } catch {}

    featuredProducts = Array.isArray(booleanTry) ? booleanTry : [];

    // 2) Fallback: some datasets store featured as a string "true"
    if (!featuredProducts.length) {
      let stringTry: any[] = [];
      try {
        stringTry = await _client.fetch(
          `*[_type == "product" && !(_id in path("drafts.**")) && featured == "true" && defined(slug.current)][0..7]{
            _id,
            name,
            title,
            "slug": slug.current,
            price,
            "imageUrl": coalesce(
              image.asset->url,
              mainImage.asset->url,
              images[0].asset->url,
              thumbnail.asset->url,
              thumb.asset->url
            )
          }`
        );
      } catch {}
      console.log('[Featured] string "true" count:', Array.isArray(stringTry) ? stringTry.length : 0);
      try {
        const cfg = (sanity as any).config || (sanity as any).clientConfig || (sanity as any).defaultClientConfig || {};
        console.log('[Sanity] projectId:', cfg.projectId, 'dataset:', cfg.dataset);
      } catch {}
      featuredProducts = Array.isArray(stringTry) ? stringTry : [];
    }
  }
} catch (err) {
  console.error('Featured products fetch failed', err);
}
---


<BaseLayout
  title="Performance Parts, Wheels & Packages"
  description="F.A.S. Motorsports â€” premium performance upgrades, billet parts, custom fabrication, and wheel packages for Hellcat, Trackhawk, TRX and more."
  canonical={`${new URL(Astro.request.url).origin}/`}
  ogImage="/logo/faslogochroma.png"
>

    <div aria-hidden="true" class="hidden" {...sbFieldPath('title')}>
      {pageDoc?.title ?? 'Home'}
    </div>

    <main class="relative flex flex-col">

    <div {...sbObjectId('content/pages/index.json')}>
        <SectionRenderer sections={pageDoc.sections} baseFieldPath="sections" />


      <section id="homeHero">
        <AnimatedHomeHero client:only="react" />
      </section>

      <section id="HeadingBanner1">
        <AnimatedHeadingBanner1 client:only="react" />
      </section>

      <section id="HeadingBanner">
        <AnimatedHeadingBanner client:only="react" />
      </section>

      <section id="TruckPackagesHero">
        <AnimatedTruckPackagesHero client:only="react" />
      </section>

      <section id="Highlights">
        <Highlights items={featuredProducts} />
      </section>

      <section class="mt-20" id="TaskCard">
        <AnimatedTaskCard client:only="react" />
      </section>

      <section class="mt-20 mb-10">
        <AnimatedProductFeatureBanner
          client:only="react"
          backgroundUrl="/images/backgrounds/bg-path-overlay.webp"
          features={[
            {
              side: 'left',
              image: {
                src: '/images/billetParts/predator-pulley-fas.png',
                alt: 'Predator pulley product photo'
              },
              lines: ['NO TUNE', 'PREDATOR', 'PULLEY'],
              pricePrefix: 'FROM',
              price: '$899.99',
              cta: { label: 'SHOP NOW', href: '/shop/predator-pulley' }
            },
            {
              side: 'right',
              image: {
                src: '/images/snouts/FAS-Billet-Snout.png',
                alt: 'Hellcat snout porting product photo'
              },
              lines: ['HELLCAT', 'SNOUT', 'PORTING'],
              pricePrefix: 'FROM',
              price: '$699.00',
              cta: { label: 'SHOP NOW', href: '/shop/hellcat-snout-porting' }
            },
          ]}
        />
      </section>


      
      <section id="ThreeDGallery" class="mt-10">
        <AnimatedThreeDGallery
          client:only="react"
          images={[
            '/images/packages/FAS-trackhawk-engine-bay.webp',
            '/images/packages/Shelby-truck.png',
            '/images/backgrounds/powerPackages/FAS-4.webp',
            '/images/packages/FAS-f150-1000.webp',
            '/images/packages/Shelby-truck.png',
            '/images/packages/Hellcat/FAS-1.webp',
            '/images/packages/FAS-trackhawk-bay.webp',
          ]}
          rotateSpeed={80}
          pauseOnHover={true}
        />
      </section>



      <section id="LuxuryFeatures" class="mt-20">
        <LuxuryFeatures client:only="react" />
      </section>
    </main>
  </div>
</BaseLayout>
