---
import BaseLayout from '../layouts/BaseLayout.astro';
import { loadPageDoc, inlineFieldAttrs, inlineObjectId } from '@lib/content.ts';
import * as sanity from '../lib/sanity-utils';
import { LuxuryFeatures } from '@components/LuxuryFeatures.tsx';
import AnimatedHomeHero from '@components/animated/AnimatedHomeHero.tsx';
import AnimatedHeadingBanner1 from '@components/animated/AnimatedHeadingBanner1.tsx';
import Highlights from '@/components/Highlights.astro';
import AnimatedHeadingBanner from '@components/animated/AnimatedHeadingBanner.tsx';
import AnimatedProductFeatureBanner from '@components/animated/AnimatedProductFeatureBanner.tsx';
import AnimatedTaskCard from '@components/animated/AnimatedTaskCard.tsx';
import AnimatedTruckPackagesHero from '@components/animated/AnimatedTruckPackagesHero.tsx';
import SectionRenderer from '@/components/SectionRenderer.astro';
import EmailCaptureModal from '@components/EmailCaptureModal.tsx';
import { BlackFridayHero } from '@/components/banner/blackFridaySale.tsx';
import AnnouncementBanner from '@components/AnnouncementBanner.tsx';

const pageDocPromise: Promise<any> = loadPageDoc('index');
const featuredProductsPromise = sanity
  .fetchFeaturedProducts({ limit: 8, ttlSeconds: 180 })
  .catch((err) => {
    console.error('Featured products fetch failed', err);
    return [];
  });

const url = new URL(Astro.request.url);
const siteOrigin = url.origin;
const canonicalHome = `${siteOrigin}/`;
const [pageDoc, featuredProductsRaw] = await Promise.all([pageDocPromise, featuredProductsPromise]);
const v2Param = url.searchParams.get('v2');
// Default to the new V2 homepage; allow opt-out via ?v2=0
const showV2 = v2Param === '0' ? false : true;

const featuredProducts: any[] = Array.isArray(featuredProductsRaw) ? featuredProductsRaw : [];

const featuredProductsNormalized = Array.isArray(featuredProducts)
  ? featuredProducts.map((product) => {
      if (!product || typeof product !== 'object') return product;
      const normalizedImageUrl =
        typeof product.imageUrl === 'string'
          ? (sanity.normalizeSanityImageUrl(product.imageUrl) ?? product.imageUrl)
          : sanity.normalizeSanityImageUrl(product.images?.[0]);
      return { ...product, imageUrl: normalizedImageUrl };
    })
  : [];

const productSchemas = featuredProductsNormalized
  .map((product, index) => {
    if (!product || typeof product !== 'object') return null;
    const name = (product as any).name || (product as any).title || 'F.A.S. Motorsports Product';
    const slug = typeof (product as any).slug === 'string' ? (product as any).slug : undefined;
    const priceRaw = (product as any).price;
    const priceValue =
      typeof priceRaw === 'number'
        ? priceRaw.toFixed(2)
        : typeof priceRaw === 'string'
          ? priceRaw.replace(/[^0-9.]/g, '')
          : undefined;
    const productUrl = slug ? `${canonicalHome}shop/${slug}` : canonicalHome;
    const image =
      typeof (product as any).imageUrl === 'string' ? (product as any).imageUrl : undefined;

    const offers = priceValue
      ? {
          '@type': 'Offer',
          priceCurrency: 'USD',
          price: priceValue,
          availability: 'https://schema.org/InStock',
          url: productUrl
        }
      : undefined;

    return {
      '@type': 'Product',
      '@id': `#fas-product-${index + 1}`,
      name,
      image: image ? [image] : undefined,
      description:
        (product as any).description ||
        `${name} available through F.A.S. Motorsports with in-house support and validation.`,
      brand: { '@type': 'Organization', name: 'F.A.S. Motorsports' },
      url: productUrl,
      offers
    };
  })
  .filter(Boolean);

const structuredDataGraph =
  productSchemas.length > 0
    ? {
        '@context': 'https://schema.org',
        '@graph': [
          {
            '@type': 'ItemList',
            '@id': '#fas-featured-products',
            name: 'Featured Products',
            numberOfItems: productSchemas.length,
            itemListElement: productSchemas.map((product, index) => {
              const schema = product as Record<string, unknown>;
              const idValue =
                typeof schema['@id'] === 'string'
                  ? (schema['@id'] as string)
                  : `#fas-product-${index + 1}`;
              return {
                '@type': 'ListItem',
                position: index + 1,
                item: { '@id': idValue }
              };
            })
          },
          ...productSchemas
        ]
      }
    : null;
---

<BaseLayout
  title="Performance Parts, Wheels & Packages"
  description="F.A.S. Motorsports â€” premium performance upgrades, billet parts, custom fabrication, and wheel packages for Hellcat, Trackhawk, TRX and more."
  canonical={canonicalHome}
  ogImage="https://fasmotorsports.com/images/social/social-share.webp"
  keywords={[
    'F.A.S. Motorsports',
    'Fort Myers performance shop',
    'Hellcat performance parts',
    'Trackhawk upgrades',
    'TRX packages',
    'custom fabrication',
    'billet supercharger parts',
    'performance wheel packages'
  ]}
  -
>
  {
    structuredDataGraph && (
      <Fragment slot="head">
        <script type="application/ld+json" set:html={JSON.stringify(structuredDataGraph)} />
      </Fragment>
    )
  }

  <div aria-hidden="true" class="hidden" {...inlineFieldAttrs('title')}>
    {pageDoc?.title ?? 'Home'}
  </div>

  <main class="relative flex flex-col">
    <AnnouncementBanner client:load />
    <div {...inlineObjectId('content/pages/index.json')}>
      <SectionRenderer sections={pageDoc.sections} baseFieldPath="sections" />

      <section id="homeHero">
        <AnimatedHomeHero client:only="react" />
      </section>

      <!-- Auto-scrolling Black Friday divider -->
      <section
        id="bf-divider"
        class="shadow-primary/30 shadow-inner shadow-box-outer relative overflow-hidden py-3 bg-black/10 border-y border-zinc-800"
      >
        <div
          class="animate-marquee whitespace-nowrap text-white text-sm tracking-widest font-semibold"
        >
          <span class="mx-8">ðŸ”¥ BLACK FRIDAY SALE â€” ONE DAY ONLY ðŸ”¥</span>
          <span class="mx-8">ðŸ”¥ BLACK FRIDAY SALE â€” ONE DAY ONLY ðŸ”¥</span>
          <span class="mx-8">ðŸ”¥ BLACK FRIDAY SALE â€” ONE DAY ONLY ðŸ”¥</span>
          <span class="mx-8">ðŸ”¥ BLACK FRIDAY SALE â€” ONE DAY ONLY ðŸ”¥</span>
        </div>
      </section>

      <style>
        @keyframes marquee {
          0% {
            transform: translateX(0);
          }
          100% {
            transform: translateX(-50%);
          }
        }
        .animate-marquee {
          display: inline-block;
          animation: marquee 18s linear infinite;
        }
      </style>

      <section class="my-10">
        <BlackFridayHero client:visible />
      </section>

      <section id="HeadingBanner1">
        <AnimatedHeadingBanner1 client:visible />
      </section>

      <section class="hidden" id="HeadingBanner">
        <AnimatedHeadingBanner client:visible />
      </section>

      <section id="TruckPackagesHero">
        <AnimatedTruckPackagesHero client:visible />
      </section>

      <section id="Highlights">
        <Highlights items={featuredProductsNormalized} />
      </section>

      <section class="mt-20" id="TaskCard">
        <AnimatedTaskCard client:visible />
      </section>

      <section class="mt-20 mb-10">
        <AnimatedProductFeatureBanner
          client:visible
          backgroundUrl="/images/backgrounds/bg-path-overlay.webp"
          features={[
            {
              side: 'left',
              image: {
                src: '/images/billetParts/predator-pulley-fas.webp',
                alt: 'Predator pulley product photo',
                width: 1719,
                height: 1719,
                loading: 'lazy',
                decoding: 'async',
                sizes: '(min-width: 1024px) 320px, 80vw'
              },
              lines: ['NO TUNE', 'PREDATOR', 'PULLEY'],
              pricePrefix: 'FROM',
              price: '$899.99',
              cta: { label: 'SHOP NOW', href: '/shop/fas-predator-lower-pulley-no-tune-required' }
            },
            {
              side: 'right',
              image: {
                src: '/images/snouts/FAS-Billet-Snout.webp',
                alt: 'Hellcat snout porting product photo',
                width: 1000,
                height: 1000,
                loading: 'lazy',
                decoding: 'async',
                sizes: '(min-width: 1024px) 320px, 80vw',
                srcSet:
                  '/images/snouts/FAS-Billet-Snout-480.webp 480w, ' +
                  '/images/snouts/FAS-Billet-Snout-700.webp 700w, ' +
                  '/images/snouts/FAS-Billet-Snout.webp 1000w'
              },
              lines: ['BILLET', 'SUPERCHARGER', 'SNOUT'],
              pricePrefix: 'FROM',
              price: '$1899.99',
              cta: { label: 'SHOP NOW', href: '/shop/2-4l-hellcat-billet-supercharger-snout' }
            }
          ]}
        />
      </section>

      <section id="LuxuryFeatures" class="mt-20">
        <LuxuryFeatures client:visible />
      </section>

      <EmailCaptureModal client:idle />
    </div>
  </main>
</BaseLayout>
