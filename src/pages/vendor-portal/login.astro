---
import BaseLayout from '@/layouts/BaseLayout.astro';
const title = 'Vendor Portal Login';
const returnTo = Astro.url.searchParams.get('returnTo') || '/vendor-portal/dashboard';
const setupStatus = Astro.url.searchParams.get('setup');
const errorParam = Astro.url.searchParams.get('error');

let banner = null;
if (setupStatus === 'success') {
  banner = { tone: 'success', message: 'Account setup complete! Please log in with your new password.' };
} else if (errorParam === 'missing-token') {
  banner = { tone: 'error', message: 'Invalid setup link. Please request a new invitation.' };
} else if (errorParam === 'invalid-token' || errorParam === 'expired-token') {
  banner = { tone: 'error', message: 'This setup link has expired. Please request a new invite.' };
} else if (errorParam === 'already-setup') {
  banner = { tone: 'info', message: 'Your account is already set up. Please log in.' };
}
---

<BaseLayout title={title} noindex>
  <div class="min-h-screen flex items-center justify-center px-4 bg-black">
    <div class="w-full max-w-md rounded-lg border border-white/20 bg-zinc-900/80 p-6 shadow-xl">
      <div class="text-center mb-6">
        <img src="/logo/faslogochroma.webp" alt="FAS Motorsports" width="120" height="120" class="mx-auto" />
        <h1 class="mt-4 text-3xl font-bold text-primary uppercase">Vendor Portal</h1>
        <p class="text-sm text-white/70">Sign in with your portal email and password.</p>
      </div>
      {banner && (
        <div
          class={`mb-4 rounded-lg px-3 py-2 text-sm ${
            banner.tone === 'success'
              ? 'bg-green-500/10 border border-green-400/50 text-green-200'
              : banner.tone === 'info'
              ? 'bg-blue-500/10 border border-blue-400/50 text-blue-200'
              : 'bg-red-500/10 border border-red-400/50 text-red-200'
          }`}
        >
          {banner.message}
        </div>
      )}
      <form id="vendorPortalLogin" class="space-y-4" data-redirect={returnTo}>
        <div>
          <label class="block text-sm font-semibold text-white mb-2" for="vp-email">Email</label>
          <input
            id="vp-email"
            name="email"
            type="email"
            autocomplete="email"
            required
            class="w-full rounded-md border border-white/20 bg-black px-3 py-2 text-white focus:border-primary focus:outline-none"
          />
        </div>
        <div>
          <label class="block text-sm font-semibold text-white mb-2" for="vp-password">Password</label>
          <input
            id="vp-password"
            name="password"
            type="password"
            autocomplete="current-password"
            required
            class="w-full rounded-md border border-white/20 bg-black px-3 py-2 text-white focus:border-primary focus:outline-none"
          />
        </div>
        <div class="flex items-center justify-between text-sm">
          <a href="/vendor-portal/forgot-password" class="text-primary hover:underline">Forgot password?</a>
        </div>
        <button
          type="submit"
          class="w-full rounded-md bg-primary px-4 py-2 font-semibold uppercase tracking-wide text-white hover:bg-primary/80 transition"
        >
          Sign in
        </button>
        <p id="vp-login-status" class="text-sm text-center text-red-400 hidden"></p>
      </form>
      <p class="mt-4 text-sm text-center text-white/70">
        Not a vendor?{' '}
        <a href="/become-a-vendor" class="text-primary hover:underline">
          Apply here.
        </a>
      </p>
    </div>
  </div>

  <script>
    const form = document.querySelector('#vendorPortalLogin');
    const statusEl = document.querySelector('#vp-login-status');

    form?.addEventListener('submit', async (event) => {
      event.preventDefault();
      const emailInput = document.querySelector('#vp-email');
      const passwordInput = document.querySelector('#vp-password');
      const email = emailInput && 'value' in emailInput ? emailInput.value : '';
      const password = passwordInput && 'value' in passwordInput ? passwordInput.value : '';
      const redirectTo =
        (form && (form as HTMLElement).dataset?.redirect) || '/vendor-portal/dashboard';

      if (!statusEl) return;
      statusEl.classList.add('hidden');
      statusEl.textContent = '';

      try {
        const res = await fetch('/api/vendor/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password }),
          credentials: 'include'
        });
        const data = await res.json().catch(() => ({}));
        if (res.ok) {
          window.location.href = redirectTo;
        } else {
          statusEl.textContent = data.message || 'Unable to sign in.';
          statusEl.classList.remove('hidden');
        }
      } catch (err) {
        statusEl.textContent = 'Network error. Try again.';
        statusEl.classList.remove('hidden');
      }
    });
  </script>
</BaseLayout>
