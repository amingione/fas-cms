---
import BaseLayout from '@/layouts/BaseLayout.astro';
import { readSession } from '@/server/auth/session';
import { getVendorById } from '@/server/sanity-client';

const { session } = await readSession(Astro.request);

if (!session?.user) {
  return Astro.redirect(`/vendor-portal/login?returnTo=${encodeURIComponent(Astro.url.pathname)}`);
}

const vendor = await getVendorById(session.user.id);
const title = 'Vendor Portal Dashboard';
---

<BaseLayout title={title} noindex>
  <main class="min-h-screen bg-black text-white px-6 py-10">
    <div class="max-w-5xl mx-auto space-y-8">
      <header class="flex items-center justify-between">
        <div>
          <p class="text-sm text-white/60 uppercase tracking-wide">Vendor Portal</p>
          <h1 class="text-3xl font-bold text-primary">{vendor?.name || 'Vendor'}</h1>
          <p class="text-sm text-white/70">{vendor?.email || vendor?.portalAccess?.email}</p>
        </div>
        <button
          id="vp-logout"
          type="button"
          class="rounded-md border border-white/20 px-3 py-2 text-sm text-white hover:border-primary"
        >
          Sign out
        </button>
      </header>

      <section class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
        <div class="rounded-lg border border-white/10 bg-zinc-900/70 p-4">
          <p class="text-xs uppercase tracking-wide text-white/60">Orders</p>
          <p class="text-3xl font-bold text-white mt-2">Coming soon</p>
          <p class="text-sm text-white/60">View and manage purchase orders.</p>
        </div>
        <div class="rounded-lg border border-white/10 bg-zinc-900/70 p-4">
          <p class="text-xs uppercase tracking-wide text-white/60">Inventory</p>
          <p class="text-3xl font-bold text-white mt-2">Coming soon</p>
          <p class="text-sm text-white/60">Update and manage inventory levels.</p>
        </div>
        <div class="rounded-lg border border-white/10 bg-zinc-900/70 p-4">
          <p class="text-xs uppercase tracking-wide text-white/60">Invoices</p>
          <p class="text-3xl font-bold text-white mt-2">Coming soon</p>
          <p class="text-sm text-white/60">Upload and submit invoices.</p>
        </div>
        <div class="rounded-lg border border-white/10 bg-zinc-900/70 p-4">
          <p class="text-xs uppercase tracking-wide text-white/60">Payments</p>
          <p class="text-3xl font-bold text-white mt-2">Coming soon</p>
          <p class="text-sm text-white/60">Track payment status and history.</p>
        </div>
        <div class="rounded-lg border border-white/10 bg-zinc-900/70 p-4">
          <p class="text-xs uppercase tracking-wide text-white/60">Products</p>
          <p class="text-3xl font-bold text-white mt-2">Coming soon</p>
          <p class="text-sm text-white/60">Manage catalog items and pricing.</p>
        </div>
        <div class="rounded-lg border border-white/10 bg-zinc-900/70 p-4">
          <p class="text-xs uppercase tracking-wide text-white/60">Analytics</p>
          <p class="text-3xl font-bold text-white mt-2">Coming soon</p>
          <p class="text-sm text-white/60">View portal analytics and reporting.</p>
        </div>
      </section>
    </div>
  </main>
</BaseLayout>

<script>
  const logoutBtn = document.querySelector('#vp-logout');
  logoutBtn?.addEventListener('click', async () => {
    try {
      await fetch('/api/vendor/logout', { method: 'POST', credentials: 'include' });
    } catch (err) {
      console.warn('Failed to log out', err);
    } finally {
      window.location.href = '/vendor-portal/login';
    }
  });
</script>
