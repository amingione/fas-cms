---
import BaseLayout from '@/layouts/BaseLayout.astro';
import SetupForm from '@/components/vendor-portal/SetupForm';
import { sanity } from '@/server/sanity-client';

const token = Astro.url.searchParams.get('token');

if (!token) {
  return Astro.redirect('/vendor-portal/login?error=missing-token');
}

const now = new Date().toISOString();
const vendor = await sanity.fetch(
  `*[_type == "vendor" && portalAccess.setupToken == $token][0]{
    _id,
    name,
    companyName,
    email,
    portalAccess
  }`,
  { token } as Record<string, unknown>
);

if (!vendor) {
  return Astro.redirect('/vendor-portal/login?error=invalid-token');
}

const completed = Boolean((vendor as any)?.portalAccess?.setupCompletedAt);
const expiry = (vendor as any)?.portalAccess?.setupTokenExpiry;
const expired = !expiry || expiry <= now;

if (completed) {
  return Astro.redirect('/vendor-portal/login?error=already-setup');
}

if (expired) {
  return Astro.redirect('/vendor-portal/login?error=expired-token');
}

const email = (vendor as any)?.portalAccess?.email || vendor.email;
const companyName = (vendor as any)?.companyName || (vendor as any)?.name || 'Vendor';
const title = 'Vendor Portal - Account Setup';
---

<BaseLayout title={title} noindex>
  <div class="min-h-screen bg-black flex items-center justify-center px-4 py-12">
    <div class="w-full max-w-lg rounded-2xl border border-white/15 bg-zinc-900/80 p-8 shadow-2xl">
      <div class="text-center mb-6">
        <p class="text-xs uppercase tracking-[0.2em] text-primary font-semibold">Vendor Portal</p>
        <h1 class="mt-2 text-3xl font-bold text-white">Complete your setup</h1>
        <p class="text-sm text-white/70">Create a password to access your account.</p>
      </div>
      <SetupForm
        vendorId={vendor._id}
        email={email}
        companyName={companyName}
        token={token}
        client:load
      />
    </div>
  </div>
</BaseLayout>
