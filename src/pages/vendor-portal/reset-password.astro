---
import BaseLayout from '@/layouts/BaseLayout.astro';
const token = Astro.url.searchParams.get('token') || '';
const title = 'Vendor Portal - Reset Password';
---

<BaseLayout title={title} noindex>
  <div class="min-h-screen flex items-center justify-center px-4 bg-dark">
    <div class="w-full max-w-lg rounded-lg border border-white/20 bg-zinc-900/80 p-6 shadow-xl text-white">
      <h1 class="text-3xl font-bold text-primary uppercase text-center mb-3">Reset password</h1>
      {token ? (
        <div id="vp-reset-wrapper">
          <p id="vp-reset-status" class="text-sm text-center text-white/70 mb-4">Validating reset linkâ€¦</p>
          <div id="vp-reset-form-wrapper" class="hidden">
            <p class="text-sm text-white/70 text-center mb-4">
              Account: <span id="vp-reset-email" class="font-semibold text-white"></span>
            </p>
            <form id="vp-reset-form" class="space-y-4">
              <div>
                <label class="block text-sm font-semibold mb-2" for="vp-reset-password">New password</label>
                <input
                  id="vp-reset-password"
                  type="password"
                  minlength="12"
                  required
                  class="w-full rounded-md border border-white/20 bg-white px-3 py-2 !text-black caret-black placeholder:text-zinc-600 focus:border-primary focus:outline-none"
                />
                <p class="text-xs text-white/60 mt-2">
                  Minimum 12 characters, include uppercase, lowercase, number, special character.
                </p>
              </div>
              <div>
                <label class="block text-sm font-semibold mb-2" for="vp-reset-confirm">Confirm password</label>
                <input
                  id="vp-reset-confirm"
                  type="password"
                  minlength="12"
                  required
                  class="w-full rounded-md border border-white/20 bg-white px-3 py-2 !text-black caret-black placeholder:text-zinc-600 focus:border-primary focus:outline-none"
                />
              </div>
              <button
                type="submit"
                class="w-full rounded-md bg-primary px-4 py-2 font-semibold uppercase tracking-wide text-white hover:bg-primary/80 transition"
              >
                Update password
              </button>
              <p id="vp-reset-message" class="text-sm text-center hidden"></p>
            </form>
            <p class="text-center text-sm mt-4">
              <a href="/vendor-portal/login" class="text-primary hover:underline">Back to login</a>
            </p>
          </div>
        </div>
      ) : (
        <p class="text-center text-red-400">Reset token is missing.</p>
      )}
    </div>
  </div>

  {token && (
    <script>
      const params = new URLSearchParams(window.location.search);
      const token = params.get('token') || '';
      const statusEl = document.querySelector('#vp-reset-status');
      const wrapper = document.querySelector('#vp-reset-form-wrapper');
      const emailEl = document.querySelector('#vp-reset-email');
      const form = document.querySelector('#vp-reset-form');
      const messageEl = document.querySelector('#vp-reset-message');

      const showError = (msg: string) => {
        if (statusEl) {
          statusEl.textContent = msg;
          statusEl.classList.remove('text-white/70');
          statusEl.classList.add('text-red-400');
        }
      };

      fetch(`/api/auth/reset-password?token=${encodeURIComponent(token)}`)
        .then((res) => res.json())
        .then((data) => {
          if (!data?.valid) {
            showError(data?.message || 'Reset link is invalid or expired.');
            return;
          }
          if (statusEl) statusEl.classList.add('hidden');
          if (wrapper) wrapper.classList.remove('hidden');
          if (emailEl) emailEl.textContent = data.email || '';
        })
        .catch(() => showError('Unable to validate reset link. Try again later.'));

      form?.addEventListener('submit', async (event) => {
        event.preventDefault();
        if (!messageEl) return;
        messageEl.classList.add('hidden');
        messageEl.classList.remove('text-green-400', 'text-red-400');
        const passwordInput = document.querySelector('#vp-reset-password') as HTMLInputElement | null;
        const confirmInput = document.querySelector('#vp-reset-confirm') as HTMLInputElement | null;
        const password = passwordInput?.value || '';
        const confirm = confirmInput?.value || '';
        if (password !== confirm) {
          messageEl.textContent = 'Passwords do not match.';
          messageEl.classList.add('text-red-400');
          messageEl.classList.remove('hidden');
          return;
        }
        try {
          const res = await fetch('/api/auth/reset-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token, password }),
            credentials: 'include'
          });
          const data = await res.json().catch(() => ({}));
          if (res.ok) {
            messageEl.textContent = 'Password updated. You can now sign in.';
            messageEl.classList.add('text-green-400');
            messageEl.classList.remove('hidden');
            setTimeout(() => (window.location.href = '/vendor-portal/login'), 1000);
          } else {
            messageEl.textContent = data.message || 'Unable to reset password.';
            messageEl.classList.add('text-red-400');
            messageEl.classList.remove('hidden');
          }
        } catch (err) {
          messageEl.textContent = 'Network error. Please try again.';
          messageEl.classList.add('text-red-400');
          messageEl.classList.remove('hidden');
        }
      });
    </script>
  )}
</BaseLayout>
