---
import BaseLayout from '../../layouts/BaseLayout.astro';
---

<BaseLayout>
  <section class="text-white p-8 font-mono">
    <h1 class="text-4xl font-cyber mb-6 text-center">Saved Quotes</h1>
    <div id="quotes-container" class="space-y-4">
      <p>Loading quotes...</p>
    </div>
  </section>

  <script type="module">
    async function fetchQuotes() {
      const container = document.getElementById('quotes-container');
      container.innerHTML = '<p>Loading...</p>';

      const email = (localStorage.getItem('customerEmail') || '').trim().toLowerCase();
      let url = '/api/get-user-quotes';
      if (email) url += `?email=${encodeURIComponent(email)}`;

      try {
        const response = await fetch(url, { credentials: 'include' });
        if (!response.ok) throw new Error(await response.text());
        const quotes = await response.json();

        if (!Array.isArray(quotes) || quotes.length === 0) {
          container.innerHTML = "<p>You don't have any quotes yet.</p>";
          return;
        }

        const ul = document.createElement('ul');
        ul.className = 'space-y-4';

        quotes.forEach((q) => {
          const li = document.createElement('li');
          li.className = 'border border-gray-600 p-4 rounded-lg bg-dark/30';
          const dateRaw = q._createdAt || q.dateRequested;
          const date = dateRaw ? new Date(dateRaw).toLocaleDateString() : 'N/A';
          li.innerHTML = `
            <div><strong>Quote:</strong> ${q._id || q.quoteId || ''}</div>
            <div><strong>Status:</strong> ${q.status || 'N/A'}</div>
            <div><strong>Requested:</strong> ${date}</div>
            ${Array.isArray(q.items) ? `<div class=\"mt-2\"><strong>Items:</strong> ${q.items.length}</div>` : ''}
          `;
          ul.appendChild(li);
        });

        container.innerHTML = '';
        container.appendChild(ul);
      } catch (error) {
        console.error('Failed to load quotes:', error);
        container.innerHTML = '<p>Unable to load quotes right now.</p>';
      }
    }

    fetchQuotes();
  </script>
</BaseLayout>
