---
import BaseLayout from '../../layouts/BaseLayout.astro';
---

<BaseLayout hideBrandTag>
  <!-- Netlify Profile Update Form (no JS/server required) -->
  <section class="p-8">
    <form
      id="profile-form"
      name="profile"
      method="POST"
      action="/customerdashboard/profile/success"
      data-success="/customerdashboard/profile/success"
      class="space-y-4 rounded-lg border border-white/20 bg-dark/50 p-6 shadow-md"
    >
      <h2 class="text-xl font-ethno mb-1">Update Profile (Request)</h2>
      <p class="text-sm text-white/70">
        Submit a request to update your profile. Our team will review and apply changes.
      </p>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm mb-1" for="firstName_form">First</label>
          <input
            id="firstName_form"
            name="firstName"
            type="text"
            class="w-full rounded bg-white/5 border border-white/15 p-2"
          />
        </div>
        <div>
          <label class="block text-sm mb-1" for="lastName_form">Last</label>
          <input
            id="lastName_form"
            name="lastName"
            type="text"
            class="w-full rounded bg-white/5 border border-white/15 p-2"
          />
        </div>
        <div>
          <label class="block text-sm mb-1" for="email_form">Email</label>
          <input
            id="email_form"
            name="email"
            type="email"
            required
            class="w-full rounded bg-white/5 border border-white/15 p-2"
          />
        </div>
        <div>
          <label class="block text-sm mb-1" for="phone_form">Phone</label>
          <input
            id="phone_form"
            name="phone"
            type="tel"
            class="w-full rounded bg-white/5 border border-white/15 p-2"
          />
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm mb-1" for="shipping_form">Shipping Address</label>
          <input
            id="shipping_form"
            name="shippingAddress"
            type="text"
            class="w-full rounded bg-white/5 border border-white/15 p-2"
          />
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm mb-1" for="billing_form">Billing Address</label>
          <input
            id="billing_form"
            name="billingAddress"
            type="text"
            class="w-full rounded bg-white/5 border border-white/15 p-2"
          />
        </div>
      </div>

      <fieldset class="mt-2">
        <legend class="text-sm mb-2">Preferences</legend>
        <label class="flex items-center gap-2 mb-1"
          ><input type="checkbox" name="emailOptIn" value="yes" /> Email updates</label
        >
        <label class="flex items-center gap-2 mb-1"
          ><input type="checkbox" name="textOptIn" value="yes" /> Text updates</label
        >
        <label class="flex items-center gap-2"
          ><input type="checkbox" name="marketingOptIn" value="yes" /> Marketing emails</label
        >
      </fieldset>

      <button
        type="submit"
        class="rounded bg-primary px-4 py-2 text-white hover:bg-primary/90 hover:text-white"
        >Submit Request</button
      >
      <p id="profile-form-status" class="hidden text-sm mt-3"></p>
    </form>
  </section>

  <script is:inline>
    const profileForm = document.getElementById('profile-form');
    const profileStatus = document.getElementById('profile-form-status');
    const setProfileStatus = (message, type = 'info') => {
      if (!profileStatus) return;
      profileStatus.textContent = message;
      profileStatus.classList.remove('hidden', 'text-red-300', 'text-green-300', 'text-white/80');
      const cls =
        type === 'error' ? 'text-red-300' : type === 'success' ? 'text-green-300' : 'text-white/80';
      profileStatus.classList.add(cls);
    };
    profileForm?.addEventListener('submit', async (event) => {
      event.preventDefault();
      if (!profileForm) return;
      setProfileStatus('Sending...', 'info');
      const submitBtn = profileForm.querySelector('button[type="submit"]');
      if (submitBtn) submitBtn.setAttribute('disabled', 'true');
      try {
        const formData = new FormData(profileForm);
        const fields = {};
        formData.forEach((value, key) => {
          if (typeof value === 'string') fields[key] = value;
        });
        profileForm.querySelectorAll('input[type="checkbox"]').forEach((input) => {
          if (!(input instanceof HTMLInputElement) || !input.name) return;
          fields[input.name] = input.checked ? 'yes' : 'no';
        });
        const response = await fetch('/api/form-submission', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ formName: 'Customer Profile Update', fields })
        });
        if (!response.ok) throw new Error('Request failed');
        const data = await response.json().catch(() => ({}));
        if (data?.ok === false) throw new Error(data?.message || 'Error');
        const redirect =
          profileForm.getAttribute('data-success') || '/customerdashboard/profile/success';
        window.location.href = redirect;
      } catch (err) {
        console.error(err);
        setProfileStatus('We could not submit your request. Please try again later.', 'error');
        if (submitBtn) submitBtn.removeAttribute('disabled');
      }
    });
  </script>
</BaseLayout>
