---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { fetchAppointments } from '../../lib/calcom';
// Define Appointment type locally if not exported from calcom
type Appointment = {
  startTime: string;
  status: string;
  eventType?: { title?: string };
  cancelUrl?: string;
  rescheduleUrl?: string;
  customer?: { name?: string; email?: string };
};

const appointments = await fetchAppointments();
const now = new Date();
const upcomingAppointments = appointments.filter((a: Appointment) => new Date(a.startTime) > now);
const pastAppointments = appointments.filter((a: Appointment) => new Date(a.startTime) <= now);
---

<BaseLayout>
  <section class="px-6 md:px-12 py-16 bg-black text-white font-cyber">
    <div class="max-w-5xl mx-auto">
      <h1 class="text-4xl font-bold mb-6 text-center">Your Appointment History</h1>

      <div class="mb-8">
        <h2 class="text-2xl mb-4">Upcoming Appointments</h2>
        {upcomingAppointments.length > 0 ? (
          <ul class="space-y-6">
            {upcomingAppointments.map((appt: Appointment) => (
              <li class="border border-white rounded-lg p-4 shadow-md bg-[#111]">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
                  <div>
                    <h2 class="text-xl font-semibold">{appt.eventType?.title || 'FAS Appointment'}</h2>
                    <p class="text-sm text-white/70">
                      {new Date(appt.startTime).toLocaleString()}
                    </p>
                    <p class="text-sm">Status: <span class="uppercase">{appt.status}</span></p>
                  </div>
                  <div class="mt-4 md:mt-0 space-x-2">
                    <a href={appt.cancelUrl} target="_blank" rel="noopener noreferrer" class="inline-block px-4 py-2 text-sm border border-red-500 text-red-500 hover:bg-red-500 hover:text-white transition rounded">Cancel</a>
                    <a href={appt.rescheduleUrl} target="_blank" rel="noopener noreferrer" class="inline-block px-4 py-2 text-sm border border-yellow-400 text-yellow-300 hover:bg-yellow-500 hover:text-gray-900 transition rounded">Reschedule</a>
                  </div>
                </div>
              </li>
            ))}
          </ul>
        ) : (
          <p class="text-white/70">No upcoming appointments.</p>
        )}
      </div>

      <div>
        <h2 class="text-2xl mb-4">Past Appointments</h2>
        {pastAppointments.length > 0 ? (
          <ul class="space-y-6">
            {pastAppointments.map((appt: Appointment) => (
              <li class="border border-white rounded-lg p-4 shadow-md bg-[#111]">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
                  <div>
                    <h2 class="text-xl font-semibold">{appt.eventType?.title || 'FAS Appointment'}</h2>
                    <p class="text-sm text-white/70">
                      {new Date(appt.startTime).toLocaleString()}
                    </p>
                    <p class="text-sm">Status: <span class="uppercase">{appt.status}</span></p>
                  </div>
                  <div class="mt-4 md:mt-0">
                    <span class="inline-block px-3 py-1 text-sm border border-white rounded">
                      {appt.customer?.name || appt.customer?.email}
                    </span>
                  </div>
                </div>
              </li>
            ))}
          </ul>
        ) : (
          <p class="text-white/70">No past appointments found.</p>
        )}
      </div>
    </div>
  </section>
</BaseLayout>
