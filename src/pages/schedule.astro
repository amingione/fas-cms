---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getGitPageDoc, sbFieldPath } from '@lib/stackbit';
const pageDoc: any = await getGitPageDoc('schedule');
import BookingForm from '../components/BookingForm';
import AppointmentCard from '../components/appointmentCard.astro';

const response = await fetch('https://api.cal.com/v1/bookings', {
  headers: {
    Authorization: `Bearer ${import.meta.env.PUBLIC_CALCOM_API_KEY}`,
  },
});

const data = await response.json();
const slots = data?.bookings || [];
---

<BaseLayout>
  <div aria-hidden=\"true\" class=\"hidden\" {...sbFieldPath('title')}>{pageDoc?.title ?? 'Schedule'}</div>
  <section class="px-6 py-24 max-w-6xl mx-auto text-center">
    <h1 class="text-4xl font-cyber text-accent mb-4" {...sbFieldPath('title')}>
      {pageDoc?.title ?? 'Schedule Your Install'}
    </h1>
    <p class="text-lg font-captain tracking-[1.2px] text-[#1d92ea] mb-12">
      Select a time that works for you — we’ll handle the rest. This is the first step toward securing your build.
    </p>

    <div class="max-w-3xl mx-auto">
      <BookingForm />
    </div>

    <div class="max-w-4xl mx-auto mt-12 text-left">
      <h2 class="text-2xl font-bold mb-4 font-captain">Upcoming Booking Options</h2>
      {
        slots.length > 0 ? (
          slots.map((slot) => (
            <AppointmentCard
              title={slot.title || 'Service Appointment'}
              date={slot.startTime}
              status={slot.status || 'confirmed'}
              customer={slot.attendees?.[0]?.name || 'Unknown'}
              rescheduleUrl={slot.rescheduleUrl}
              cancelUrl={slot.cancelUrl}
            />
          ))
        ) : (
          <p class="text-white">No available appointments at the moment.</p>
        )
      }
    </div>
  </section>
</BaseLayout>
