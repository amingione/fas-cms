---
import AccountDashboard from '@/components/accountdashboard.astro';
import MobileMenu from '@/components/navbar/mobile-menu';
import CartEntry from '@/components/cart/CartEntry.tsx';
import CartButton from '@/components/cart/cart-button.tsx';
import { SearchBar } from '@/components/SearchBar.tsx';
import MotionHeader from '@/components/header/MotionHeader.tsx';
import HeaderAuth from '@/components/HeaderAuth.tsx';
---

<MotionHeader client:load className="text-white w-full fixed top-0 z-[50]">
  <CartEntry client:load />

  <!-- Top Bar (Desktop/Tablet) -->
  <div id="topBar" class="hidden md:block pt-2 transform transition-transform duration-300 will-change-transform">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex items-center justify-between h-8">
      <div class="flex items-center gap-4">

      </div>
      <div class="flex items-center gap-2">
        <span id="account-top-badge" class="text-sm text-white/80"></span>
      </div>
    </div>
  </div>
  <HeaderAuth client:load />

  <!-- Mobile Header -->
  <div id="mheader" class="md:hidden shadow-md flex items-center justify-between px-4 h-14">
    <button
      id="mnavToggle"
      aria-label="Toggle menu"
      aria-expanded="false"
      aria-controls="mnavDrawer"
      class="p-2 rounded-lg hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-accent"
    >
      <svg id="mnavIcon" class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path id="mline1" stroke-linecap="round" stroke-linejoin="round" d="M4 7h16" />
        <path id="mline2" stroke-linecap="round" stroke-linejoin="round" d="M4 12h16" />
        <path id="mline3" stroke-linecap="round" stroke-linejoin="round" d="M4 17h16" />
      </svg>
    </button>
    <a href="/" class="block">
      <img src="/logo/faslogochroma.png" alt="FAS Chrome Logo" class="h-8 w-auto object-contain transition-all duration-300" />
    </a>
    <div class="flex items-center gap-3">
      <CartButton client:load />
    </div>
  </div>

  <!-- Mobile Drawer + Scrim -->
  <div id="mnavScrim" aria-hidden="true" class="md:hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[59] hidden opacity-0 transition-opacity duration-300 pointer-events-none"></div>
  <aside
    id="mnavDrawer"
    class="md:hidden fixed top-0 left-0 h-full w-4/5 max-w-[360px] bg-black/95 border-r border-gray-700 z-[60] overflow-y-auto -translate-x-full transition-transform duration-300 ease-out"
  >
    <div class="pt-12 pb-8 px-4">
      <MobileMenu mode="inline" client:load />
      <button id="closeMobileDrawer" class="text-accent hover:text-white text-xl font-bold absolute top-4 right-4">×</button>
    </div>
  </aside>

  <!-- Desktop Header -->
  <div id="dheader" class="hidden rounded-full liquid-skin liquid-skin-mobile-off md:block">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 grid grid-cols-1 md:grid-cols-3 items-center h-16">
      <div class="flex items-center gap-4">
        <button
          id="desktopCategoryToggle"
          aria-label="Toggle Categories"
          class="p-2 rounded-lg hover:text-primary focus:outline-none focus:ring-2 focus:ring-accent"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
        </button>
      </div>
      <div class="flex justify-center">
        <a href="/">
          <img src="/logo/faslogochroma.png" alt="FAS Chrome Logo" class="h-12 w-auto object-contain transition-all duration-300" />
        </a>
      </div>
      <div class="flex justify-end items-center gap-4">
        <nav class="hidden md:flex items-center gap-3 text-sm font-ethno">
          <a href="/" class="hover:text-accent transition-colors duration-300">Home</a>
          <span class="text-gray-500">|</span>
          <a href="/shop/categories" class="hover:text-accent transition-colors duration-300">Shop ➤</a>
        </nav>
        <CartButton client:load />
      </div>
    </div>

  </div>

  <!-- Desktop Drawer + Scrim -->
  <div id="desktopScrim" aria-hidden="true" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[850] opacity-0 transition-opacity duration-300 pointer-events-none"></div>
  <aside
    id="desktopDrawerLeft"
    aria-hidden="true"
    class="hidden md:block invisible fixed top-0 left-0 h-full w-[330px] border-r bg-black/90 border-gray-700 z-[900] overflow-y-auto -translate-x-full transition-transform duration-300 ease-out"
  >
    <div class="pt-16 pb-8 px-6">
      <button id="closeDesktopDrawerLeft" class="text-accent hover:text-white text-xl font-bold absolute top-4 right-4">×</button>
      <MobileMenu mode="inline" client:load />
    </div>
  </aside>

  <!-- Account Dashboard Drawer (right side) -->
  <aside
    id="accountDashboardPanel"
    class="hidden fixed top-0 right-0 h-full w-[360px] bg-black/85 backdrop-blur-md border-l border-white/10 z-[900] overflow-y-auto translate-x-full transition-transform duration-300 ease-out"
  >
    <div class="pt-12 pb-8 px-6">
      <h2 class="text-xl font-bold text-white">Account</h2>
      <button id="closeAccountDashboard" class="absolute top-4 right-4 text-accent hover:text-white text-xl font-bold">×</button>
      <AccountDashboard />
    </div>
  </aside>
</MotionHeader>

<script is:inline>
  document.addEventListener("DOMContentLoaded", function () {
    // Mobile Nav Drawer
    const mnavToggle = document.getElementById("mnavToggle");
    const mnavDrawer = document.getElementById("mnavDrawer");
    const mnavScrim = document.getElementById("mnavScrim");
    const mline1 = document.getElementById("mline1");
    const mline2 = document.getElementById("mline2");
    const mline3 = document.getElementById("mline3");
    const closeMobileDrawer = document.getElementById("closeMobileDrawer");
    let mnavOpen = false;

    function openMnav() {
      mnavDrawer.classList.remove("-translate-x-full");
      mnavScrim.classList.remove("hidden", "pointer-events-none", "opacity-0");
      mnavScrim.setAttribute("aria-hidden", "false");
      mline1.setAttribute("d", "M6 6l12 12");
      mline2.setAttribute("d", "");
      mline3.setAttribute("d", "M6 18l12 -12");
      mnavToggle.setAttribute("aria-expanded", "true");
      document.body.style.overflow = "hidden";
      mnavOpen = true;
    }

    function closeMnav() {
      mnavDrawer.classList.add("-translate-x-full");
      mnavScrim.classList.add("opacity-0", "pointer-events-none");
      mnavScrim.setAttribute("aria-hidden", "true");
      setTimeout(() => mnavScrim.classList.add("hidden"), 300);
      mline1.setAttribute("d", "M4 7h16");
      mline2.setAttribute("d", "M4 12h16");
      mline3.setAttribute("d", "M4 17h16");
      mnavToggle.setAttribute("aria-expanded", "false");
      document.body.style.overflow = "";
      mnavOpen = false;
    }

    mnavToggle?.addEventListener("click", () => (mnavOpen ? closeMnav() : openMnav()));
    mnavScrim?.addEventListener("click", closeMnav);
    closeMobileDrawer?.addEventListener("click", closeMnav);
    document.addEventListener("keydown", (e) => e.key === "Escape" && mnavOpen && closeMnav());

    // Desktop Nav Drawer
    const desktopCategoryToggle = document.getElementById("desktopCategoryToggle");
    const desktopDrawerLeft = document.getElementById("desktopDrawerLeft");
    const closeDesktopDrawerLeft = document.getElementById("closeDesktopDrawerLeft");
    const desktopScrim = document.getElementById("desktopScrim");
    let isDesktopLeftOpen = false;

    function openDesktopLeft() {
      desktopDrawerLeft.classList.remove("hidden", "-translate-x-full", "invisible");
      desktopDrawerLeft.setAttribute('aria-hidden', 'false');
      desktopScrim.classList.remove("hidden", "pointer-events-none", "opacity-0");
      document.body.style.overflow = "hidden";
      isDesktopLeftOpen = true;
    }

    function closeDesktopLeft() {
      desktopDrawerLeft.classList.add("-translate-x-full");
      desktopScrim.classList.add("opacity-0", "pointer-events-none");
      setTimeout(() => {
        desktopScrim.classList.add("hidden");
        desktopDrawerLeft.classList.add("invisible");
        desktopDrawerLeft.setAttribute('aria-hidden', 'true');
      }, 300);
      document.body.style.overflow = "";
      isDesktopLeftOpen = false;
    }

    desktopCategoryToggle?.addEventListener("click", () => (isDesktopLeftOpen ? closeDesktopLeft() : openDesktopLeft()));
    closeDesktopDrawerLeft?.addEventListener("click", closeDesktopLeft);
    desktopScrim?.addEventListener("click", closeDesktopLeft);

    // Account Dashboard
    const accountDashboardToggle = document.getElementById("accountDashboardToggle");
    const accountDashboardToggleTop = document.getElementById("accountDashboardToggleTop");
    const accountDashboardPanel = document.getElementById("accountDashboardPanel");
    const closeAccountDashboard = document.getElementById("closeAccountDashboard");
    let isDashboardOpen = false;

    function openDashboard() {
      // make visible, then slide in
      accountDashboardPanel.classList.remove('hidden');
      requestAnimationFrame(() => {
        accountDashboardPanel.classList.remove('translate-x-full');
      });
      desktopScrim.classList.remove('hidden', 'pointer-events-none', 'opacity-0');
      // Hide scrollbars
      document.documentElement.style.overflow = 'hidden';
      document.body.style.overflow = 'hidden';
      isDashboardOpen = true;
    }

    function closeDashboard() {
      // slide out, then hide
      accountDashboardPanel.classList.add('translate-x-full');
      desktopScrim.classList.add('opacity-0', 'pointer-events-none');
      setTimeout(() => {
        desktopScrim.classList.add('hidden');
        accountDashboardPanel.classList.add('hidden');
      }, 300);
      document.documentElement.style.overflow = '';
      document.body.style.overflow = '';
      isDashboardOpen = false;
    }

    accountDashboardToggle?.addEventListener("click", async () => {
      try {
        if (window.fasAuth) {
          const authed = await window.fasAuth.isAuthenticated();
          if (!authed) return window.fasAuth.loginTo('/dashboard');
          // already signed in → go to dashboard
          return (window.location.href = '/dashboard');
        }
      } catch {}
      // fallback: go to account page (will handle login)
      window.location.href = '/account';
    });
    accountDashboardToggleTop?.addEventListener("click", async () => {
      try {
        if (window.fasAuth) {
          const authed = await window.fasAuth.isAuthenticated();
          if (!authed) return window.fasAuth.loginTo('/dashboard');
          // already signed in → go to dashboard
          return (window.location.href = '/dashboard');
        }
      } catch {}
      // fallback: go to account page (will handle login)
      window.location.href = '/account';
    });
    closeAccountDashboard?.addEventListener("click", closeDashboard);
    desktopScrim?.addEventListener("click", closeDashboard);
    document.addEventListener("keydown", (e) => e.key === "Escape" && (closeMnav(), closeDesktopLeft(), closeDashboard()));

    // Sticky Header Scroll Effect
    const mheader = document.getElementById("mheader");
    const dheader = document.getElementById("dheader");
    const shrinkThreshold = 120;
    const topBar = document.getElementById('topBar');
    let lastY = window.scrollY;

    // Ensure desktop header never shrinks
    if (dheader) dheader.classList.remove('d-shrink');

    function handleScroll() {
      const scrollY = window.scrollY;
      // Shrink logos
      if (mheader) {
        mheader.classList.toggle("m-shrink", scrollY > shrinkThreshold);
      }
      // Desktop header: keep full size on scroll
      if (dheader) dheader.classList.remove('d-shrink');
      // Auto-hide top bar on scroll down, reveal on scroll up
      if (topBar) {
        if (scrollY > 10 && scrollY > lastY + 2) {
          topBar.classList.add('-translate-y-full');
        } else if (scrollY < lastY - 2 || scrollY < 10) {
          topBar.classList.remove('-translate-y-full');
        }
      }
      lastY = scrollY;
    }

    window.addEventListener("scroll", handleScroll, { passive: true });
  });
</script>

<style>
  .m-shrink {
    @apply h-12;
  }
  .m-shrink img {
    @apply h-6;
  }
  .d-shrink {
    @apply h-12;
  }
  .d-shrink img {
    @apply h-8;
  }
  img {
    @apply max-w-full object-contain;
  }
  button, a {
    @apply transition-colors duration-300;
  }
</style>
