---
/**
 * ProductCardLite.astro — demo-store tile (badge chips, centered product)
 */

import Label from '@/components/storefront/label.tsx';
import ProductQuickViewButton from '@/components/storefront/ProductQuickViewButton.tsx';
import { portableTextToPlainText } from '@/lib/portableText.ts';
import { normalizeSlugValue, resolveSanityImageUrl } from '@/lib/sanity-utils.ts';
import { getQuickViewOptionGroups } from '@/lib/quick-view-options.ts';
import {
  formatPrice,
  getActivePrice,
  getCompareAtPrice,
  getSaleBadgeText,
  isOnSale
} from '@/lib/saleHelpers';

interface ImgAsset { url?: string }
interface Img { asset?: ImgAsset; alt?: string }
interface Slug { current?: string }
const { product, productImage, layout = 'grid', showQuickView = true } = Astro.props as {
  product: {
    _id: string
    title?: string
    slug?: Slug | string
    price?: number
    images?: Img[]
    shortDescription?: string
    description?: string
  }
  productImage?: Img
  layout?: 'grid' | 'list'
  showQuickView?: boolean
}

const slug = normalizeSlugValue((product as any)?.slug);
const href = slug ? `/shop/${encodeURIComponent(slug)}` : '#'
const fallbackImage = '/logo/faslogochroma.webp'
const img = resolveSanityImageUrl([productImage, product?.images]) ?? fallbackImage
const baseTitle = product?.title || 'Untitled Product'
const anchorText =
  typeof (product as any)?.seoAnchorText === 'string' && (product as any).seoAnchorText.trim().length > 0
    ? (product as any).seoAnchorText.trim()
    : baseTitle
const short =
  portableTextToPlainText((product as any)?.shortDescription) ||
  portableTextToPlainText((product as any)?.description) ||
  (product as any)?.excerpt ||
  '';
const shortText = typeof short === 'string' ? short : ''
const quickViewOptions = getQuickViewOptionGroups(product)
const activePrice = getActivePrice(product)
const comparePrice = getCompareAtPrice(product)
const onSale = isOnSale(product)
const saleBadge = getSaleBadgeText(product)
const price = typeof activePrice === 'number' ? activePrice : undefined
const analyticsParams = JSON.stringify(
  Object.fromEntries(
    Object.entries({
      product_id: typeof product?._id === 'string' ? product._id : undefined,
      product_name: baseTitle,
      product_slug: slug || undefined,
      price,
      tile_layout: layout
    }).filter(([, value]) => value !== undefined && value !== null && value !== '')
  )
)
---
{layout === 'list' ? (
  <article class="group relative">
    <a
      href={href}
      class="group block rounded-sm border border-[121212/40] bg-black transition-shadow duration-300 hover:shadow-xl focus:outline-none focus:ring-2 focus:ring-primary md:flex md:items-stretch"
      data-analytics-event="product_tile_click"
      data-analytics-category="ecommerce"
      data-analytics-label={anchorText}
      data-analytics-params={analyticsParams}
    >
      {saleBadge && (
        <span class="absolute left-3 top-3 z-10 rounded-full border border-red-500/60 bg-red-500/10 px-2 py-0.5 text-[11px] font-semibold uppercase tracking-wide text-red-200">
          {saleBadge}
        </span>
      )}
      <div class="relative bg-black/30 backdrop-blur-sm md:w-56 md:min-w-56 md:max-w-56 aspect-square md:aspect-auto flex items-center justify-center">
        <img src={img} alt={anchorText}
             class="max-h-[80%] max-w-[88%] object-contain transition-transform duration-300 ease-out group-hover:scale-[1.03]" />
      </div>
      <div class="flex-1 px-4 py-4 text-left">
        <div class="text-white font-ethno text-[1rem] leading-snug line-clamp-2">{anchorText}</div>
        {shortText && (
          <div class="mt-2 text-white/70 text-sm leading-relaxed line-clamp-2">{shortText}</div>
        )}
        <div class="mt-3 text-accent font-mono text-[1.15rem]">
          {price !== undefined ? (
            onSale ? (
              <>
                <span class="text-red-400">{formatPrice(price)}</span>
                {comparePrice && (
                  <span class="ml-2 text-white/60 line-through">{formatPrice(comparePrice)}</span>
                )}
              </>
            ) : (
              <span>{formatPrice(price)}</span>
            )
          ) : (
            '—'
          )}
        </div>
      </div>
    </a>
    {showQuickView && (
      <div class="pointer-events-none absolute right-4 top-4 z-10 opacity-0 transition-opacity duration-200 group-hover:opacity-100 group-focus-within:opacity-100">
        <ProductQuickViewButton
          client:idle
          className="pointer-events-auto"
            product={{
              id: typeof product?._id === 'string' ? product._id : undefined,
              title: baseTitle,
              href,
              price,
              imageSrc: img,
              imageAlt: anchorText,
              description: shortText,
              shortDescriptionPortable: (product as any)?.shortDescription,
              optionGroups: quickViewOptions
            }}
          />
        </div>
    )}
  </article>
) : (
  <article class="group relative">
    <a
      href={href}
      class="block relative overflow-hidden rounded-md border border-white/5 shadow-inner shadow-white/20 bg-black transition-shadow duration-300 hover:shadow-xl focus:outline-none focus:ring-2 focus:ring-primaryB"
      data-analytics-event="product_tile_click"
      data-analytics-category="ecommerce"
      data-analytics-label={anchorText}
      data-analytics-params={analyticsParams}
    >
      {saleBadge && (
        <span class="absolute left-3 top-3 z-10 rounded-full border border-red-500/60 bg-red-500/10 px-2 py-0.5 text-[11px] font-semibold uppercase tracking-wide text-red-200">
          {saleBadge}
        </span>
      )}
      <div class="relative aspect-square object-contain contain flex pb-10 justify-center bg-black/30 backdrop-blur-sm">
        <img src={img} alt={anchorText}
             class="max-h-[78%] max-w-[88%] object-contain transition-transform duration-300 ease-out group-hover:scale-[1.03]" />
      </div>
      <div class="absolute bottom-4 flex w-full items-center gap-1">
          <Label title={anchorText} amount={price ?? 0} originalAmount={comparePrice ?? undefined} onSale={onSale} position="bottom" />
      </div>
    </a>
    {showQuickView && (
      <div class="pointer-events-none absolute right-3 top-3 z-10 opacity-0 transition-opacity duration-200 group-hover:opacity-100 group-focus-within:opacity-100">
        <ProductQuickViewButton
          client:idle
          className="pointer-events-auto"
          product={{
            id: typeof product?._id === 'string' ? product._id : undefined,
            title: baseTitle,
            href,
            price,
            imageSrc: img,
            imageAlt: anchorText,
            description: shortText,
            shortDescriptionPortable: (product as any)?.shortDescription,
            optionGroups: quickViewOptions
          }}
        />
      </div>
    )}
  </article>
)}
