---
/**
 * ProductCardLite.astro — demo-store tile (badge chips, centered product)
 */

import Label from '@/components/storefront/label.tsx';
import ProductQuickViewButton from '@/components/storefront/ProductQuickViewButton.tsx';
import { portableTextToPlainText } from '@/lib/portableText';

interface ImgAsset { url?: string }
interface Img { asset?: ImgAsset; alt?: string }
interface Slug { current?: string }
const { product, productImage, layout = 'grid' } = Astro.props as {
  product: {
    _id: string
    title?: string
    slug?: Slug | string
    price?: number
    images?: Img[]
    shortDescription?: string
    description?: string
  }
  productImage?: Img
  layout?: 'grid' | 'list'
}

const slug = typeof product?.slug === 'string' ? product.slug : (product?.slug?.current || '')
const href = slug ? `/shop/${encodeURIComponent(slug)}` : '#'
const img = productImage?.asset?.url || product?.images?.[0]?.asset?.url || '/logo/faslogochroma.png'
const title = product?.title || 'Untitled Product'
const short =
  portableTextToPlainText((product as any)?.shortDescription) ||
  portableTextToPlainText((product as any)?.description) ||
  (product as any)?.excerpt ||
  '';
const shortText = typeof short === 'string' ? short : ''
const price = typeof product?.price === 'number' ? product.price : undefined
---
{layout === 'list' ? (
  <article class="group relative">
    <a href={href}
       class="group block rounded-sm border border-[121212/40] bg-black transition-shadow duration-300 hover:shadow-xl focus:outline-none focus:ring-2 focus:ring-primary md:flex md:items-stretch">
      <div class="relative bg-black/30 backdrop-blur-sm md:w-56 md:min-w-56 md:max-w-56 aspect-square md:aspect-auto flex items-center justify-center">
        <img src={img} alt={title}
             class="max-h-[80%] max-w-[88%] object-contain transition-transform duration-300 ease-out group-hover:scale-[1.03]" />
      </div>
      <div class="flex-1 px-4 py-4 text-left">
        <div class="text-white font-ethno text-[1rem] leading-snug line-clamp-2">{title}</div>
        {shortText && (
          <div class="mt-2 text-white/70 text-sm leading-relaxed line-clamp-2">{shortText}</div>
        )}
        <div class="mt-3 text-accent font-mono text-[1.15rem]">
          {price !== undefined
            ? `$${price.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`
            : '—'}
        </div>
      </div>
    </a>
    <div class="pointer-events-none absolute right-4 top-4 z-10 opacity-0 transition-opacity duration-200 group-hover:opacity-100 group-focus-within:opacity-100">
      <ProductQuickViewButton
        client:idle
        className="pointer-events-auto"
        product={{
          title,
          href,
          price,
          imageSrc: img,
          imageAlt: title,
          description: shortText
        }}
      />
    </div>
  </article>
) : (
  <article class="group relative">
    <a href={href}
       class="block relative overflow-hidden rounded-md border border-white/5 shadow-inner shadow-white/20 bg-black transition-shadow duration-300 hover:shadow-xl focus:outline-none focus:ring-2 focus:ring-primaryB">
      <div class="relative aspect-square object-contain contain flex pb-10 justify-center bg-black/30 backdrop-blur-sm">
        <img src={img} alt={title}
             class="max-h-[78%] max-w-[88%] object-contain transition-transform duration-300 ease-out group-hover:scale-[1.03]" />
      </div>
      <div class="absolute bottom-4 flex w-full items-center gap-1">
        <Label title={title} amount={price ?? 0} position="bottom" />
      </div>
    </a>
    <div class="pointer-events-none absolute right-3 top-3 z-10 opacity-0 transition-opacity duration-200 group-hover:opacity-100 group-focus-within:opacity-100">
      <ProductQuickViewButton
        client:idle
        className="pointer-events-auto"
        product={{
          title,
          href,
          price,
          imageSrc: img,
          imageAlt: title,
          description: shortText
        }}
      />
    </div>
  </article>
)}
