---
const { productImage, product } = Astro.props;
const productPrice =
  typeof product.price === "number"
    ? `$${parseFloat(product.price).toFixed(2)}`
    : "—";
---
<div class="relative z-0 text-white bg-black/10 rounded-[10px] shadow-[inset_0_0_10px_rgba(0,0,0,0.5)] hover:shadow-[0_8px_20px_rgba(0,0,0,0.5)] overflow-hidden transform transition-all duration-500 group font-sans">
  <div class="p-4 h-52 sm:h-64 flex justify-center items-center overflow-hidden">
    <img
      src={
        typeof productImage === 'string'
          ? productImage
          : productImage?.asset?.url
          ? productImage.asset.url
          : productImage?.asset?._ref
          ? `https://cdn.sanity.io/images/${import.meta.env.SANITY_STUDIO_PROJECT_ID}/${import.meta.env.SANITY_STUDIO_DATASET}/${productImage.asset._ref
              .replace('image-', '')
              .replace('-webp', '.webp')
              .replace('-jpg', '.jpg')
              .replace('-png', '.png')}`
          : '/placeholder.png'
      }
      alt={product.title}
      class="w-full h-full object-contain transition-transform duration-300 ease-in-out group-hover:scale-105 group-hover:-rotate-1"
    />
  </div>
  <div class="p-4 space-y-2 text-center">
    <div class="mt-4 px-4 text-left">
      <h2 class="text-sm sm:text-sm font-ethno font-semibold text-white">{product.title}</h2>
      <p class="text-xl font-captain text-primary mt-1">{productPrice}</p>
    </div>
  </div>
  {product.slug && (
    <a
      href={`/shop/${encodeURIComponent(typeof product.slug === 'string' ? product.slug : product.slug.current || '')}`}
      class="absolute bottom-0 right-0 mb-2 transform translate-x-full opacity-0 group-hover:translate-x-0 group-hover:opacity-100 transition-all duration-500 ease-in-out text-white text-base font-bold font-captain tracking-wider border-l-4 border-primary bg-black/40 px-5 py-2 uppercase shadow-md z-20"    >
      See Details
    </a>
  )}
  {product._id && (
    <button
      class="add-to-cart absolute top-0 left-0 m-2 px-4 py-1 bg-primary text-black font-bold rounded text-xs sm:text-sm"
      data-product-id={product._id}
    >
      Add to Cart
    </button>
  )}
</div>
<div id="product-toast" class="fixed top-20 right-6 z-50 hidden px-4 py-3 backdrop-blur bg-white/10 text-white font-bold shadow-lg transition-all duration-300"></div>
<script>
  function showProductToast(message, success = true) {
    const toast = document.getElementById('product-toast');
    if (!toast) return;
    toast.textContent = message;
    toast.className = `fixed top-20 right-6 z-50 px-4 py-3 backdrop-blur font-bold shadow-lg transition-all duration-300 ${
      success ? 'bg-green-500/10 text-green-300' : 'bg-red-500/10 text-red-400'
    }`;
    toast.classList.remove('hidden', 'opacity-0');
    toast.classList.add('opacity-100');
    setTimeout(() => {
      toast.classList.remove('opacity-100');
      toast.classList.add('opacity-0');
      setTimeout(() => toast.classList.add('hidden'), 300);
    }, 2500);
  }

  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.add-to-cart').forEach((btn) => {
      btn.addEventListener('click', () => {
        const productId = btn.getAttribute('data-product-id');
        fetch('/api/cart', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            productId,
            quantity: 1,
            sessionId: localStorage.getItem('fas_session') || 'guest-session',
          }),
        })
          .then((res) => {
            if (res.ok) showProductToast('✅ Added to cart!', true);
            else showProductToast('❌ Failed to add to cart.', false);
          })
          .catch(() => showProductToast('❌ Error adding to cart.', false));
      });
    });
  });
</script>
