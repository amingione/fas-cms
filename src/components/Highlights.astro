---
import { coercePriceToNumber, optimizeSanityImageUrl } from '@/lib/sanity-utils.ts';

const { items = [] } = Astro.props as { items?: any[] };

const PRICE_PLACEHOLDER_PATTERN = /^\[price\]$/i;
const HIGHLIGHT_FALLBACK_IMAGE = '/logo/faslogochroma.webp';
const HIGHLIGHT_IMAGE_WIDTHS = [200, 320, 360, 480, 640];
const HIGHLIGHT_IMAGE_BASE_WIDTH = 360;
const HIGHLIGHT_IMAGE_SIZES = '(min-width: 1024px) 220px, (min-width: 768px) 240px, 55vw';

const formatPriceDisplay = (value: unknown): string | null => {
  const numeric = coercePriceToNumber(value);
  if (typeof numeric === 'number') {
    return `$${numeric.toFixed(2)}`;
  }
  if (typeof value === 'string') {
    const trimmed = value.trim();
    if (!trimmed || PRICE_PLACEHOLDER_PATTERN.test(trimmed)) {
      return null;
    }
    return trimmed;
  }
  return null;
};

const normalizedItems = Array.isArray(items)
  ? items.map((item) => ({
      ...item,
      __priceDisplay: formatPriceDisplay((item as any)?.price)
    }))
  : [];

const getHighlightImageSources = (rawUrl: unknown): { src: string; srcset?: string } => {
  const normalized =
    typeof rawUrl === 'string' && rawUrl.trim() ? rawUrl.trim() : HIGHLIGHT_FALLBACK_IMAGE;

  const src =
    optimizeSanityImageUrl(normalized, {
      width: HIGHLIGHT_IMAGE_BASE_WIDTH,
      height: HIGHLIGHT_IMAGE_BASE_WIDTH,
      fit: 'max'
    }) ?? normalized;

  const srcsetEntries = HIGHLIGHT_IMAGE_WIDTHS.map((width) => {
    const optimized = optimizeSanityImageUrl(normalized, {
      width,
      height: width,
      fit: 'max'
    });
    return optimized ? `${optimized} ${width}w` : null;
  }).filter(Boolean);

  return {
    src,
    srcset: srcsetEntries.length > 0 ? srcsetEntries.join(', ') : undefined
  };
};
---

{
  Array.isArray(normalizedItems) && normalizedItems.length > 0 && (
    <section class="container mx-auto px-4  pt-5 mt-5 lg:px-6 mb-5" aria-roledescription="carousel">
      <h2 class="text-2xl md:text-3xl font-bold font-ethno text-white mb-4">Featured Products</h2>
      <div class="hl-viewport" tabindex="0" aria-label="Featured products">
        <div class="hl-track">
          {normalizedItems.map((p: any) => {
            const imageSources = getHighlightImageSources(p?.imageUrl);
            return (
              <a href={p?.slug ? `/shop/${p.slug}` : '#'} class="hl-item group">
                <div class="hl-img">
                  <img
                    src={imageSources.src}
                    srcset={imageSources.srcset}
                    sizes={HIGHLIGHT_IMAGE_SIZES}
                    width={HIGHLIGHT_IMAGE_BASE_WIDTH}
                    height={HIGHLIGHT_IMAGE_BASE_WIDTH}
                    alt={(p?.title || p?.name || 'Product').toString()}
                    loading="lazy"
                    class="h-full w-full object-cover transition-transform duration-300 group-hover:scale-105"
                  />
                </div>
                <div class="p-3">
                  <div class="text-white font-semibold truncate">
                    {(p?.title || p?.name || 'Untitled').toString()}
                  </div>
                  {p?.__priceDisplay && (
                    <div class="text-sm text-accent mt-1">{p.__priceDisplay}</div>
                  )}
                </div>
              </a>
            );
          })}
        </div>
      </div>
    </section>
  )
}

<style>
  .hl-viewport {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    overscroll-behavior-x: contain;
    scroll-snap-type: x mandatory;
  }
  .hl-viewport::-webkit-scrollbar {
    display: none;
  }
  .hl-track {
    display: flex;
    gap: 16px;
  }
  .hl-item {
    flex: 0 0 clamp(180px, 55vw, 240px);
    max-width: clamp(180px, 55vw, 240px);
    scroll-snap-align: start;
    scroll-snap-stop: always;
    overflow: hidden;
    border-radius: 0.5rem;
    border: 1px solid rgba(107, 107, 107, 0.374);
    background: rgb(17, 17, 17);
    box-shadow: inset 0 0 5px;
  }
  .hl-item:hover {
    border-color: rgba(234, 29, 39, 0.385);
  }
  .hl-img {
    aspect-ratio: 1 / 1;
    width: 100%;
    background: rgba(17, 17, 17, 0.3);
    overflow: hidden;
  }

  @media (min-width: 1024px) {
    .hl-item {
      flex-basis: clamp(200px, 18vw, 240px);
      max-width: clamp(200px, 18vw, 240px);
    }
  }
</style>
