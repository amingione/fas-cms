2.0 CODEX SCHEMA MATCH PROMPT


SYSTEM DIRECTIVE

Load and follow docs/codex.md as authoritative.
This is a READ-ONLY AUDIT. No code, schema, or behavior changes are permitted.

‚∏ª

TASK

Perform a repo-wide, deterministic audit of fas-cms-fresh with respect to its dependencies on fas-sanity schemas and data contracts.

Create the primary audit artifact:

docs/reports/codex-sanity-schema-audit-12-29.md


‚∏ª

AUDIT GOAL

Produce a complete, factual map of all files in fas-cms-fresh that:
	‚Ä¢	Fetch data from Sanity
	‚Ä¢	Assume Sanity schema fields exist
	‚Ä¢	Write or patch Sanity documents
	‚Ä¢	Depend on GROQ queries or schema shape
	‚Ä¢	Depend on Stripe, EasyPost, or Email/SMS data mirrored into Sanity

Identify:
	‚Ä¢	Schema assumptions
	‚Ä¢	Read/write paths
	‚Ä¢	Cross-repo dependencies
	‚Ä¢	Identity and ownership boundaries
	‚Ä¢	Potential null or undefined data paths

This audit must be decision-ready for Gemini and Claude.
Do not propose solutions.

‚∏ª

STRICT NON-NEGOTIABLE RULES
	‚Ä¢	‚ùå Do NOT modify code
	‚Ä¢	‚ùå Do NOT modify schemas
	‚Ä¢	‚ùå Do NOT refactor
	‚Ä¢	‚ùå Do NOT suggest fixes
	‚Ä¢	‚ùå Do NOT invent abstractions
	‚Ä¢	‚ùå Do NOT normalize data

You may only observe, map, quote, and report.

If ambiguity is detected, report it and STOP.

‚∏ª

REQUIRED AUDIT DOMAINS

1) Identity & Auth

Map and document:
	‚Ä¢	Customer identity source of truth
	‚Ä¢	Vendor ‚Üî customer linkage
	‚Ä¢	Email canonicalization rules
	‚Ä¢	Session ‚Üí document mapping
	‚Ä¢	Stripe customer identity location and usage

‚∏ª

2) Data Ownership

For each domain, identify only what exists:

Domain	Source of Truth	Read-Only Fields	Writable Fields	Direction of Updates


Domains:
	‚Ä¢	Customers
	‚Ä¢	Vendors
	‚Ä¢	Orders
	‚Ä¢	Invoices
	‚Ä¢	Quotes
	‚Ä¢	Discounts / Coupons
	‚Ä¢	Messages

‚∏ª

3) Cross-Repo Read Paths

For fas-cms-fresh, document:
	‚Ä¢	Where data is fetched from Sanity
	‚Ä¢	GROQ queries used
	‚Ä¢	Fields assumed to exist
	‚Ä¢	Any non-schema or implicit field reads

‚∏ª

4) Cross-Repo Write Paths

For fas-cms-fresh, document:
	‚Ä¢	Where data is written or patched to Sanity
	‚Ä¢	Fields created or updated
	‚Ä¢	Validation assumptions
	‚Ä¢	Possible null / undefined writes

‚∏ª

5) External Integrations

Audit only existing behavior:
	‚Ä¢	Stripe (customers, payments, coupons)
	‚Ä¢	EasyPost (shipments, labels)
	‚Ä¢	Email / SMS (Resend, Twilio)

For each:
	‚Ä¢	Where the integration is authoritative
	‚Ä¢	How data is mirrored into Sanity
	‚Ä¢	Where drift or duplication could occur

‚∏ª

6) Studio UX Contracts

Document:
	‚Ä¢	Document lists vs derived lists
	‚Ä¢	Embedded objects vs documents
	‚Ä¢	Create / Edit / Delete affordances
	‚Ä¢	Any UX that may misrepresent data authority

‚∏ª

REQUIRED OUTPUT FILES

Primary Output File (Phase 0):
- docs/reports/codex-sanity-schema-audit-12-29.md

Primary Output File (Phase 1):
- docs/reports/audit-summary.md

The Completion Contract MUST be appended only to the
Primary Output File of the active phase.

1) _repo-map.md
	‚Ä¢	High-level map of both repos
	‚Ä¢	Key schemas
	‚Ä¢	Key API routes
	‚Ä¢	Integration points

‚∏ª

2) cross-repo-data-flow.md

Table of entities with:
	‚Ä¢	Source of Truth
	‚Ä¢	Reads
	‚Ä¢	Writes
	‚Ä¢	Risks

‚∏ª

3) blocking-issues.md

Issues that could break:
	‚Ä¢	Authentication
	‚Ä¢	Billing
	‚Ä¢	Publishing
	‚Ä¢	Data integrity

‚∏ª

4) confusing-or-risky-patterns.md
	‚Ä¢	Duplicate concepts
	‚Ä¢	UX mismatches
	‚Ä¢	Embedded vs document confusion

‚∏ª

5) audit-summary.md
	‚Ä¢	Executive summary
	‚Ä¢	What is correct
	‚Ä¢	What is fragile
	‚Ä¢	What decisions are required next
(No solutions)

‚∏ª

OUTPUT FORMAT RULES
	‚Ä¢	Deterministic, factual language only
	‚Ä¢	No recommendations phrased as fixes
	‚Ä¢	No new terminology
	‚Ä¢	Quote code only if needed for clarity
	‚Ä¢	Every issue labeled:

üî¥ Blocking
üü° Risky
üü¢ Cosmetic

‚∏ª

SOFT STOP CONDITIONS
	‚Ä¢	If any schema ambiguity is detected:
	‚Ä¢	Document it
	‚Ä¢	STOP the audit
	‚Ä¢	Do not continue into enforcement or suggestion mode

‚∏ª

Phase 0 ‚Äî DISCOVERY (READ-ONLY, OBSERVATIONAL)

Purpose:
Establish a complete, factual inventory of files, schemas, and integration touchpoints without interpreting correctness.

Phase 0 Scope
	‚Ä¢	Enumerate all relevant files in fas-cms-fresh
	‚Ä¢	Enumerate all Sanity schemas referenced
	‚Ä¢	Enumerate GROQ queries and Sanity clients
	‚Ä¢	Enumerate Stripe / EasyPost / Email touchpoints
	‚Ä¢	Enumerate Studio structures and derived lists

Phase 0 Output Files

Write only:

docs/reports/_repo-map.md
docs/reports/codex-sanity-schema-audit-12-29.md

Phase 0 Restrictions
	‚Ä¢	‚ùå No risk classification
	‚Ä¢	‚ùå No judgments
	‚Ä¢	‚ùå No correctness statements
	‚Ä¢	‚ùå No ‚Äúthis may be wrong‚Äù language

Only:
	‚Ä¢	File paths
	‚Ä¢	Observed relationships
	‚Ä¢	Quoted usage
	‚Ä¢	Explicit assumptions made by code

Phase 0 STOP CONDITION

When discovery is complete:
	‚Ä¢	Write checksum block (see below)
	‚Ä¢	STOP
	‚Ä¢	Do NOT proceed to Phase 1 unless explicitly instructed

Phase 1 MUST NOT execute unless invoked by a new prompt
containing the exact phrase:

"BEGIN PHASE 1 ‚Äî CONTRACT & RISK ANALYSIS"

‚∏ª

PHASE 1 ‚Äî CONTRACT & RISK ANALYSIS (STILL READ-ONLY)

Phase 1 may ONLY begin when the prompt contains:

"BEGIN PHASE 1 ‚Äî CONTRACT & RISK ANALYSIS"

Purpose:
Classify only what Phase 0 revealed, without adding new findings.

Phase 1 Scope
	‚Ä¢	Identity & Auth contracts
	‚Ä¢	Data ownership boundaries
	‚Ä¢	Cross-repo read/write paths
	‚Ä¢	External integration authority
	‚Ä¢	Studio UX contract risks

Phase 1 Output Files

Write only:

docs/reports/cross-repo-data-flow.md
docs/reports/blocking-issues.md
docs/reports/confusing-or-risky-patterns.md
docs/reports/audit-summary.md

Phase 1 Restrictions
	‚Ä¢	‚ùå No fixes
	‚Ä¢	‚ùå No refactors
	‚Ä¢	‚ùå No enforcement language
	‚Ä¢	‚ùå No implied solutions

Only:
	‚Ä¢	Classification
	‚Ä¢	Risk labeling
	‚Ä¢	Contract mismatches
	‚Ä¢	Decision-blocking ambiguity

‚∏ª

CHECKSUM & COMPLETION CONTRACT (MANDATORY)

At the end of each phase, append the following section verbatim to the primary output file of that phase.

Completion Contract Block

---
AUDIT COMPLETION CONTRACT

Phase: <Phase 0 | Phase 1>

Repos Audited:
- fas-cms-fresh
- fas-sanity (schema surface only)

Files Touched (READ-ONLY):
- <explicit count>
- <explicit list or glob summary>

Schemas Observed:
- <explicit list>

API Routes Observed:
- <explicit list>

Integrations Observed:
- Stripe: <yes/no>
- EasyPost: <yes/no>
- Email/SMS: <yes/no>

Schema Ambiguity Detected:
- <yes/no>
If yes, list exact schema + field names.

Rules Compliance:
- Code Modified: NO
- Schemas Modified: NO
- Fixes Suggested: NO
- Enforcement Performed: NO

Checksum:
- Repo snapshot hash (best-effort): <hash or ‚Äúunavailable‚Äù>
- Timestamp (UTC): <ISO 8601>

Audit Status:
- COMPLETE
- STOPPED BY DESIGN
---

Checksum Rules
	‚Ä¢	Hash does not need to be cryptographically perfect
	‚Ä¢	It must be deterministic per run
	‚Ä¢	If unavailable, explicitly state "unavailable"
	‚Ä¢	Silent omission is not allowed

‚∏ª

MANDATORY TERMINATION CONDITIONS

Immediately STOP and mark audit INCOMPLETE if:
	‚Ä¢	A schema field is referenced but not found
	‚Ä¢	A GROQ query shape cannot be resolved
	‚Ä¢	Identity authority is ambiguous
	‚Ä¢	A document serves dual authority without contract clarity

These must be reported, not solved.

NON-EXECUTABLE CONTEXT ‚Äî The following section is for human readers only.
Codex must not quote, paraphrase, or include it in any output.

‚∏ª

Why this version is better (straight talk)
	‚Ä¢	Removes ambiguity that makes Codex ‚Äúhelpful‚Äù in the wrong way
	‚Ä¢	Forces schema-first thinking without enforcement
	‚Ä¢	Prevents drift into refactors or advice
	‚Ä¢	Produces artifacts Claude can make decisions from
	‚Ä¢	Keeps Gemini clean for reasoning, not discovery

If you want, next we can:
	‚Ä¢	Add a checksum / completion contract
	‚Ä¢	Or split this into Phase 0 (Discovery) / Phase 1 (Contracts Only) for even tighter governance

‚∏ª

ADDENDUM: GOVERNANCE ENFORCEMENT

PHASED EXECUTION MODEL (MANDATORY)

Codex must execute exactly one phase at a time.
No phase may bleed into another.

‚∏ª

PHASE 0 ‚Äî DISCOVERY (READ-ONLY, OBSERVATIONAL)

Purpose:
Establish a complete, factual inventory of files, schemas, and integration touchpoints without interpreting correctness.

Phase 0 Scope
	‚Ä¢	Enumerate all relevant files in fas-cms-fresh
	‚Ä¢	Enumerate all Sanity schemas referenced
	‚Ä¢	Enumerate GROQ queries and Sanity clients
	‚Ä¢	Enumerate Stripe / EasyPost / Email touchpoints
	‚Ä¢	Enumerate Studio structures and derived lists

Phase 0 Output Files

Write only:

docs/reports/_repo-map.md
docs/reports/codex-sanity-schema-audit-12-29.md

Phase 0 Restrictions
	‚Ä¢	‚ùå No risk classification
	‚Ä¢	‚ùå No judgments
	‚Ä¢	‚ùå No correctness statements
	‚Ä¢	‚ùå No ‚Äúthis may be wrong‚Äù language

Only:
	‚Ä¢	File paths
	‚Ä¢	Observed relationships
	‚Ä¢	Quoted usage
	‚Ä¢	Explicit assumptions made by code
